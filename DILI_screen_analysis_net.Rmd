---
title: "DILI screen paper"
author: "Steven Wink"
date: "1 december 2016"
output:
  html_document:
    toc: true
    toc_depth: 3

---


### Automated live cell imaging of adaptive stress responses for assessment of drug-induced liver injury (DILI) liabilities.  


```{r session_options}
#options(stringsAsFactors = FALSE)

```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Install the required packages to knit this file  
```{r install_required_packages, eval = FALSE, include = FALSE}

required.packages <- c('data.table', 'ggplot2', 'plyr', 'grid', 'splines', 'stats', 'graphics', 'reshape2', 'NMF', "stringr")
required.package.installed <- sapply(required.packages, require, character.only = TRUE)
if(!all(required.package.installed)) {
  
  install.packages(required.packages[!required.package.installed])
}
if(!require('knitr')) { install.packages('knitr') }
if(!require('rmarkdown')) { install.packages('rmarkdown') }

```

load required packages  
```{r load_packages}
update.packages(lib.loc=.libPaths()[1])
require(data.table)
require(ggplot2)
require(plyr)
require(grid)
require(splines)
require(stats)
require(graphics)
require(reshape2)
require(NMF)
require(stringr)

```

Script sourcing   
```{r script_sourcing}

source("theme_sharp.R")

```


## summary analysis preceding this data-analysis document  
All image analysis was performed using CellProfiler version 2.0.  
The in house created H5CellProfiler R package was used to extract, format and summarize the HDF5 file data generated by CellProfiler according to the following protocol;
* filter by nuclei area: 10 pixels for 1X zoom & 40 pixels for 2X zoom to remove segmented noise.
* determine `2X background value`, `3X background value` and `mean + 3X sd neg. control values` of main cell line specific measurement by `treatment`, `dose_uM: 0.2% (0.002)` of the DMSO control treatments  
* count cells above this threshold values and determine `GFP positive fraction` for the 3 background values.  
* calculate by `treatment`, `plateID`, `dose_uM`, `timeID`, `timeAfterExposure`, `control`, `cell_line`
of  `Nuclei_AreaShape_Area`, `imageCountTracked`, `cytoplasm_intensity_int_int`, `cytoplasm_intensity_mean_int`,
`nuclei_hoechst_int` , `distance traveled` the cell count and main features.  
* save summary data file  


## ICAM1 summarization   
ICAM1 data requires a different treatment as the response is bi-directional. The summary statistics for ICAM1 is performed in this script instead of in the GUI of H5CellProfiler package.     

There are two sets of ICAM1 data, the first set is from the DILI compound screen, the second set is a smaller screen of which the majority of compounds are the same as in the first set but with different selected cmax-values. THere is ambiguouty regarding c-cmax values in literature, the change in the cmax values for the second screen is based on the wishes from the MIP-DILI consortium.   
There is a distinct difference in the screening procedure between the full screen and the second subset (new-cmax) screen. In the first screen the full compound set was pipetted on plates, with different concentrations on a plate to plate basis. In the second, new-cmax screen, all compounds including dose range fit onto a single plate, therefore multiple plates only correspond to replicates.  


```{r load_single_cell_ICAM1}
ICAM.path <- "../data/Rdata files ICAM1/"
ICAM.files <- dir(ICAM.path)[grepl(".Rdata", dir(ICAM.path) )]
ICAM.raw =list()
for(i in seq_along(ICAM.files)) 
{
print(i)
    load(paste(ICAM.path, ICAM.files[i], sep ="/"))
  ICAM.raw[[i]] <- outputList
ICAM.raw[[i]] <- outputList
ICAM.raw[[i]]$myDT$set <- "oldcmax"
  rm("outputList")
}



```

Load single cell ICAM1 new cmax data

```{r load_single_cell_ICAM1_newcmax}
ICAM.path <- "../data/Rdata files ICAM1/newcmaxdata/"
ICAM.files <- dir(ICAM.path)[grepl(".Rdata", dir(ICAM.path) )]
k <- length(ICAM.raw)

for(i in seq_along(ICAM.files)) 
{
print(i+k)
    load(paste(ICAM.path, ICAM.files[i], sep ="/"))
  ICAM.raw[[k+i]] <- outputList
  ICAM.raw[[k+i]]$myDT$set <- "newcmax"
rm("outputList")
  }

```


fix column names 

```{r fix_column_names}

#img -> image
#obj_cytoplasm_  -> obj_cyto_only_  
#obj_nuclei_Children_obj_icam1_Count -> obj_cells_Children_obj_icam1_Count
#obj_nuclei_Number_Object_Number -> obj_cells_Number_Object_Number

for(i in seq_along(ICAM.raw)) {
  colnames(ICAM.raw[[i]]$myDT) <- gsub("DistanceTraveled_[0-9]{2}", "DistanceTraveled", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("TrackObjects_Label_[0-9]{2}", "TrackObjects_Label", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("TrackObjects_ParentObjectNumber_[0-9]{2}", "TrackObjects_ParentObjectNumber", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("img", "image", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_cytoplasm_", "obj_cyto_only_", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_nuclei_Children_obj_icam1_Count", "obj_cells_Children_obj_icam1_Count", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_nuclei_Number_Object_Number", "obj_cells_Number_Object_Number", colnames(ICAM.raw[[i]]$myDT))
  }

```



One plate was kept on the microscope too long, another crashed half way. These errors are handled here;  

```{r data_cleaning }
# remove for plate 20150608 - 10cMax_wells  time points:
#25.8 27.2 28.6 30.0 31.4 32.8 34.2 35.6 37.0 38.4 
 lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 , "plateID"),  '[' )
ICAM.raw[[4]]$myDT$plateID[1]


dim(ICAM.raw[[4]]$myDT)
ICAM.raw[[4]]$myDT[, timeAfterExposure := as.numeric(as.character(timeAfterExposure))]
ICAM.raw[[4]]$myDT <- ICAM.raw[[4]]$myDT[ !( plateID %in% "20150608 - 10cMax_wells" &
                            timeAfterExposure %in% as.numeric( c(25.8, 27.2, 28.6, 30.0, 31.4, 32.8, 34.2, 35.6, 37.0, 38.4))) ,]

# De plaat met SRXN1 en ICAM1 van 0930 op 1001 is gecrashed na 5 uur en 45 minuten. 
# Het eerste experiment (dus alles in map 0930)  was 's middags gestart om 16:55
# Het experiment is herstart om 9:02
# Het tweede deel (dus alles in map 1001) duurt nog 7 uur. Tijdpunten zijn elke 1 uur en 35 minuten. 

# dus 5:45 --> gecrasht om 16:55 + 5u45 min = 22:40 gecrasht. Start 10:20 later

unique((ICAM.raw[[13]]$myDT[, timeID])) 
#change plateID
ICAM.raw[[13]]$myDT[, plateID:="20150930_ICAM1"]
#modify time


timeBetweenFrames <- "01:35:00"
exposureDelay <- "16:05"

timeBetweenFrames <- round(as.integer(strftime(strptime(timeBetweenFrames, format = "%H:%M:%S"), "%H")) + 
                             1/60 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                 format = "%H:%M:%S"), "%M")) +
                             1/3600 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                   format = "%H:%M:%S"), "%S"))
                           , digit =2 )

exposureDelay <- round(as.integer(strftime(strptime(exposureDelay, format = "%H:%M"), "%H")) + 
                         1/60 * as.integer(strftime(strptime(exposureDelay, 
                                                             format = "%H:%M"), "%M")), digit =1 )
ICAM.raw[[13]]$myDT[, timeAfterExposure:=round(as.numeric(timeID)*timeBetweenFrames+exposureDelay - timeBetweenFrames, digits = 1) ]
unique((ICAM.raw[[13]]$myDT[, timeAfterExposure])) 
unique((ICAM.raw[[13]]$myDT[, timeID])) 
((ICAM.raw[[13]]$myDT[, timeID:=as.numeric(timeID)+4])) 

#combine:
object.size(ICAM.raw[[12]]$myDT) #126677216 bytes
object.size(ICAM.raw[[13]]$myDT) #166096056 bytes
nrow(ICAM.raw[[12]]$myDT) #673454
nrow(ICAM.raw[[13]]$myDT) #864733

ICAM.raw[[12]]$myDT <- rbind(ICAM.raw[[12]]$myDT, ICAM.raw[[13]]$myDT)
object.size(ICAM.raw[[12]]$myDT)  #276963688 bytes
nrow(ICAM.raw[[12]]$myDT)  #1538187
#673454+864733 = 1538187
ICAM.raw[[13]] <- NULL
unique(ICAM.raw[[12]]$myDT[, timeAfterExposure])

ICAM.raw[[12]]$myDT[ treatment%in%"DMSO" & as.numeric(as.character(dose_uM)) <= 0.2]


``` 




Determine DMSO background levels and use these threshold values to count GFP positive cells for the ICAM1 single cell data   
Procedure:
* calculate for each plate for each time points the cell population mean for DMSO <= 0.02  `meanDMSO`  
* subtract these background values plate and time point wise  `norm`  
* calculate threshold values based on raw background values for each plate from cell population mean of GFP levels of DMSO dose <=0.2 of timepoint 1 & 2.
* count cells above and below 2X, 3X and mean + 3DS these plate specific threshold values  

```{r count_ICAM1 }

all.columns <- lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 ), colnames )
lapply(all.columns, length)
all.columns[4:5] # some tables have "replID" extra

# remove replID columns

for( i in seq_along(ICAM.raw)) {
  if(!is.null(ICAM.raw[[i]]$myDT$replID)){
  ICAM.raw[[i]]$myDT$replID <- NULL
  }
}
all.columns <- lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 ), colnames )
all(sapply(all.columns, FUN = `%in%`, all.columns[[1]])) # do all datasets contain the same set of columns?

# columns of interest for counting cells
TH.cols <- colnames(ICAM.raw[[1]]$myDT)[c(16, 17, 18, 19 )]
TH.cols

#calculate mean of DMSO for <= 0.2 concentration for each time point
mean.dmso.colnames <- paste("meanDMSO_", TH.cols, sep="")

meanDMSO = list()
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  ICAM.raw[[i]]$myDT[, dose_uM:= as.numeric(as.character(ICAM.raw[[i]]$myDT[, dose_uM]))]# change factor to numeric of dose 
    meanDMSO[[i]] <-  ICAM.raw[[i]]$myDT[ treatment %in% "DMSO" & dose_uM <= 0.2 ,  
                                                               lapply(.SD, function(x) { mean(x, na.rm=TRUE) }),
                                                               by = c("plateID",   "timeID"),
                                                               .SDcols =
                                                                 TH.cols
                                                               ]
    setnames(meanDMSO[[i]], old = TH.cols, new = mean.dmso.colnames)
    
    setkeyv(ICAM.raw[[i]]$myDT, c("plateID", "timeID"))
    setkeyv(meanDMSO[[i]], c("plateID", "timeID"))
    
    ICAM.raw[[i]]$myDT <- ICAM.raw[[i]]$myDT[meanDMSO[[i]]]
    
          }

# subtract these DMSO background values values

normCols <- paste("norm", TH.cols, sep ="_")

for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
 
  for(j in seq_along(normCols)) {
    print(j)
    print(normCols[j])
    print(TH.cols[j])
    print(mean.dmso.colnames[j])
    
       ICAM.raw[[i]]$myDT[, normCols[j]:= (get(TH.cols[j]) - get(mean.dmso.colnames[j]) ) ] # norm cols as the values = DMSO averages 
  }
}

TH.cols.mean <- paste("backgroundValue.",TH.cols ,sep = "") # column names for background values  
mean1above <- paste( "mean1above", TH.cols, sep ="_")
mean2above <- paste( "mean2above", TH.cols, sep ="_")
mean3above <- paste( "mean3above", TH.cols, sep ="_")
mean1below <- paste( "mean1below", TH.cols, sep ="_")
mean2below <- paste( "mean2below", TH.cols, sep ="_")
mean3below <- paste( "mean3below", TH.cols, sep ="_")

# count cells above and below background of DMSO time points 1 & 2: more stable than only 1 timepoint
#remove redundent data to save some memory

rmCols <- c("imageNumber", "plateWellID", "groupNumber","imageID","plateWellID",
            "meanDMSO_obj_icam1_Intensity_IntegratedIntensity_image_GFP","meanDMSO_obj_icam1_Intensity_MeanIntensity_image_GFP",
            "meanDMSO_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP","meanDMSO_obj_cyto_only_Intensity_MeanIntensity_image_GFP")
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  for(j in seq_along(rmCols)){
  ICAM.raw[[i]]$myDT[, rmCols[j]:= NULL ]
  }
}
gc()
# count norm cols above and below thresholds. Theshold is determined from raw data of first two time points from DMSO dose <= 0.2

for(i in seq_along(ICAM.raw)) {
 print(paste("i: ", i ))
# a fancy way to use a mean of a subset and populate a list of columns with these means entirely (usually I would use a merge)
  ICAM.raw[[i]][["myDT"]][, get(
    "TH.cols.mean"):= list(mean(get(TH.cols[1])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE), 
                           mean(get(TH.cols[2])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE),
                           mean(get(TH.cols[3])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE),
                           mean(get(TH.cols[4])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE))]

  for(j in seq_along(normCols)) { # dus aantal cellen die boven achtergrond uitsteken nadat achtergrond er al af is gehaald
    print(j) 
  # normcol is 1 achtergrond waarde reeds afgehaald. dus -1 aan rechter kant gedaan
    ICAM.raw[[i]]$myDT[, mean1above[j]:= ((get(normCols[j])) >= (0.5*get(TH.cols.mean[j]))  )] 
    ICAM.raw[[i]]$myDT[, mean2above[j]:= ((get(normCols[j])) >= (1*get(TH.cols.mean[j]))  )] 
    ICAM.raw[[i]]$myDT[, mean3above[j]:= ((get(normCols[j])) >= (2*get(TH.cols.mean[j])) )] 
    ICAM.raw[[i]]$myDT[, mean1below[j]:= ((get(normCols[j])) <= (-0.5*get(TH.cols.mean[j]) ) )] 
    ICAM.raw[[i]]$myDT[, mean2below[j]:= ((get(normCols[j])) <= (-1*get(TH.cols.mean[j]))  )] 
    ICAM.raw[[i]]$myDT[, mean3below[j]:= ((get(normCols[j])) <= (-2*get(TH.cols.mean[j]) ) )] 
    
  }
}


```




Calculate cell population means of ICAM1 single cell data for selected sets of features, mean based on levels;  
`"treatment", "dose_uM", "cell_line", "plateID", "timeID", "timeAfterExposure"`

```{r mean_ICAM1_oldcmax}
# calculate cell population means

all.icam.feats<-c("imageCountTracked", "obj_icam1_AreaShape_Area",
             "obj_icam1_Intensity_IntegratedIntensity_image_GFP","obj_icam1_Intensity_MeanIntensity_image_GFP",
             "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP","obj_cyto_only_Intensity_MeanIntensity_image_GFP",
             "obj_nuclei_AreaShape_Area","obj_nuclei_Intensity_MeanIntensity_image_hoechst",
             "obj_nuclei_TrackObjects_DistanceTraveled", 
             normCols,
             TH.cols.mean, mean1above, mean2above, mean3above, mean1below, mean2below, mean3below
             
)

mean.data.ICAM1= list()

all.icam.feats[ !all.icam.feats%in% colnames(ICAM.raw[[2]]$myDT)] # check if column names correct now

#calculate mean, however what about NA values? no problem I think: mean(c(NA,NA,NA,1,0),na.rm=TRUE) = 0.5 (with regard to fraction GFP positive...)
for(i in seq_along(ICAM.raw)){
print(i)
    mean.data.ICAM1[[i]] <-  ICAM.raw[[i]]$myDT[ , lapply(.SD, function(x) { mean(x, na.rm=TRUE) }),
                                            by = c("treatment", "dose_uM", "cell_line", "plateID", "timeID", "timeAfterExposure"),
                                  .SDcols = all.icam.feats
                            ]
  }



```

ICAM1: save single cell data & and remove from memory

```{r save_singlecell_ICAM1}

save( ICAM.raw, file = "../generated/ICAM.raw.Rdata")

rm("ICAM.raw")
gc()

save( mean.data.ICAM1, file = "../tmp/mean.data.ICAM1.Rdata") # save to revert in case of error


```

Clean ICAM1 summary data  
* replace new cmax compounds
* fix some errors originating from original layout files
* add cmax identifier  

```{r clean_ICAM1_summarydata }

load("../tmp/mean.data.ICAM1.Rdata")
mean.data.ICAM1 <- do.call('rbind', mean.data.ICAM1)
mean.data.ICAM1[, treatment := tolower(treatment)]
#Carmustine 0.037 ipv 0.0356

mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 0.356, dose_uM:= 0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 1.78, dose_uM:= 5*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 3.56, dose_uM:= 10*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 8.90, dose_uM:= 25*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 17.80, dose_uM:= 50*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 35.60, dose_uM:= 100*0.037]

#new cmax have changed and 1 extra
#1
#5
#10
#25 <-- new (remove for this screen, as only small subset of compounds are tested at 25cmax)
#50
#100


# replace old cmax for new.
# plates with newCmax concentrations: 20150923_ICAM1 & 20150930_ICAM1

newcmaxPlates <- mean.data.ICAM1[ plateID %in% c("20150923_ICAM1", "20150930_ICAM1" )]
mean.data.ICAM1 <- mean.data.ICAM1[ !plateID %in% c("20150923_ICAM1", "20150930_ICAM1" )]
newcmaxcomps <- unique(newcmaxPlates[, treatment])
newcmaxcomps <- newcmaxcomps[ newcmaxcomps != "dmso"]
newCmax <- as.data.table(
  read.delim(file = "../metadata/newCmax.txt", sep = "\t", header = TRUE)) # load 1cmax concentrations of new cmax compound set 
newCmax$treatment <- tolower(newCmax$treatment)
cbind(sort(newCmax$treatment), sort(newcmaxcomps), sort(newCmax$treatment) == sort(newcmaxcomps))

all(newcmaxcomps %in% unique(mean.data.ICAM1$treatment))

mean.data.ICAM1 <- mean.data.ICAM1[!treatment %in% newcmaxcomps]

# add cmax annotation for all compounds, plate identifiers can be used for old cmax, new cmax an annotation file is used.
# add cmax identifiers  
unique(mean.data.ICAM1[, plateID])
mean.data.ICAM1[ grepl("- 1cMax", plateID), cmax := 1]
mean.data.ICAM1[ grepl("- 5cMax", plateID), cmax := 5]
mean.data.ICAM1[ grepl("- 10cMax", plateID), cmax := 10]
mean.data.ICAM1[ grepl("- 50cMax", plateID), cmax := 50]
mean.data.ICAM1[ grepl("- 100cMax", plateID), cmax := 100]
mean.data.ICAM1[ ,cmax := factor(cmax, levels = c(1, 5, 10, 50 ,100)) ]
unique(mean.data.ICAM1[ ,cmax ])

# add cmax annotation for newcmax compounds
newCmax$cmax <- 1
colnames(newCmax) <- c("treatment", "dose_uM", "cmax")
cmax5 <- newCmax
cmax10 <- newCmax
cmax25 <- newCmax
cmax50 <- newCmax
cmax100 <- newCmax

cmax5$dose_uM<-newCmax$dose_uM*5
cmax5$cmax <- 5
cmax10$dose_uM<- newCmax$dose_uM*10
cmax10$cmax<-10
cmax25$dose_uM<- newCmax$dose_uM*25
cmax25$cmax<-25
cmax50$dose_uM <- newCmax$dose_uM*50
cmax50$cmax<-50
cmax100$dose_uM <- newCmax$dose_uM*100
cmax100$cmax<-100

newCmax<- rbind(newCmax,cmax5,cmax10, cmax25, cmax50, cmax100)
newCmax<- as.data.table(newCmax)
lapply(newCmax, class)
class(newcmaxPlates$dose_uM)


newcmaxPlates[ , treatment := as.character(treatment)]
newcmaxPlates[ , dose_uM := as.character(dose_uM)]
newCmax[ , treatment := as.character(treatment)]
newCmax[ , dose_uM := as.character(dose_uM)]

ind<-(newCmax$dose_uM %in% unique(newcmaxPlates$dose_uM))
newCmax[!ind, ]

ind2 <- unique(newcmaxPlates$dose_uM) %in% newCmax$dose_uM
unique(newcmaxPlates$dose_uM)[!ind2] #the DMSO

cbind( sort(newCmax[!ind, dose_uM ]), sort(unique(newcmaxPlates$dose_uM)[!ind2]))

setkeyv(newcmaxPlates, c("treatment", "dose_uM") )
setkeyv(newCmax, c("treatment", "dose_uM"))

newcmaxPlates<-newCmax[newcmaxPlates]

newcmaxPlates[ is.na(cmax) , 1:5]
newcmaxPlates[treatment %in% "dmso", cmax := 0 ]
newcmaxPlates[treatment %in% "dmso", dose_uM]

newcmaxPlates[treatment %in% "dmso", dose_uM := "0" ]

mean.data.ICAM1[ treatment %in% "dmso", list(treatment, dose_uM, cmax) ]
table(mean.data.ICAM1[ treatment %in% "dmso", list(treatment, dose_uM, cmax) ]$dose_uM)
# apparently percentage & fraction for dmso concentrations was both used in layout files.

mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 100, dose_uM := 0.2 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 50, dose_uM := 0.1 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 10, dose_uM := 0.02 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 5, dose_uM := 0.01 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 1, dose_uM := 0.002 ]

# test for effect of DMSO concentration
dmsotest <- mean.data.ICAM1[ treatment %in% "dmso"]

dmsotest <- aggregate( data = dmsotest, obj_cyto_only_Intensity_IntegratedIntensity_image_GFP ~ dose_uM + plateID, mean )
plot(data= dmsotest, obj_cyto_only_Intensity_IntegratedIntensity_image_GFP ~ dose_uM, ylim = c(0,50),
     col = as.factor(dmsotest$plateID))
# plate effect apparant, but no DMSO concentration effect. Pooling DMSO to simplify analysis:
mean.data.ICAM1[ treatment %in% "dmso" , dose_uM := 0]
mean.data.ICAM1[ treatment %in% "dmso" , cmax := "0"]


lapply(mean.data.ICAM1[,1:7], class)
lapply(newcmaxPlates[,1:7], class)
newcmaxPlates[, cmax := as.character(cmax)]
mean.data.ICAM1[ , dose_uM := as.numeric(dose_uM)]
# combine both sets
mean.data.ICAM1 <- rbind(mean.data.ICAM1, newcmaxPlates)
# remove 25 cmax
mean.data.ICAM1 <- mean.data.ICAM1[ cmax != "25"]
mean.data.ICAM1.long<- melt(mean.data.ICAM1,  id.vars = c("treatment", "dose_uM","cmax", "cell_line", "plateID", "timeID", "timeAfterExposure"))


# add replicate ID
 mean.data.ICAM1.long[ plateID == "20160113 - 100cMax_wells", replID := "replicate_1" ]  #icam1 100cmax repl1
 mean.data.ICAM1.long[ plateID == "20150830 - 100cMax_wells", replID := "replicate_2"]  #icam1 100cmax repl2
 mean.data.ICAM1.long[ plateID == "20140701 - 50cMax_wells", replID := "replicate_1"]  #icam1 50cmax repl1
 mean.data.ICAM1.long[ plateID == "20150828 - 50cMax_wells", replID := "replicate_2"]  #icam1 50cmax repl2
 mean.data.ICAM1.long[ plateID == "20150604 - 10cMax_wells", replID := "replicate_1"]  #icam1 10cmax repl1
 mean.data.ICAM1.long[ plateID == "20150608 - 10cMax_wells", replID := "replicate_2"]  #icam1 10cmax repl2
 mean.data.ICAM1.long[ plateID == "20150601 - 5cMax_wells", replID := "replicate_1"]  #icam1 5cmax repl1
 mean.data.ICAM1.long[ plateID == "20151231 - 5cMax_wells", replID := "replicate_2"]  #icam1 5cmax repl2
 mean.data.ICAM1.long[ plateID == "20150829 - 1cMax_wells", replID := "replicate_1"]  #icam1 1cmax repl1
 mean.data.ICAM1.long[ plateID == "20150914 - 1cMax_wells", replID := "replicate_2"]  #icam1 1cmax repl2

 unique(mean.data.ICAM1.long[ is.na(replID), plateID])
mean.data.ICAM1.long[ plateID == "20150923_ICAM1", replID := "replicate_1"]  #icam1 new cmax repl1 
mean.data.ICAM1.long[ plateID == "20150930_ICAM1", replID := "replicate_2"]  #icam1 new cmax repl2

unique(mean.data.ICAM1.long[ cmax != "0" , list(plateID, cmax)])

save(file = '../tmp/mean.data.ICAM1.long.Rdata', mean.data.ICAM1.long)

```

plots for quality control   
```{r plotsQQ_ICAM1 }

# plot time curves, grid the concentrations and treatments, loop over variables

fingerprintVars <- unique(mean.data.ICAM1.long[ , variable])
writepdfs <- "../generated/results/ICAM1_qqplots/"
if(!file.exists(writepdfs)){
  dir.create(writepdfs)
}

for( i in seq_along(fingerprintVars)){

  plotData <- mean.data.ICAM1.long[ variable %in% fingerprintVars[i]]
  
  p <- ggplot(data =plotData, aes(x= timeAfterExposure, y=value, color = replID)) + facet_grid(treatment~cmax)
  p<-p + geom_point(aes(color=replID, shape = replID)) + geom_line(aes(group=replID, color=replID)) + 
    theme_sharp() + ggtitle( label = fingerprintVars[i]) 
  pdf(file = paste(writepdfs, fingerprintVars[i], ".pdf", sep =""), width =12, height = 100)
  print(p)
  dev.off()
}

```

## Summary data Srxn1, Chop, p21  

load summary data files from H5CellProfiler output for cell lines p21 srxn1 & chop  
This includes original screen + adjusted subset of compounds with updated cmax values  

```{r load_summary_data_files}

path.to.nonICAM <- "../data/Summary data files"
raw.data =list()
dir.files <- dir(path.to.nonICAM)
dir.files <- dir.files[grepl("(Summary Data)", dir.files)]

for (i in seq_along(dir.files)){
  raw.data[[i]] <- as.data.table(
    read.table(file = paste(path.to.nonICAM, dir.files[i], sep ="/"), header = TRUE, sep ="\t")
  )
}



```

Data cleaning - new cmax

```{r newcmax_data_cleaning}

lapply(raw.data, function(x) unique(x$plateID))
# 37 through 43 are newcmax plates containing multiple doses
for(i in 37:43){
  raw.data[[i]][ , plateID := paste(plateID, "newCmax", sep = "_")]
}


# De plaat met SRXN1 en ICAM1 van 0930 op 1001 is gecrashed na 5 uur en 45 minuten. 
# Het eerste experiment (dus alles in map 0930)  was 's middags gestart om 16:55
# Het experiment is herstart om 9:02
# Het tweede deel (dus alles in map 1001) duurt nog 7 uur. Tijdpunten zijn elke 1 uur en 35 minuten. 

# dus 5:45 --> gecrasht om 16:55 + 5u45 min = 22:40 gecrasht. Start 10:20 later

unique((raw.data[[42]][, timeID])) 
unique((raw.data[[43]][, timeID])) 
#change plateID

raw.data[[43]][, plateID:="20150930_SRXN1_newCmax"]
#modify time

timeBetweenFrames <- "01:35:00"
exposureDelay <- "16:05"

timeBetweenFrames <- round(as.integer(strftime(strptime(timeBetweenFrames, format = "%H:%M:%S"), "%H")) + 
                             1/60 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                 format = "%H:%M:%S"), "%M")) +
                             1/3600 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                   format = "%H:%M:%S"), "%S"))
                           , digit =2 )

exposureDelay <- round(as.integer(strftime(strptime(exposureDelay, format = "%H:%M"), "%H")) + 
                         1/60 * as.integer(strftime(strptime(exposureDelay, 
                                                             format = "%H:%M"), "%M")), digit =1 )

raw.data[[43]][, timeAfterExposure:=round(as.numeric(timeID)*timeBetweenFrames+exposureDelay - timeBetweenFrames, digits = 1) ]

unique((raw.data[[43]][, timeAfterExposure])) 
unique((raw.data[[43]][, timeID])) 
raw.data[[43]][, timeID:=as.numeric(timeID)+4]

#combine:
object.size(raw.data[[42]]) #199880 bytes
object.size(raw.data[[43]]) #214776 bytes
nrow(raw.data[[42]]) #3724
nrow(raw.data[[43]]) #3724

raw.data[[42]] <- rbind(raw.data[[42]], raw.data[[43]])
object.size(raw.data[[42]])  #423888 bytes
nrow(raw.data[[42]])  #7448
#199880+214776 = 414656
raw.data[[43]] <- NULL
unique(raw.data[[42]][, timeAfterExposure])

raw.data[[42]][ treatment%in%"DMSO" & as.numeric(as.character(dose_uM)) <= 0.2] # checking if controls available..

```


data cleaning - original cmax data


```{r data_cleaning}

# first 3 no timeAfterExposure
# 2013-07-10 1.2  0.8
# 2013-07-24 1.076 tr  40min del
# 2013-07-29  59 min  20 min


timeBetweenFrames <- 1.2
exposureDelay <- 0.8
raw.data[[1]]$timeAfterExposure<- as.integer(raw.data[[1]]$timeID) * timeBetweenFrames + exposureDelay - timeBetweenFrames

timeBetweenFrames <- 1.076
exposureDelay <- 0.667
raw.data[[2]]$timeAfterExposure<- as.integer(raw.data[[2]]$timeID) * timeBetweenFrames + exposureDelay - timeBetweenFrames

timeBetweenFrames <- 0.983
exposureDelay <- 0.333
raw.data[[3]]$timeAfterExposure<- as.integer(raw.data[[3]]$timeID) * timeBetweenFrames + exposureDelay - timeBetweenFrames

which(unlist(lapply(raw.data, ncol)) != 9 )

raw.data[[13]]$control <-1
raw.data[[26]]$doseLevel <- NULL

which(unlist(lapply(raw.data, ncol)) != 9 )


raw.data <- do.call("rbind" ,raw.data)

raw.data$treatment <- tolower(raw.data$treatment)

raw.data$control <-NULL
sum(is.na(raw.data))

head(raw.data)

raw.data$variable <- gsub("_>_", "_larger_", raw.data$variable)
raw.data$variable <- gsub("_<_", "_smaller_", raw.data$variable)
raw.data$variable <- gsub("[_]{1}$", "", raw.data$variable)
raw.data$variable <- gsub("[_]{1}$", "", raw.data$variable)

unique(raw.data$variable)

# fix cell line names
unique(raw.data$cell_line)
raw.data$cell_line <- gsub("Chop", "DDIT3", raw.data$cell_line)
raw.data$cell_line <- gsub("CHOP", "DDIT3", raw.data$cell_line)
raw.data$cell_line <- gsub("SRXN1", "Srxn1", raw.data$cell_line)
raw.data$cell_line <- gsub("P21", "p21", raw.data$cell_line)
unique(raw.data$plateID)



raw.data$replID <- "none"
raw.data$cmax <- "none"

raw.data[ raw.data$plateID == "2013_07_10_Srxn1_z1", "replID"] <-   "replicate_1"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_07_10_Srxn1_z1", "cmax"] <-   "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_07_24_Srxn1", "replID"] <-      "replicate_2"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_07_24_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_07_29_Srxn1", "replID"] <-      "replicate_3"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_07_29_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_08_01_Srxn1", "replID"] <-      "replicate_4"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_08_01_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_08_14_Srxn1", "replID"] <-      "replicate_5"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_08_14_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_08_15_Srxn1", "replID"] <-      "replicate_1"  #Srxn1 50cmax
raw.data[ raw.data$plateID == "2013_08_15_Srxn1", "cmax"] <-      "50cmax"  #Srxn1 50cmax

raw.data[ raw.data$plateID == "2013_08_21_Srxn1", "replID"] <-      "replicate_2"  #Srxn1 50cmax
raw.data[ raw.data$plateID == "2013_08_21_Srxn1", "cmax"] <-      "50cmax"  #Srxn1 50cmax

raw.data[ raw.data$plateID == "2013_08_22_Srxn1", "replID"] <-      "replicate_3"  #Srxn1 50cmax     
raw.data[ raw.data$plateID == "2013_08_22_Srxn1", "cmax"] <-      "50cmax"  #Srxn1 50cmax

raw.data[ raw.data$plateID == "2013_08_28_nii_Srxn1", "replID"] <-  "replicate_1"  #Srxn1 10cmax
raw.data[ raw.data$plateID == "2013_08_28_nii_Srxn1", "cmax"] <-  "10cmax"  #Srxn1 10cmax

raw.data[ raw.data$plateID == "2013_08_28_niii_Srxn1", "replID"] <- "replicate_2"  #Srxn1 10cmax  
raw.data[ raw.data$plateID == "2013_08_28_niii_Srxn1", "cmax"] <- "10cmax"  #Srxn1 10cmax

raw.data[ raw.data$plateID == "2013_09_04_Srxn1", "replID"] <-      "replicate_3"  #Srxn1 10cmax
raw.data[ raw.data$plateID == "2013_09_04_Srxn1", "cmax"] <-      "10cmax"  #Srxn1 10cmax

raw.data[ raw.data$plateID == "2013_09_05_Srxn1", "replID"] <-      "replicate_1"  #Srxn1 5cmax
raw.data[ raw.data$plateID == "2013_09_05_Srxn1", "cmax"] <-      "5cmax"  #Srxn1 5cmax

raw.data[ raw.data$plateID == "2013_09_09_Srxn1", "replID"] <-      "replicate_2"  #Srxn1 5cmax
raw.data[ raw.data$plateID == "2013_09_09_Srxn1", "cmax"] <-      "5cmax"  #Srxn1 5cmax

raw.data[ raw.data$plateID == "2013_09_16_Srxn1", "replID"] <-      "replicate_1"  #Srxn1 1cmax
raw.data[ raw.data$plateID == "2013_09_16_Srxn1", "cmax"] <-      "1cmax"  #Srxn1 1cmax


raw.data$plateID <- gsub("25-9-2013_Srxn1", "2013_09_25_Srxn1", raw.data$plateID)

raw.data[ raw.data$plateID == "2013_09_25_Srxn1", "replID"] <-       "replicate_2"  #Srxn1 1cmax
raw.data[ raw.data$plateID == "2013_09_25_Srxn1", "cmax"] <-       "1cmax"  #Srxn1 1cmax

raw.data[ raw.data$plateID == "2013_09_26_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 100cmax
raw.data[ raw.data$plateID == "2013_09_26_DDIT3", "cmax"] <-      "100cmax"  #DDIT3 100cmax

raw.data[ raw.data$plateID == "2013_10_03_DDIT3", "replID"] <-      "replicate_2"  #DDIT3 100cmax
raw.data[ raw.data$plateID == "2013_10_03_DDIT3", "cmax"] <-      "100cmax"  #DDIT3 100cmax

raw.data[ raw.data$plateID == "2013_10_04_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 50cmax
raw.data[ raw.data$plateID == "2013_10_04_DDIT3", "cmax"] <-      "50cmax"  #DDIT3 50cmax

raw.data[ raw.data$plateID == "2013_10_09_niii_p21", "replID"] <-   "replicate_1"  #p21 100cmax
raw.data[ raw.data$plateID == "2013_10_09_niii_p21", "cmax"] <-   "100cmax"  #p21 100cmax

raw.data[ raw.data$plateID == "2013_10_09_nii_p21", "replID"] <-    "replicate_2"  #p21 100cmax
raw.data[ raw.data$plateID == "2013_10_09_nii_p21", "cmax"] <-    "100cmax"  #p21 100cmax

raw.data[ raw.data$plateID == "2013_10_17_nii_DDIT3", "replID"] <-  "replicate_2"  #DDIT3 50cmax
raw.data[ raw.data$plateID == "2013_10_17_nii_DDIT3", "cmax"] <-  "50cmax"  #DDIT3 50cma

raw.data[ raw.data$plateID == "2013_10_17_niii", "replID"] <-       "replicate_3"  #DDIT3 50 cmax
raw.data[ raw.data$plateID == "2013_10_17_niii", "cmax"] <-       "50cmax"  #DDIT3 50 cm

raw.data[ raw.data$plateID == "2013_10_24_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 10 cmax
raw.data[ raw.data$plateID == "2013_10_24_DDIT3", "cmax"] <-      "10cmax"  #DDIT3 10 cm

raw.data[ raw.data$plateID == "2013_11_20_DDIT3", "replID"] <-      "replicate_2"  #DDIT3 10 cmax
raw.data[ raw.data$plateID == "2013_11_20_DDIT3", "cmax"] <-      "10cmax"  #DDIT3 10 cm

raw.data[ raw.data$plateID == "2013_11_27_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 5 cmax
raw.data[ raw.data$plateID == "2013_11_27_DDIT3", "cmax"] <-      "5cmax"  #DDIT3 5 cma

raw.data[ raw.data$plateID == "2013_12_04_DDIT3_niii", "replID"] <-      "replicate_1"  #DDIT3 1 cmax
raw.data[ raw.data$plateID == "2013_12_04_DDIT3_niii", "cmax"] <-      "1cmax"  #DDIT3 

raw.data[ raw.data$plateID == "2013_12_04_DDIT3_nii", "replID"] <-  "replicate_2"  #DDIT3 1 cmax
raw.data[ raw.data$plateID == "2013_12_04_DDIT3_nii", "cmax"] <-  "1cmax"  #DDIT3 1 cma

raw.data[ raw.data$plateID == "2013_12_11_DDIT3", "replID"] <-  "replicate_2"  #DDIT3 5 cmax
raw.data[ raw.data$plateID == "2013_12_11_DDIT3", "cmax"] <-  "5cmax"  #DDIT3 5 cmax

raw.data[ raw.data$plateID == "2014_02_05_nii_p21", "replID"] <-    "replicate_1" #p21 10cmax
raw.data[ raw.data$plateID == "2014_02_05_nii_p21", "cmax"] <-    "10cmax" #p21 10cma

raw.data[ raw.data$plateID == "2014_02_05_p21_niii", "replID"] <-   "replicate_2" #p21 10cmax
raw.data[ raw.data$plateID == "2014_02_05_p21_niii", "cmax"] <-   "10cmax" #p21 10cma

raw.data[ raw.data$plateID == "2014_02_11_p21", "replID"] <-        "replicate_1" #p21 50cmax
raw.data[ raw.data$plateID == "2014_02_11_p21", "cmax"] <-        "50cmax" #p21 50cma

raw.data[ raw.data$plateID == "p21_50Cmax", "replID"] <-        "replicate_2" #p21 50cmax
raw.data[ raw.data$plateID == "p21_50Cmax", "cmax"] <-        "50cmax" #p21 50cmax

raw.data[ raw.data$plateID == "2014_02_18_p21", "replID"] <-        "replicate_1" #p21 5cmax 
raw.data[ raw.data$plateID == "2014_02_18_p21", "cmax"] <-        "5cmax" #p21 5cmax

raw.data[ raw.data$plateID == "2014_02_19_p21", "replID"] <-        "replicate_2" #p21 5cmax
raw.data[ raw.data$plateID == "2014_02_19_p21", "cmax"] <-        "5cmax" #p21 5cmax

raw.data[ raw.data$plateID == "2014_02_25_p21", "replID"] <-        "replicate_1" #p21 1cmax
raw.data[ raw.data$plateID == "2014_02_25_p21", "cmax"] <-        "1cmax" #p21 1cmax

raw.data[ raw.data$plateID == "2014_03_05_p21", "replID"] <-        "replicate_2" #p21 1cmax
raw.data[ raw.data$plateID == "2014_03_05_p21", "cmax"] <-        "1cmax" #p21 1cmax

sum((raw.data$replID == "none")) #0
sum((raw.data$cmax == "none")) #0
unique(raw.data$cmax)


# for newcmax data, add cmax on compound basis.
unique(raw.data[ cmax == "none", plateID])
newcmax.data <- raw.data[ cmax == "none",]
raw.data <- raw.data[ cmax != "none",]


#Carmustine 0.037 ipv 0.0356

newcmax.data[, dose_uM := as.numeric(dose_uM)]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 0.356, dose_uM:= 0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 1.78, dose_uM:= 5*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 3.56, dose_uM:= 10*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 8.90, dose_uM:= 25*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 17.80, dose_uM:= 50*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 35.60, dose_uM:= 100*0.037]


unique(newcmax.data$treatment)%in% newCmax$treatment # only dmso not
newcmax.data[, dose_uM := as.character(dose_uM)]
unique(newcmax.data$dose_uM)%in% newCmax$dose_uM # missing 1 (the dmso 0.2)
newcmax.data[, cmax := NULL]
newCmax <- as.data.table(
  read.delim(file = "../metadata/newCmax.txt", sep = "\t", header = TRUE)) # load 1cmax concentrations of new cmax compound set 

setkeyv(newCmax, c("treatment", "dose_uM")) # this lookup file was generated earlier in the ICAM1 newcmax part
setkeyv(newcmax.data, c("treatment", "dose_uM"))
newcmax.data.cmax <- newCmax[newcmax.data]

# add cmax for dmso
newcmax.data.cmax[ treatment == "dmso", cmax := 0 ]
unique(newcmax.data.cmax[ is.na(cmax), treatment])
newcmax.data.cmax[ cmax == "none"]

# add replID for newcmax compounds
newcmaxplates <- unique(newcmax.data.cmax[, plateID])
newcmax.data.cmax[ plateID == "20150923_CHOP_newCmax", replID := 'replicate_1' ]
newcmax.data.cmax[ plateID == "20150930_CHOP_newCmax", replID := 'replicate_2' ]
newcmax.data.cmax[ plateID == "20150923_P21_newCmax", replID := 'replicate_1' ]
newcmax.data.cmax[ plateID == "20150930_P21_newCmax", replID := 'replicate_2' ]
newcmax.data.cmax[ plateID == "20150923_SRXN1_newCmax", replID := 'replicate_1' ]
newcmax.data.cmax[ plateID == "20150930_SRXN1_newCmax", replID := 'replicate_2' ]

raw.data <- rbind(raw.data, newcmax.data.cmax)
raw.data <- raw.data[ cmax != 25,]


raw.data[ cmax == 0, cmax := '0cmax']
raw.data[ cmax == 1, cmax := '1cmax']
raw.data[ cmax == 5, cmax := '5cmax']
raw.data[ cmax == 10, cmax := '10cmax']
raw.data[ cmax == 50, cmax := '50cmax']
raw.data[ cmax == 100, cmax := '100cmax']

unique(raw.data[ , c("plateID", "cell_line", "cmax", "replID")])


sort( unique(raw.data$treatment))

raw.data$treatment <- gsub("metformin ", "metformin", raw.data$treatment )

# there are multiple & varying number of replicates, because manual inspection had shown failed experiments due to microscope crashes/ CO2 failure etc. after which experiments were repeated.
# there are however, at least two replicates for all experiments (cell line dose combinations)

```

Make sure concentrations are exactly the same  

```{r fix_dose }


raw.data$comp_dose <- paste(raw.data$treatment, raw.data$dose_uM, sep="_")
raw.data[, dose_uM := as.numeric(dose_uM)]
raw.data$dose_uM <- round(raw.data$dose_uM, digits = 4)

ind.more10 <- raw.data$dose_uM >= 10
raw.data$dose_uM[ind.more10] <- round(raw.data$dose_uM[ind.more10], digits = 1)
ind.more1 <- raw.data$dose_uM >= 1
raw.data$dose_uM[ind.more1] <- round(raw.data$dose_uM[ind.more1], digits = 2)


# tabel met compound namen en concentraties maken
raw.data[, comp_dose:= paste(treatment, dose_uM, sep ="_")]
compDosetabel <- unique(raw.data[!cell_line %in% "ICAM1", list(treatment, cmax, dose_uM, comp_dose)])

compDosetabel <- as.data.frame(compDosetabel)
compDosetabel<- compDosetabel[ order(compDosetabel$treatment, compDosetabel$dose_uM),]
# count how many doses each compound has and fix if incorrect

compDosetabel$comp_dose <- paste(compDosetabel$treatment, compDosetabel$dose_uM, sep="_")
comps <- unique(compDosetabel[ , c("treatment", "dose_uM", "cmax")])[ order(unique(compDosetabel$comp_dose)),  ]
comps <- comps[ order(comps$treatment, comps$dose_uM),]
tt <- ddply(comps, .(treatment), summarize, length(treatment))
tt[ tt[, "..1"] >5,]


# the newcmax compounds from plate p21_50Cmax are adjusted, these should therefor not be replaced later on when newcmax compounds are added.


#fix compDosetabel, daarna merge operatie ervan uitgaande dat de cmax'n kloppen


incDose <- comps[ comps$treatment %in%  c("digoxin","epinephrine", "haloperidol", "moxisylyte",
                               "paroxetine","phenacetin", "propranolol","ribavirin",
                               "simvastatin","sulindac", "tacrine", "ticlopidine"), ]
incDose


raw.data[ treatment == "digoxin" & dose_uM == 0.2830 & cmax == "100cmax", "dose_uM" ] <-0.2800
raw.data[ treatment == "epinephrine" & dose_uM == 0.1763 & cmax == "100cmax", "dose_uM" ] <-0.1800
raw.data[ treatment == "haloperidol" & dose_uM == 0.5321 & cmax == "100cmax", "dose_uM" ] <-0.53
raw.data[ treatment == "moxisylyte" & dose_uM == 15.7000 & cmax == "100cmax", "dose_uM" ] <-15.8
raw.data[ treatment == "paroxetine" & dose_uM == 3.0400 & cmax == "50cmax", "dose_uM" ] <-3.05
raw.data[ treatment == "phenacetin" & dose_uM == 30.8000 & cmax == "50cmax", "dose_uM" ] <-31.0
raw.data[ treatment == "propranolol" & dose_uM == 10.1000 & cmax == "50cmax", "dose_uM" ] <-10.0
raw.data[ treatment == "ribavirin" & dose_uM == 130.6000 & cmax == "50cmax" , "dose_uM" ] <-130.7
raw.data[ treatment == "simvastatin" & dose_uM == 4.1200 & cmax == "50cmax" , "dose_uM" ] <-4.1
raw.data[ treatment == "sulindac" & dose_uM == 1599.2000 & cmax == "50cmax", "dose_uM" ] <-1599.3
raw.data[ treatment == "tacrine" & dose_uM == 3.9800 & cmax == "50cmax", "dose_uM" ] <-4
raw.data[ treatment == "ticlopidine" & dose_uM ==  403.7000 & cmax == "50cmax", "dose_uM" ] <- 403.8
# wat niet klopt: 
#digoxin 
#epinephrine
#haloperidol
#moxisylyte
#paroxetine
#phenacetin
#propranolol
#ribavirin
#simvastatin
#sulindac
#tacrine
#ticlopidine

raw.data$comp_dose <- NULL


# lets have a look at the cmax dose_uM levels with respect to each other
all.t<- unique(raw.data$treatment)
k=NULL

all.t <- all.t[!all.t %in% newcmaxcomps]


for(i in seq_along(all.t)){
  mdim <- dim(unique(raw.data[ raw.data$treatment == all.t[i] , list(dose_uM,cmax) ]))
print(mdim)
  if(mdim[1] != 5){
    k = c(k, i)
  }
  } # 5 2 for all?

# print unexpected compound dose #
all.t[k]
# for the control compounds (.._c) this makes sense. Also for dmso and dmem

# for the new cmax compounds 10 are expected 
#diclofenac 500.5 -- > 505 (for new cmax p21 plate)

raw.data[ treatment == "diclofenac" & plateID ==  'p21_50Cmax' & dose_uM == 500.5, dose_uM := 505 ]

for(i in seq_along(newcmaxcomps)){
  #print(i)
  print(dim(unique(raw.data[ raw.data$treatment == newcmaxcomps[i] , list(dose_uM,cmax) ])))
}
 newcmaxcomps[15] # this concentration remained the same, but true analogue this time  

 for(i in seq_along(newcmaxcomps)){
 print(newcmaxcomps[i])
   print(unique(raw.data[ treatment == newcmaxcomps[i] & plateID == "p21_50Cmax", dose_uM]))
 }
 
 raw.data[ treatment == "aspirin" & plateID == "p21_50Cmax", dose_uM := 275]
  unique(raw.data[ treatment == "aspirin" & plateID == "p21_50Cmax", dose_uM ])
 raw.data[ treatment == "metformin" & plateID == "p21_50Cmax", dose_uM := 389]
  unique(raw.data[ treatment == "metformin" & plateID == "p21_50Cmax", dose_uM ])
 
  
  for(i in seq_along(newcmaxcomps)){
 print(newcmaxcomps[i])
   print(length(unique(raw.data[ treatment == newcmaxcomps[i] & plateID %in% newcmaxplates, dose_uM])))
 }
 
```


Check for completeness of data  
together with this data + after plotting data select 2 replicates of each cell line dose combination  
```{r checkCompleteness}

# count number of treatments for all experiments

raw.data[ , length(unique(treatment))  , by =  c("plateID", "replID", "cmax") ]
# low treatment count for plate 2013_10_04_DDIT3
all.treats <- unique(raw.data$treatment)

indNotIn_2013_10_04_DDIT3  <- which(! all.treats %in% unique(raw.data[ plateID %in% "2013_10_04_DDIT3", treatment]) )
all.treats[indNotIn_2013_10_04_DDIT3]

# check missing treatments for all plates
all.plates <- unique(raw.data[, plateID])
missingTreat = alist()
for( i in seq_along(all.plates)) {
  ind  <- which(! all.treats %in% unique(raw.data[ plateID %in% all.plates[i], treatment]) )
    tmp <- list( plate = all.plates[i], missingComps = all.treats[ind])
    missingTreat[[i]] <- tmp
  }
# plates that contain missing (non _c) compounds:
# 2013_07_10_Srxn1_z1 (121)
# 2013_07_24_Srxn1 (63)
# 2013_08_14_Srxn1 (10)
missingTreat[[5]]
# 2013_10_04_DDIT3 (16)
missingTreat[[18]]
# p21_50Cmax
missingTreat[[36]]
sort(unique(raw.data[ plateID == "p21_50Cmax", treatment]))

rel.treats <- sort(unique(raw.data[ plateID == "p21_50Cmax", treatment]))

missingTreatRel = alist()
for( i in seq_along(all.plates)) {
  ind  <- which(! rel.treats %in% unique(raw.data[ plateID %in% all.plates[i], treatment]) )
    tmp <- list( plate = all.plates[i], missingComps = rel.treats[ind])
    missingTreatRel[[i]] <- tmp
  }

# 2013_07_10_Srxn1_z1
# 2013_07_24_Srxn1 
# 2013_08_14_Srxn1 (5)
# 2013_10_04_DDIT3

unique(raw.data[plateID == "2013_08_14_Srxn1", list(cmax, plateID, cell_line)])
unique(raw.data[cell_line == "Srxn1" & cmax == "100cmax", list(cmax, plateID, cell_line)])


```

Change & select variable names  

```{r transform_variable_names}

unique(raw.data$variable)

raw.data[, variable:= gsub("_obj_cyto_only_", "_Cytoplasm_", variable) ]
raw.data[, variable:= gsub("_obj_nc_", "_Nuclei_", variable) ]
raw.data[, variable:= gsub("_img_cyto", "_Image_GFP", variable) ]
raw.data[, variable:= gsub("obj_nc_", "Nuclei_", variable) ]
raw.data[, variable:= gsub("_img_gfp", "_Image_GFP", variable) ]
raw.data[, variable:= gsub("Intensity_image_GFP_", "Intensity_Image_GFP_", variable)]


raw.data[, variable:= gsub("obj_cyto_only_Intensity_IntegratedIntensity", "Cytoplasm_Intensity_IntegratedIntensity", variable) ]

raw.data[ , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_7.5.1",
                            "count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_7.51", variable)]



raw.data[, ThreshN:= str_match(variable,"_larger_([0-9 .]{2,6})$")[,2]]

#unique(raw.data[, ThreshN])

raw.data[, ThreshN:= as.numeric(ThreshN)]
#unique(raw.data$ThreshN)

raw.data<- ddply(raw.data, .(plateID), transform, isMin= ThreshN == min(ThreshN, na.rm=TRUE))

raw.data<- ddply(raw.data, .(plateID), transform, isMax= ThreshN == max(ThreshN, na.rm=TRUE))

raw.data<- ddply(raw.data, .(plateID), transform, isMiddle= ThreshN != max(ThreshN, na.rm=TRUE) & ThreshN!=min(ThreshN, na.rm=TRUE))


#change variables to consistent names

raw.data<-as.data.table(raw.data)

# as.data.frame(unique(raw.data[, list(plateID,variable, ThreshN, isMin,isMax, isMiddle)]))

raw.data[ isMin ==TRUE  & !grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                        "count_Cyto.2m",variable)]

raw.data[ isMin ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                  "count_Nuclei.2m",variable)]
raw.data[ isMin ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= 
            gsub("count_Nuclei_Intensity_MeanIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                  "count_Nuclei.2m",variable)]

raw.data[ isMiddle ==TRUE  & !grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}",                                                                                   "count_Cyto.3m",variable)]

raw.data[ isMiddle ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                 "count_Nuclei.3m",variable)]
raw.data[ isMiddle ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_MeanIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                 "count_Nuclei.3m",variable)]

raw.data[ isMax ==TRUE  & !grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                     "count_Cyto.m3sd",variable)]

raw.data[ isMax ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                    "count_Nuclei.m3sd",variable)]
raw.data[ isMax ==TRUE  & grepl("count_Nuclei_Intensity",variable) , 
          variable:= gsub("count_Nuclei_Intensity_MeanIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                    "count_Nuclei.m3sd",variable)]

unique(raw.data$variable)


raw.data[, variable:= gsub("count_Cyto", "GFP_pos", variable)]
raw.data[, variable:= gsub("count_Nuclei", "GFP_pos", variable)]

raw.data[, variable:= gsub("Nuclei_TrackObjects_DistanceTraveled_[0-9]{2}",
                       "CellSpeed", variable)]

raw.data[, variable:= gsub("imageCountTracked",
                       "CellNumber", variable)]

# fix more inconsitant variable names  
sort(unique(raw.data$variable))

raw.data[, variable := gsub("_image_GFP", 
                            "_Image_GFP", variable)]

raw.data[, variable := gsub("Image_Count_obj_nc", 
                            "CellNumber", variable)]

raw.data[, variable := gsub("_img_nc", 
                            "_Image_Hoechst", variable)]

raw.data[, variable := gsub("_image_hoechst", 
                            "_Image_Hoechst", variable)]

# remove irrelevant variables;


raw.data <- raw.data[ !variable %in% c( "min_maxNorm_CellNumber", "min_maxNorm_CellSpeed", "min_maxNorm_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP", "min_maxNorm_Nuclei_Intensity_IntegratedIntensity_Image_GFP")]

sort(unique(raw.data$variable))

raw.data[, ThreshN:=NULL]
raw.data[, isMin:=NULL]
raw.data[, isMax:=NULL]
raw.data[, isMiddle:=NULL]



```


plots for quality control (non icam1)  

```{r plotQQ_srxn1_chop_p21}


raw.data[ treatment == "dmso", cmax := "0cmax" ]
raw.data[, cmax := factor(cmax, levels = c("0cmax", "1cmax", "5cmax", "10cmax", "50cmax", "100cmax"))]


# plot time curves, grid the concentrations and treatments, loop over variables
raw.data[, variable_CL := paste0(variable, cell_line)]
fingerprintVarsC <- unique(raw.data[ , variable_CL])
writepdfs <- "../generated/results/nonicam_qqplots/"
if(!file.exists(writepdfs)){
  dir.create(writepdfs)
}

for( i in seq_along(fingerprintVarsC)){

  plotData <- raw.data[ variable_CL %in% fingerprintVarsC[i]]
  p <- ggplot(data =plotData, aes(x= timeAfterExposure, y=value, color = replID)) + facet_grid(treatment~cmax)
  p<-p + geom_point(aes(color=replID, shape = replID)) + geom_line(aes(group=replID, color=replID)) + 
    theme_sharp() + ggtitle( label = fingerprintVarsC[i])
  pdf(file = paste(writepdfs, fingerprintVarsC[i], ".pdf", sep =""), width =12, height = 100)
  print(p)
  dev.off()
}



```

Select plates with full compound sets.
Verify features acros plates/ replicates: each feature of interest should be represented by 2 replicates.   

2013_07_29_Srxn1 : no CO2 - verified by no to little responses compared to other replicates
2013_07_24_Srxn1, 2013_07_10_Srxn1_z1: low compunds amount
````{r selectplates}

unique(raw.data[ order(cell_line, cmax,plateID, replID), list(cell_line, cmax,plateID, replID)])[ cmax != "0cmax",]
# 3 10cmax Srxn1 replicates
# 3 50cmax Srxn1 replicates
# 3 50cmax DDIT3 replicates
rm.plates <- c( "2013_07_10_Srxn1_z1", "2013_07_24_Srxn1", "2013_07_29_Srxn1")

raw.data <- raw.data[ !plateID %in% rm.plates, ]

raw.data[ cell_line == "Srxn1" & (cmax == "100cmax" | cmax == "0cmax") & plateID == "2013_08_01_Srxn1", replID := "replicate_1"]
raw.data[ cell_line == "Srxn1" & (cmax == "100cmax"| cmax == "0cmax") & plateID == "2013_08_14_Srxn1", replID := "replicate_2"]

# check variable names over replicates

countFeats <- unique(raw.data[ order(cell_line, cmax,plateID, replID, variable), list(cell_line, cmax, variable, replID)])

# by summarizing over replID, at least 2 N should appear for each feature of interest;

countFeats[,list(cell_line, cmax, variable)][ ,.N , by = list(cell_line, cmax, variable)][ N < 2,]
# Nuclei_Intensity_IntegratedIntensity_Image_GFP occurs once, remove since nuclei mean intensity is required (and also measured)
raw.data <- raw.data[ !(cell_line == "p21" & cmax == "50cmax" & variable == "Nuclei_Intensity_IntegratedIntensity_Image_GFP")]

 raw.data[ , fingerprints:= variable ]
 raw.data[variable %in% "GFP_pos.m3sd", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "GFP_pos.2m", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "GFP_pos.3m", fingerprints:= paste(variable, cell_line, sep = "_")]
 
 raw.data[variable %in% "Cytoplasm_Intensity_IntegratedIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "Cytoplasm_Intensity_MeanIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "Nuclei_Intensity_IntegratedIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "Nuclei_Intensity_MeanIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]

 unique(raw.data[,fingerprints])

 countFeats <- unique(raw.data[ order(cell_line, cmax,plateID, replID, fingerprints), list(cell_line, cmax, fingerprints, replID)])
countFeats[,list(cell_line, cmax, fingerprints)][ ,.N , by = list(cell_line, cmax, fingerprints)][ N<2]

```


Combine ICAM1 and Srxn1-DDIT3-p21   
```{r combine_sets}

load('../tmp/mean.data.ICAM1.long.Rdata')

raw.data[, variable_CL:=NULL]

unique(mean.data.ICAM1.long[, variable])

mean.data.ICAM1.long[, fingerprints]

dim(raw.data)
dim(mean.data.ICAM1.long)

unique(raw.data[, fingerprints])
# for ICAM1 variables change:
# imageCountTracked -> CellNumber
# obj_nuclei_AreaShape_Area -> Nuclei_AreaShape_Area
# obj_nuclei_TrackObjects_DistanceTraveled -> CellSpeed
# obj_nuclei_Intensity_MeanIntensity_image_hoechst -> Nuclei_Intensity_MeanIntensity_Image_Hoechst
mean.data.ICAM1.long[ , variable := gsub( "imageCountTracked", "CellNumber" , variable) ]
mean.data.ICAM1.long[ , variable := gsub( "obj_nuclei_AreaShape_Area", "Nuclei_AreaShape_Area" , variable) ]
mean.data.ICAM1.long[ , variable := gsub( "obj_nuclei_TrackObjects_DistanceTraveled", "CellSpeed" , variable) ]
mean.data.ICAM1.long[ , variable := gsub( "obj_nuclei_Intensity_MeanIntensity_image_hoechst",
                                          "Nuclei_Intensity_MeanIntensity_Image_Hoechst" , variable) ]


# features to remove from ICAM1 data:
rmICAM1feats <- c("obj_icam1_AreaShape_Area","norm_obj_icam1_Intensity_MeanIntensity_image_GFP" ,
                  "norm_obj_cyto_only_Intensity_MeanIntensity_image_GFP",
                  "backgroundValue.obj_icam1_Intensity_MeanIntensity_image_GFP",
                   "backgroundValue.obj_cyto_only_Intensity_MeanIntensity_image_GFP",
                  "norm_obj_icam1_Intensity_IntegratedIntensity_image_GFP",
                  "norm_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP",
                  "backgroundValue.obj_icam1_Intensity_IntegratedIntensity_image_GFP",
                  "backgroundValue.obj_cyto_only_Intensity_IntegratedIntensity_image_GFP")

mean.data.ICAM1.long <- mean.data.ICAM1.long[ !variable %in% rmICAM1feats, ]

# create fingerprints
notFP <- c("CellNumber", "CellSpeed", "Nuclei_AreaShape_Area", "Nuclei_Intensity_MeanIntensity_Image_Hoechst")
mean.data.ICAM1.long[ , fingerprints := variable]
mean.data.ICAM1.long[ !variable %in% notFP  , fingerprints := paste(variable, cell_line, sep = "_") ]

all.data <- rbind(raw.data, mean.data.ICAM1.long)

```

## Quality control for nonICAM1 & ICAM1 data

compound based quality control: autofluorescence; use compound based intensity distribution & compound based CellNumber & compound based Hoechst intensity

plate based quality control: cell viability per plate, image segmentation; use CellNumber & Nuclei_AreaShape_Area

plate based cell viability: check if cells are dying; use CellNumber, CellSpeed

PI endpoint data:  
several times PI was added after live cell imaging to check for cell viability.  
include PI-end point data for plate-based cell viability  
include PI-end point data for compound-based cell viability  


```{r QQ_plate_based}
# first load the end-point PI data


```


```{r QQ_compound_based}
sort(unique(all.data[, fingerprints]))

```

Normalization of reporter responses by min-max normalization; $$ y = \frac{ x - x_{min} }{x_{max} - x_{min}} $$ , with `x_min` and `x_max` replicate-based. 
This plate normalization is valid if the underlying assumption holds that positive and negative controls exist on each plate and behave similarly on a biological level accros plates.


```{r }
# min-max normalize intensity based data

unique(raw.data[ , fingerprints])
varsToNorm <- c("Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3", "Nuclei_Intensity_MeanIntensity_Image_Hoechst",
                 "Nuclei_Intensity_MeanIntensity_Image_GFP_p21",
                 "Cytoplasm_Intensity_MeanIntensity_Image_GFP_Srxn1", "Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1"
 )


# norFun performs the min max normalization on a per-replID basis, however first DMSO values are subtracted on a per-plate basis to control for plate-specific effects.


normFun <- function(dataIn, normVar) {
   
   buffer <- dataIn[ fingerprints%in% normVar] # select 1 variable
   #subtract DMSO per plate-time followed by min max single plate within replicates
   meanDMSO <-  buffer[ treatment %in% "dmso"  ,  
                        mean(value, na.rm=TRUE),
                        by = c("plateID", "timeID")
                        ]
   
   setkeyv(meanDMSO, c("plateID", "timeID"))
   setkeyv(buffer, c("plateID" ,"timeID"))
   
   buffer<- meanDMSO[buffer]
   buffer[, DMSO_sub.value:= value - V1 ]
   buffer[, value:=NULL]
   buffer[, fingerprints:= paste("mmnDMSO.sub", normVar, sep ="_")]
   buffer[, V1:=NULL]
   
   # min and max per replicate (because plates contain compound set for specific cmax's)
   
   minValue <- buffer[ , min(DMSO_sub.value, na.rm = TRUE), by = replID] 
   maxValue <- buffer[ , max(DMSO_sub.value, na.rm = TRUE), by = replID]
   
   setkey(buffer, "replID")
   setkey(minValue, "replID")
   setkey(maxValue, "replID")
   
   buffer <- buffer[minValue]
   buffer <- buffer[maxValue]
   
   setnames(buffer, "V1", "minValue")
   setnames(buffer, "i.V1", "maxValue")
   
   buffer[, mmnvalue:= (DMSO_sub.value - minValue)/ 
            (maxValue-minValue)]
   
   setnames(buffer, "mmnvalue", "value")
   buffer[, DMSO_sub.value:=NULL]
   buffer[, minValue:=NULL]
   buffer[, maxValue:=NULL]
   output <- buffer
   return(output)  
 }

test <- normFun(raw.data, normVar = "Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1")

pdf('../tmp/testnorm.pdf' , width = 12, height = 100)
p <- ggplot( data = test, aes(timeAfterExposure, value, color = replID)) + geom_point() + facet_grid(treatment ~ cmax)
print(p)
dev.off()

test[value == 1,  ]

# perform min max normalization
mmn.list = list()
 for( i in seq_along(varsToNorm)){
   
   mmn.list[[i]] <- normFun(dataIn = raw.data, normVar = varsToNorm[i] )
 }
 
 mmn.df <- do.call("rbind", mmn.list)
 
 
 head(mmn.df)
 
 nonICAM1reporter.data <- rbind(raw.data, mmn.df)

 save(nonICAM1reporter.data, file = '../tmp/oldreporterdata.Rdata'  )
``` 







## Statistical learning; supervised classification  
`n` compounds X `p` fingerprints
* include lipophilicity value of compounds (based on fda paper)  
* include daily dose of oral medications

* temporal information in the form of time-course derived parameters
* dose response information in the form of EC50 of main feature, lowest response cmax value, lowest response dose- value, max response over dose 
* note: per cmax there is a set of temporal derived parameters. These are all put in a dose-response setting; from these above mentioned values are extracted.

Classes:  
* DILI vs non-DILI  
* DILI vs less-DILI vs severe-sDILI  

Include variables:  
* Time course parameters: max slope, time to 2/3 max, max, ...
* End-point PI
* CellCount
* dose response parameters
* CellSpeed

```{r prediction}


note;Buspirone was eerst less-DILI ambigious, Steven wil no DILI bij MIPDILI is het negative control, alle ambigious op NO-DILI. Probeer noDILI vs lDILI en sDILI, of alle drie, ook de mechanistische groepen.

