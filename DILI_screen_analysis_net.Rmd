---
title: "DILI screen paper"
author: "Steven Wink"
date: "1 december 2016"
output:
  html_document:
    toc: true
    toc_depth: 3

---


### Automated live cell imaging of adaptive stress responses for assessment of drug-induced liver injury (DILI) liabilities.  


```{r session_options}
options(stringsAsFactors = FALSE)
.libPaths("D:/apps/library_3.1.1") 
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Install the required packages to knit this file  
```{r install_required_packages, eval = FALSE, include = FALSE}

required.packages <- c('data.table', 'ggplot2', 'plyr', 'grid', 'splines', 'stats', 'graphics', 'reshape2', 'NMF')
required.package.installed <- sapply(required.packages, require, character.only = TRUE)
if(!all(required.package.installed)) {
  
  install.packages(required.packages[!required.package.installed])
}
if(!require('knitr')) { install.packages('knitr') }
if(!require('rmarkdown')) { install.packages('rmarkdown') }

```

load required packages  
```{r load_packages}

require(data.table)
require(ggplot2)
require(plyr)
require(grid)
require(splines)
require(stats)
require(graphics)
require(reshape2)
require(NMF)

```

Script sourcing   
```{r script_sourcing}

source("theme_sharp.R")

```


## summary analysis preceding this data-analysis document  
All image analysis was performed using CellProfiler version 2.0.  
The in house created H5CellProfiler R package was used to extract, format and summarize the HDF5 file data generated by CellProfiler according to the following protocol;
* filter by nuclei area: 10 pixels for 1X zoom & 40 pixels for 2X zoom to remove segmented noise.
* determine `2X background value`, `3X background value` and `mean + 3X sd neg. control values` of main cell line specific measurement by `treatment`, `dose_uM: 0.2% (0.002)` of the DMSO control treatments  
* count cells above this threshold values and determine `GFP positive fraction` for the 3 background values.  
* calculate by `treatment`, `plateID`, `dose_uM`, `timeID`, `timeAfterExposure`, `control`, `cell_line`
of  `Nuclei_AreaShape_Area`, `imageCountTracked`, `cytoplasm_intensity_int_int`, `cytoplasm_intensity_mean_int`,
`nuclei_hoechst_int` , `distance traveled` the cell count and main features.  
* save summary data file  


## ICAM1 summarization   
ICAM1 data requires a different treatment as the response is bi-directional. The summary statistics for ICAM1 is performed in this script instead of in the GUI of H5CellProfiler package.     

There are two sets of ICAM1 data, the first set is from the DILI compound screen, the second set is a smaller screen of which the majority of compounds are the same as in the first set but with different selected cmax-values. THere is ambiguouty regarding c-cmax values in literature, the change in the cmax values for the second screen is based on the wishes from the MIP-DILI consortium.   
There is a distinct difference in the screening procedure between the full screen and the second subset (new-cmax) screen. In the first screen the full compound set was pipetted on plates, with different concentrations on a plate to plate basis. In the second, new-cmax screen, all compounds including dose range fit onto a single plate, therefore multiple plates only correspond to replicates.  


```{r load_single_cell_ICAM1}
ICAM.path <- "../data/Rdata files ICAM1/"
ICAM.files <- dir(ICAM.path)[grepl(".Rdata", dir(ICAM.path) )]
ICAM.raw =list()
for(i in seq_along(ICAM.files)) 
{
print(i)
    load(paste(ICAM.path, ICAM.files[i], sep ="/"))
  ICAM.raw[[i]] <- outputList
ICAM.raw[[i]] <- outputList
ICAM.raw[[i]]$myDT$set <- "oldcmax"
  rm("outputList")
  }


```

Load single cell ICAM1 new cmax data

```{r load_single_cell_ICAM1_newcmax}
ICAM.path <- "../data/Rdata files ICAM1/newcmaxdata/"
ICAM.files <- dir(ICAM.path)[grepl(".Rdata", dir(ICAM.path) )]
k <- length(ICAM.raw)

for(i in seq_along(ICAM.files)) 
{
print(i+k)
    load(paste(ICAM.path, ICAM.files[i], sep ="/"))
  ICAM.raw[[k+i]] <- outputList
  ICAM.raw[[k+i]]$myDT$set <- "newcmax"
rm("outputList")
  }

```


fix column names 

```{r fix_column_names}

#img -> image
#obj_cytoplasm_  -> obj_cyto_only_  
#obj_nuclei_Children_obj_icam1_Count -> obj_cells_Children_obj_icam1_Count
#obj_nuclei_Number_Object_Number -> obj_cells_Number_Object_Number

for(i in seq_along(ICAM.raw)) {
  colnames(ICAM.raw[[i]]$myDT) <- gsub("DistanceTraveled_[0-9]{2}", "DistanceTraveled", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("TrackObjects_Label_[0-9]{2}", "TrackObjects_Label", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("TrackObjects_ParentObjectNumber_[0-9]{2}", "TrackObjects_ParentObjectNumber", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("img", "image", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_cytoplasm_", "obj_cyto_only_", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_nuclei_Children_obj_icam1_Count", "obj_cells_Children_obj_icam1_Count", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_nuclei_Number_Object_Number", "obj_cells_Number_Object_Number", colnames(ICAM.raw[[i]]$myDT))
  }

```



One plate was kept on the microscope too long, another crashed half way. These errors are handled here;  

```{r data_cleaning }
# remove for plate 20150608 - 10cMax_wells  time points:
#25.8 27.2 28.6 30.0 31.4 32.8 34.2 35.6 37.0 38.4 
 lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 , "plateID"),  '[' )
ICAM.raw[[4]]$myDT$plateID[1]


dim(ICAM.raw[[4]]$myDT)
ICAM.raw[[4]]$myDT[, timeAfterExposure := as.numeric(timeAfterExposure)]
ICAM.raw[[4]]$myDT <- ICAM.raw[[4]]$myDT[ !( plateID %in% "20150608 - 10cMax_wells" &
                            timeAfterExposure %in% as.numeric( c(25.8, 27.2, 28.6, 30.0, 31.4, 32.8, 34.2, 35.6, 37.0, 38.4))) ,]

# De plaat met SRXN1 en ICAM1 van 0930 op 1001 is gecrashed na 5 uur en 45 minuten. 
# Het eerste experiment (dus alles in map 0930)  was 's middags gestart om 16:55
# Het experiment is herstart om 9:02
# Het tweede deel (dus alles in map 1001) duurt nog 7 uur. Tijdpunten zijn elke 1 uur en 35 minuten. 

# dus 5:45 --> gecrasht om 16:55 + 5u45 min = 22:40 gecrasht. Start 10:20 later

unique((ICAM.raw[[13]]$myDT[, timeID])) 
#change plateID
ICAM.raw[[13]]$myDT[, plateID:="20150930_ICAM1"]
#modify time


timeBetweenFrames <- "01:35:00"
exposureDelay <- "16:05"

timeBetweenFrames <- round(as.integer(strftime(strptime(timeBetweenFrames, format = "%H:%M:%S"), "%H")) + 
                             1/60 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                 format = "%H:%M:%S"), "%M")) +
                             1/3600 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                   format = "%H:%M:%S"), "%S"))
                           , digit =2 )

exposureDelay <- round(as.integer(strftime(strptime(exposureDelay, format = "%H:%M"), "%H")) + 
                         1/60 * as.integer(strftime(strptime(exposureDelay, 
                                                             format = "%H:%M"), "%M")), digit =1 )
ICAM.raw[[13]]$myDT[, timeAfterExposure:=round(as.numeric(timeID)*timeBetweenFrames+exposureDelay - timeBetweenFrames, digits = 1) ]
unique((ICAM.raw[[13]]$myDT[, timeAfterExposure])) 
unique((ICAM.raw[[13]]$myDT[, timeID])) 
((ICAM.raw[[13]]$myDT[, timeID:=as.numeric(timeID)+4])) 

#combine:
object.size(ICAM.raw[[12]]$myDT) #126677216 bytes
object.size(ICAM.raw[[13]]$myDT) #166096056 bytes
nrow(ICAM.raw[[12]]$myDT) #673454
nrow(ICAM.raw[[13]]$myDT) #864733

ICAM.raw[[12]]$myDT <- rbind(ICAM.raw[[12]]$myDT, ICAM.raw[[13]]$myDT)
object.size(ICAM.raw[[12]]$myDT)  #276963688 bytes
nrow(ICAM.raw[[12]]$myDT)  #1538187
#673454+864733 = 1538187
ICAM.raw[[13]] <- NULL
unique(ICAM.raw[[12]]$myDT[, timeAfterExposure])

ICAM.raw[[12]]$myDT[ treatment%in%"DMSO" & as.numeric(as.character(dose_uM)) <= 0.2]


``` 




Determine DMSO background levels and use these threshold values to count GFP positive cells for the ICAM1 single cell data   
Procedure:
* calculate for each plate for each time points the cell population mean for DMSO <= 0.02  `meanDMSO`  
* subtract these background values plate and time point wise  `norm`  
* calculate threshold values based on raw background values for each plate from cell population mean of GFP levels of DMSO dose <=0.2 of timepoint 1 & 2.
* count cells above and below 2X, 3X and mean + 3DS these plate specific threshold values  

```{r count_ICAM1 }

all.columns <- lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 ), colnames )
lapply(all.columns, length)
all.columns[4:5] # some tables have "replID" extra

# remove replID columns

for( i in seq_along(ICAM.raw)) {
  if(!is.null(ICAM.raw[[i]]$myDT$replID)){
  ICAM.raw[[i]]$myDT$replID <- NULL
  }
}
all.columns <- lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 ), colnames )
all(sapply(all.columns, FUN = `%in%`, all.columns[[1]]))

# columns of interest for counting cells
TH.cols <- colnames(ICAM.raw[[1]]$myDT)[c(16, 17, 18, 19 )]
TH.cols

#calculate mean of DMSO for <= 0.2 concentration for each time point
mean.dmso.colnames <- paste("meanDMSO_", TH.cols, sep="")

meanDMSO = list()
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  ICAM.raw[[i]]$myDT[, dose_uM:= as.numeric(as.character(ICAM.raw[[i]]$myDT[, dose_uM]))]# change factor to numeric of dose 
    meanDMSO[[i]] <-  ICAM.raw[[i]]$myDT[ treatment %in% "DMSO" & dose_uM <= 0.2 ,  
                                                               lapply(.SD, function(x) { mean(x, na.rm=TRUE) }),
                                                               by = c("plateID",   "timeID"),
                                                               .SDcols =
                                                                 TH.cols
                                                               ]
    setnames(meanDMSO[[i]], old = TH.cols, new = mean.dmso.colnames)
    
    setkeyv(ICAM.raw[[i]]$myDT, c("plateID", "timeID"))
    setkeyv(meanDMSO[[i]], c("plateID", "timeID"))
    
    ICAM.raw[[i]]$myDT <- ICAM.raw[[i]]$myDT[meanDMSO[[i]]]
    
          }

# subtract these DMSO background values values

normCols <- paste("norm", TH.cols, sep ="_")

for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
 
  for(j in seq_along(normCols)) {
    print(j)
    print(normCols[j])
    print(TH.cols[j])
    print(mean.dmso.colnames[j])
    
       ICAM.raw[[i]]$myDT[, normCols[j]:= (get(TH.cols[j]) - get(mean.dmso.colnames[j]) ) ] # norm cols as the values = DMSO averages 
  }
}

TH.cols.mean <- paste("backgroundValue.",TH.cols ,sep = "") # column names for background values  
mean1above <- paste( "mean1above", TH.cols, sep ="_")
mean2above <- paste( "mean2above", TH.cols, sep ="_")
mean3above <- paste( "mean3above", TH.cols, sep ="_")
mean1below <- paste( "mean1below", TH.cols, sep ="_")
mean2below <- paste( "mean2below", TH.cols, sep ="_")
mean3below <- paste( "mean3below", TH.cols, sep ="_")

# count cells above and below background of DMSO time points 1 & 2: more stable than only 1 timepoint
#remove redundent data to save some memory

rmCols <- c("imageNumber", "plateWellID", "groupNumber","imageID","plateWellID",
            "meanDMSO_obj_icam1_Intensity_IntegratedIntensity_image_GFP","meanDMSO_obj_icam1_Intensity_MeanIntensity_image_GFP",
            "meanDMSO_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP","meanDMSO_obj_cyto_only_Intensity_MeanIntensity_image_GFP")
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  for(j in seq_along(rmCols)){
  ICAM.raw[[i]]$myDT[, rmCols[j]:= NULL ]
  }
}
gc()
# count norm cols above and below thresholds. Theshold is determined from raw data of first two time points from DMSO dose <= 0.2

for(i in seq_along(ICAM.raw)) {
 print(paste("i: ", i ))
# a fancy way to use a mean of a subset and populate a list of columns with these means entirely (usually I would use a merge)
  ICAM.raw[[i]][["myDT"]][, get(
    "TH.cols.mean"):= list(mean(get(TH.cols[1])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE), 
                           mean(get(TH.cols[2])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE),
                           mean(get(TH.cols[3])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE),
                           mean(get(TH.cols[4])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE))]

  for(j in seq_along(normCols)) { # dus aantal cellen die boven achtergrond uitsteken nadat achtergrond er al af is gehaald
    print(j) 
  # normcol is 1 achtergrond waarde reeds afgehaald. dus -1 aan rechter kant gedaan
    ICAM.raw[[i]]$myDT[, mean1above[j]:= ((get(normCols[j])) >= (0.5*get(TH.cols.mean[j]))  )] 
    ICAM.raw[[i]]$myDT[, mean2above[j]:= ((get(normCols[j])) >= (1*get(TH.cols.mean[j]))  )] 
    ICAM.raw[[i]]$myDT[, mean3above[j]:= ((get(normCols[j])) >= (2*get(TH.cols.mean[j])) )] 
    ICAM.raw[[i]]$myDT[, mean1below[j]:= ((get(normCols[j])) <= (-0.5*get(TH.cols.mean[j]) ) )] 
    ICAM.raw[[i]]$myDT[, mean2below[j]:= ((get(normCols[j])) <= (-1*get(TH.cols.mean[j]))  )] 
    ICAM.raw[[i]]$myDT[, mean3below[j]:= ((get(normCols[j])) <= (-2*get(TH.cols.mean[j]) ) )] 
    
  }
}


```








Calculate mean of ICAM1 single cell data

```{r mean_ICAM1_oldcmax}
# calculate mean

all.icam.feats<-c("imageCountTracked", "obj_icam1_AreaShape_Area",
             "obj_icam1_Intensity_IntegratedIntensity_image_GFP","obj_icam1_Intensity_MeanIntensity_image_GFP",
             "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP","obj_cyto_only_Intensity_MeanIntensity_image_GFP",
             "obj_nuclei_AreaShape_Area","obj_nuclei_Intensity_MeanIntensity_image_hoechst",
             "obj_nuclei_TrackObjects_DistanceTraveled", 
             normCols,
             TH.cols.mean, mean1above, mean2above, mean3above, mean1below, mean2below, mean3below
             
)

mean.data.ICAM1= list()

all.icam.feats[ !all.icam.feats%in% colnames(ICAM.raw[[2]]$myDT)] # check if column names correct now

#calculate mean, however what about NA values? no problem I think: mean(c(NA,NA,NA,1,0),na.rm=TRUE) = 0.5 (with regard to fraction GFP positive...)
for(i in seq_along(ICAM.raw)){
print(i)
    mean.data.ICAM1[[i]] <-  ICAM.raw[[i]]$myDT[ , lapply(.SD, function(x) { mean(x, na.rm=TRUE) }),
                                            by = c("treatment", "dose_uM", "cell_line", "plateID", "timeID", "timeAfterExposure"),
                                  .SDcols = all.icam.feats
                            ]
  }



```













```{r}





## Summary data Srxn1, Chop, p21

load summary data files from H5CellProfiler output for cell lines p21 srxn1 & chop  

```{r load_summary_data_files}

path.to.nonICAM <- "../data/Summary data files"
raw.data =list()
dir.files <- dir(path.to.nonICAM)
dir.files <- dir.files[grepl("(Summary Data)", dir.files)]

for (i in seq_along(dir.files)){
  raw.data[[i]] <- read.table(file = paste(path.to.nonICAM, dir.files[i], sep ="/"), header = TRUE, sep ="\t")
}
head(raw.data[[1]])

# first 3 no timeAfterExposure
# 2013-07-10 1.2  0.8
# 2013-07-24 1.076 tr  40min del
# 2013-07-29  59 min  20 min

```





## Statistical learning; supervised classification  
* DILI vs non-DILI  
* DILI vs less-DILI vs severe-sDILI  
* 


note;Buspirone was eerst less-DILI ambigious, Steven wil no DILI bij MIPDILI is het negative control, alle ambigious op NO-DILI. Probeer noDILI vs lDILI en sDILI, of alle drie, ook de mechanistische groepen.

