---
title: "DILI screen paper"
author: "Steven Wink"
date: "1 december 2016"
output:
  html_document:
    toc: true
    toc_depth: 3

---


### Automated live cell imaging of adaptive stress responses for assessment of drug-induced liver injury (DILI) liabilities.  


```{r session_options}
options(stringsAsFactors = FALSE)

```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Install the required packages to knit this file  
```{r install_required_packages, eval = FALSE, include = FALSE}

required.packages <- c('data.table', 'ggplot2', 'plyr', 'grid', 'splines', 'stats', 'graphics', 'reshape2', 'NMF', "stringr")
required.package.installed <- sapply(required.packages, require, character.only = TRUE)
if(!all(required.package.installed)) {
  
  install.packages(required.packages[!required.package.installed])
}
if(!require('knitr')) { install.packages('knitr') }
if(!require('rmarkdown')) { install.packages('rmarkdown') }

```

load required packages  
```{r load_packages}
update.packages(lib.loc=.libPaths()[1])
require(data.table)
require(ggplot2)
require(plyr)
require(grid)
require(splines)
require(stats)
require(graphics)
require(reshape2)
require(NMF)
require(stringr)

```

Script sourcing   
```{r script_sourcing}

source("theme_sharp.R")

```


## summary analysis preceding this data-analysis document  
All image analysis was performed using CellProfiler version 2.0.  
The in house created H5CellProfiler R package was used to extract, format and summarize the HDF5 file data generated by CellProfiler according to the following protocol;
* filter by nuclei area: 10 pixels for 1X zoom & 40 pixels for 2X zoom to remove segmented noise.
* determine `2X background value`, `3X background value` and `mean + 3X sd neg. control values` of main cell line specific measurement by `treatment`, `dose_uM: 0.2% (0.002)` of the DMSO control treatments  
* count cells above this threshold values and determine `GFP positive fraction` for the 3 background values.  
* calculate by `treatment`, `plateID`, `dose_uM`, `timeID`, `timeAfterExposure`, `control`, `cell_line`
of  `Nuclei_AreaShape_Area`, `imageCountTracked`, `cytoplasm_intensity_int_int`, `cytoplasm_intensity_mean_int`,
`nuclei_hoechst_int` , `distance traveled` the cell count and main features.  
* save summary data file  


## ICAM1 summarization   
ICAM1 data requires a different treatment as the response is bi-directional. The summary statistics for ICAM1 is performed in this script instead of in the GUI of H5CellProfiler package.     

There are two sets of ICAM1 data, the first set is from the DILI compound screen, the second set is a smaller screen of which the majority of compounds are the same as in the first set but with different selected cmax-values. THere is ambiguouty regarding c-cmax values in literature, the change in the cmax values for the second screen is based on the wishes from the MIP-DILI consortium.   
There is a distinct difference in the screening procedure between the full screen and the second subset (new-cmax) screen. In the first screen the full compound set was pipetted on plates, with different concentrations on a plate to plate basis. In the second, new-cmax screen, all compounds including dose range fit onto a single plate, therefore multiple plates only correspond to replicates.  


```{r load_single_cell_ICAM1}
ICAM.path <- "../data/Rdata files ICAM1/"
ICAM.files <- dir(ICAM.path)[grepl(".Rdata", dir(ICAM.path) )]
ICAM.raw =list()

for(i in seq_along(ICAM.files)) 
{
print(i)
    load(paste(ICAM.path, ICAM.files[i], sep ="/"))
  ICAM.raw[[i]] <- outputList
ICAM.raw[[i]] <- outputList
ICAM.raw[[i]]$myDT$set <- "oldcmax"
  rm("outputList")
}


```

Load single cell ICAM1 new cmax data

```{r load_single_cell_ICAM1_newcmax}
ICAM.path <- "../data/Rdata files ICAM1/newcmaxdata/"
ICAM.files <- dir(ICAM.path)[grepl(".Rdata", dir(ICAM.path) )]
k <- length(ICAM.raw)

for(i in seq_along(ICAM.files)) 
{
print(i+k)
    load(paste(ICAM.path, ICAM.files[i], sep ="/"))
  ICAM.raw[[k+i]] <- outputList
  ICAM.raw[[k+i]]$myDT$set <- "newcmax"
rm("outputList")
  }

```


fix column names 

```{r fix_column_names}

#img -> image
#obj_cytoplasm_  -> obj_cyto_only_  
#obj_nuclei_Children_obj_icam1_Count -> obj_cells_Children_obj_icam1_Count
#obj_nuclei_Number_Object_Number -> obj_cells_Number_Object_Number

for(i in seq_along(ICAM.raw)) {
  colnames(ICAM.raw[[i]]$myDT) <- gsub("DistanceTraveled_[0-9]{2}", "DistanceTraveled", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("TrackObjects_Label_[0-9]{2}", "TrackObjects_Label", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("TrackObjects_ParentObjectNumber_[0-9]{2}", "TrackObjects_ParentObjectNumber", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("img", "image", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_cytoplasm_", "obj_cyto_only_", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_nuclei_Children_obj_icam1_Count", "obj_cells_Children_obj_icam1_Count", colnames(ICAM.raw[[i]]$myDT))
  colnames(ICAM.raw[[i]]$myDT) <- gsub("obj_nuclei_Number_Object_Number", "obj_cells_Number_Object_Number", colnames(ICAM.raw[[i]]$myDT))
  }

```



One plate was kept on the microscope too long, another crashed half way. These errors are handled here;  

```{r data_cleaning }
# remove for plate 20150608 - 10cMax_wells  time points:
#25.8 27.2 28.6 30.0 31.4 32.8 34.2 35.6 37.0 38.4 
 lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 , "plateID"),  '[' )
ICAM.raw[[4]]$myDT$plateID[1]


dim(ICAM.raw[[4]]$myDT)
ICAM.raw[[4]]$myDT[, timeAfterExposure := as.numeric(as.character(timeAfterExposure))]

ICAM.raw[[4]]$myDT <- ICAM.raw[[4]]$myDT[ !( plateID %in% "20150608 - 10cMax_wells" &
                            timeAfterExposure %in% as.numeric( c(25.8, 27.2, 28.6, 30.0, 31.4, 32.8, 34.2, 35.6, 37.0, 38.4))) ,]

unique(ICAM.raw[[4]]$myDT$timeAfterExposure)
# De plaat met SRXN1 en ICAM1 van 0930 op 1001 is gecrashed na 5 uur en 45 minuten. 
# Het eerste experiment (dus alles in map 0930)  was 's middags gestart om 16:55
# Het experiment is herstart om 9:02
# Het tweede deel (dus alles in map 1001) duurt nog 7 uur. Tijdpunten zijn elke 1 uur en 35 minuten. 

# dus 5:45 --> gecrasht om 16:55 + 5u45 min = 22:40 gecrasht. Start 10:20 later

unique((ICAM.raw[[13]]$myDT[, timeID])) 
#change plateID
ICAM.raw[[13]]$myDT[, plateID:="20150930_ICAM1"]
#modify time


timeBetweenFrames <- "01:35:00"
exposureDelay <- "16:05"

timeBetweenFrames <- round(as.integer(strftime(strptime(timeBetweenFrames, format = "%H:%M:%S"), "%H")) + 
                             1/60 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                 format = "%H:%M:%S"), "%M")) +
                             1/3600 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                   format = "%H:%M:%S"), "%S"))
                           , digit =2 )

exposureDelay <- round(as.integer(strftime(strptime(exposureDelay, format = "%H:%M"), "%H")) + 
                         1/60 * as.integer(strftime(strptime(exposureDelay, 
                                                             format = "%H:%M"), "%M")), digit =1 )
ICAM.raw[[13]]$myDT[, timeAfterExposure:=round(as.numeric(timeID)*timeBetweenFrames+exposureDelay - timeBetweenFrames, digits = 1) ]
unique((ICAM.raw[[13]]$myDT[, timeAfterExposure])) 
unique((ICAM.raw[[13]]$myDT[, timeID])) 
((ICAM.raw[[13]]$myDT[, timeID:=as.numeric(timeID)+4])) 

#combine:
object.size(ICAM.raw[[12]]$myDT) #126677216 bytes
object.size(ICAM.raw[[13]]$myDT) #166096056 bytes
nrow(ICAM.raw[[12]]$myDT) #673454
nrow(ICAM.raw[[13]]$myDT) #864733

ICAM.raw[[12]]$myDT <- rbind(ICAM.raw[[12]]$myDT, ICAM.raw[[13]]$myDT)
object.size(ICAM.raw[[12]]$myDT)  #276963688 bytes
nrow(ICAM.raw[[12]]$myDT)  #1538187
#673454+864733 = 1538187
ICAM.raw[[13]] <- NULL
unique(ICAM.raw[[12]]$myDT[, timeAfterExposure])

ICAM.raw[[12]]$myDT[ treatment%in%"DMSO" & as.numeric(as.character(dose_uM)) <= 0.2]


``` 



old;
Determine DMSO background levels and use these threshold values to count GFP positive cells for the ICAM1 single cell data   
Procedure:
* calculate for each plate for each time points the cell population mean for DMSO <= 0.02  `meanDMSO`  
* subtract these background values plate and time point wise  `norm`  
* calculate threshold values based on raw background values for each plate from cell population mean of GFP levels of DMSO dose <=0.2 of timepoint 1 & 2.
* count cells above and below 2X, 3X and mean + 3DS these plate specific threshold values  



new;
same threshold calculations based on first 2 tp of DMSO; however no subtraction of mean DMSO - use the time curve +/- the TH value to count cells.

# first check the distribution of the DMSO single cell intensity data

```{r count_ICAM1 }

all.columns <- lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 ), colnames )
lapply(all.columns, length)
all.columns[4:5] # some tables have "replID" extra

# remove replID columns

for( i in seq_along(ICAM.raw)) {
  if(!is.null(ICAM.raw[[i]]$myDT$replID)){
  ICAM.raw[[i]]$myDT$replID <- NULL
  }
}
all.columns <- lapply( lapply( sapply( ICAM.raw, '[', 1), '[', 1 ), colnames )
all(sapply(all.columns, FUN = `%in%`, all.columns[[1]])) # do all datasets contain the same set of columns?

# columns of interest for counting cells
TH.cols <- colnames(ICAM.raw[[1]]$myDT)[c(16, 17, 18, 19 )]
TH.cols

#calculate mean of DMSO for <= 0.2 concentration for each time point
mean.dmso.colnames <- paste("meanDMSO_", TH.cols, sep="")

plot(density(ICAM.raw[[1]]$myDT[ treatment == "DMSO" & cell_line == "ICAM1" & timeID != 1, obj_cyto_only_Intensity_IntegratedIntensity_image_GFP]))

meanDMSO = list()
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  ICAM.raw[[i]]$myDT[, dose_uM:= as.numeric(as.character(ICAM.raw[[i]]$myDT[, dose_uM]))]# change factor to numeric of dose 
    meanDMSO[[i]] <-  ICAM.raw[[i]]$myDT[ treatment %in% "DMSO" & dose_uM <= 0.2 ,  
                                                               lapply(.SD, function(x) { median(x, na.rm=TRUE) }),
                                                               by = c("plateID",   "timeID"),
                                                               .SDcols =
                                                                 TH.cols
                                                               ]
    setnames(meanDMSO[[i]], old = TH.cols, new = mean.dmso.colnames)
    
    setkeyv(ICAM.raw[[i]]$myDT, c("plateID", "timeID"))
    setkeyv(meanDMSO[[i]], c("plateID", "timeID"))
    
    ICAM.raw[[i]]$myDT <- ICAM.raw[[i]]$myDT[meanDMSO[[i]]]
    
          }

# subtract these DMSO background values values

# ICAM.raw[[i]]$myDT
# 
# normCols <- paste("norm", TH.cols, sep ="_")
# 
# for(i in seq_along(ICAM.raw)) {
#   print(paste("i: ", i ))
#  
#   for(j in seq_along(normCols)) {
#     print(j)
#     print(normCols[j])
#     print(TH.cols[j])
#     print(mean.dmso.colnames[j])
#     
#        ICAM.raw[[i]]$myDT[, normCols[j]:= (get(TH.cols[j]) - get(mean.dmso.colnames[j]) ) ] # norm cols as the values = DMSO averages 
#   }
# }

TH.cols.mean <- paste("backgroundValue.",TH.cols ,sep = "") # column names for background values  
mean1above <- paste( "mean1above", TH.cols, sep ="_")
mean2above <- paste( "mean2above", TH.cols, sep ="_")
mean3above <- paste( "mean3above", TH.cols, sep ="_")
mean1below <- paste( "mean1below", TH.cols, sep ="_")
mean2below <- paste( "mean2below", TH.cols, sep ="_")
mean3below <- paste( "mean3below", TH.cols, sep ="_")




rmCols <- c("imageNumber", "plateWellID", "groupNumber","imageID","plateWellID"
            )
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  for(j in seq_along(rmCols)){
  ICAM.raw[[i]]$myDT[, rmCols[j]:= NULL ]
  }
}
gc()

# count cells above and below background of DMSO time points 1 & 2: more stable than only 1 timepoint
#remove redundent data to save some memory


# iqr

for(i in seq_along(ICAM.raw)) {
 print(paste("i: ", i ))
# a fancy way to use a mean of a subset and populate a list of columns with these means entirely (usually I would use a merge)
  ICAM.raw[[i]][["myDT"]][, get(
    "TH.cols.mean"):= list(IQR(get(TH.cols[1])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE), 
                           IQR(get(TH.cols[2])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE),
                           IQR(get(TH.cols[3])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE),
                           IQR(get(TH.cols[4])[treatment %in% "DMSO" & dose_uM <= 0.2 & timeID %in% c(1,2)], na.rm = TRUE))]

  for(j in seq_along(TH.cols)) { # dus aantal cellen die boven achtergrond uitsteken nadat achtergrond er al af is gehaald
    print(j) 
  # oud; normcol is 1 achtergrond waarde reeds afgehaald. dus -1 aan rechter kant gedaan
    ## nieuw: is cell int groter / kleiner dan DMSO per tijdpunt gem
    ICAM.raw[[i]]$myDT[, mean1above[j]:= ((get(TH.cols[j])) >= ( get(mean.dmso.colnames[j]) + (0.5*get(TH.cols.mean[j]))  ))] 
    ICAM.raw[[i]]$myDT[, mean2above[j]:= ((get(TH.cols[j])) >= ( get(mean.dmso.colnames[j]) + (1*get(TH.cols.mean[j]))  ))] 
    ICAM.raw[[i]]$myDT[, mean3above[j]:= ((get(TH.cols[j])) >= ( get(mean.dmso.colnames[j]) + (2*get(TH.cols.mean[j])) ))] 
    ICAM.raw[[i]]$myDT[, mean1below[j]:= ((get(TH.cols[j])) <= ( get(mean.dmso.colnames[j]) + (-0.5*get(TH.cols.mean[j]) ) ))] 
    ICAM.raw[[i]]$myDT[, mean2below[j]:= ((get(TH.cols[j])) <= ( get(mean.dmso.colnames[j]) + (-1*get(TH.cols.mean[j]))  ))] 
    ICAM.raw[[i]]$myDT[, mean3below[j]:= ((get(TH.cols[j])) <= ( get(mean.dmso.colnames[j]) + (-2*get(TH.cols.mean[j]) ) ))] 
    
  }
}


#rmCols <- c("meanDMSO_obj_icam1_Intensity_IntegratedIntensity_image_GFP","meanDMSO_obj_icam1_Intensity_MeanIntensity_image_GFP",
 #           "meanDMSO_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP","meanDMSO_obj_cyto_only_Intensity_MeanIntensity_image_GFP")
for(i in seq_along(ICAM.raw)) {
  print(paste("i: ", i ))
  for(j in seq_along(rmCols)){
  ICAM.raw[[i]]$myDT[, rmCols[j]:= NULL ]
  }
}
gc()





```




Calculate cell population means of ICAM1 single cell data for selected sets of features, mean based on levels;  
`"treatment", "dose_uM", "cell_line", "plateID", "timeID", "timeAfterExposure"`

```{r mean_ICAM1_oldcmax}
# calculate cell population means

all.icam.feats<-c("imageCountTracked", "obj_icam1_AreaShape_Area",
             "obj_icam1_Intensity_IntegratedIntensity_image_GFP","obj_icam1_Intensity_MeanIntensity_image_GFP",
             "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP","obj_cyto_only_Intensity_MeanIntensity_image_GFP",
             "obj_nuclei_AreaShape_Area","obj_nuclei_Intensity_MeanIntensity_image_hoechst",
             "obj_nuclei_TrackObjects_DistanceTraveled", 
             
             TH.cols.mean, mean1above, mean2above, mean3above, mean1below, mean2below, mean3below
             
)

mean.data.ICAM1= list()

all.icam.feats[ !all.icam.feats%in% colnames(ICAM.raw[[2]]$myDT)] # check if column names correct now

#calculate mean of TRUE/FALSE to get to fractions, however what about NA values? no problem I think: mean(c(NA,NA,NA,1,0),na.rm=TRUE) = 0.5 (with regard to fraction GFP positive...)
for(i in seq_along(ICAM.raw)){
print(i)
    mean.data.ICAM1[[i]] <-  ICAM.raw[[i]]$myDT[ , lapply(.SD, function(x) { mean(x, na.rm=TRUE) }),
                                            by = c("treatment", "dose_uM", "cell_line", "plateID", "timeID", "timeAfterExposure"),
                                  .SDcols = all.icam.feats
                            ]
  }

mean.data.ICAM1

```

ICAM1: save single cell data & and remove from memory

```{r save_singlecell_ICAM1}

colnames(ICAM.raw[[1]]$myDT)
plot(density(ICAM.raw[[1]]$myDT[ treatment == "DMSO" & cell_line == "ICAM1" & timeID != 1, as.numeric(mean1below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP)]))


save( ICAM.raw, file = "../generated/ICAM.raw.Rdata")

rm("ICAM.raw")
gc()

save( mean.data.ICAM1, file = "../tmp/mean.data.ICAM1.Rdata") # save to revert in case of error
mean.data.ICAM1
colnames(mean.data.ICAM1)

mean.data.ICAM1 <- do.call('rbind', mean.data.ICAM1)

test <- mean.data.ICAM1[ , list(treatment, dose_uM, cell_line , plateID, timeID, mean2above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP, mean2below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP,
                                backgroundValue.obj_cyto_only_Intensity_IntegratedIntensity_image_GFP) ]



test[ , test_2_fraction := mean2above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP - mean2below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP ]
test <- test[ treatment == "DMSO" & cell_line == "ICAM1"]
ggplot( data = test , aes(x =timeID, y = test_2_fraction )) + geom_point(aes(color = plateID)) 

mean2above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP
mean2below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP

meanDMSO_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP
backgroundValue.obj_cyto_only_Intensity_IntegratedIntensity_image_GFP



```

Clean ICAM1 summary data  
* replace new cmax compounds
* fix some errors originating from original layout files
* add cmax identifier  

```{r clean_ICAM1_summarydata }
#rm(list=ls())
#load("../tmp/mean.data.ICAM1.Rdata")
#mean.data.ICAM1 <- do.call('rbind', mean.data.ICAM1)
mean.data.ICAM1[, treatment := tolower(treatment)]
#Carmustine 0.037 ipv 0.356

mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 0.356, dose_uM:= 0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 1.78, dose_uM:= 5*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 3.56, dose_uM:= 10*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 8.90, dose_uM:= 25*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 17.80, dose_uM:= 50*0.037]
mean.data.ICAM1[ treatment%in% "carmustine" & dose_uM %in% 35.60, dose_uM:= 100*0.037]

#new cmax have changed and 1 extra
#1
#5
#10
#25 <-- new (remove for this screen, as only small subset of compounds are tested at 25cmax)
#50
#100


# replace old cmax for new.
# plates with newCmax concentrations: 20150923_ICAM1 & 20150930_ICAM1

newcmaxPlates <- mean.data.ICAM1[ plateID %in% c("20150923_ICAM1", "20150930_ICAM1" )]
mean.data.ICAM1 <- mean.data.ICAM1[ !plateID %in% c("20150923_ICAM1", "20150930_ICAM1" )]
newcmaxcomps <- unique(newcmaxPlates[, treatment])
newcmaxcomps <- newcmaxcomps[ newcmaxcomps != "dmso"]
newCmax <- as.data.table(
  read.delim(file = "../metadata/newCmax.txt", sep = "\t", header = TRUE)) # load 1cmax concentrations of new cmax compound set 
newCmax$treatment <- tolower(newCmax$treatment)
cbind(sort(newCmax$treatment), sort(newcmaxcomps), sort(newCmax$treatment) == sort(newcmaxcomps))

all(newcmaxcomps %in% unique(mean.data.ICAM1$treatment))

mean.data.ICAM1 <- mean.data.ICAM1[!treatment %in% newcmaxcomps]

# add cmax annotation for all compounds, plate identifiers can be used for old cmax, new cmax an annotation file is used.
# add cmax identifiers  
unique(mean.data.ICAM1[, plateID])
mean.data.ICAM1[ grepl("- 1cMax", plateID), cmax := 1]
mean.data.ICAM1[ grepl("- 5cMax", plateID), cmax := 5]
mean.data.ICAM1[ grepl("- 10cMax", plateID), cmax := 10]
mean.data.ICAM1[ grepl("- 50cMax", plateID), cmax := 50]
mean.data.ICAM1[ grepl("- 100cMax", plateID), cmax := 100]
mean.data.ICAM1[ ,cmax := factor(cmax, levels = c(1, 5, 10, 50 ,100)) ]
unique(mean.data.ICAM1[ ,cmax ])

# add cmax annotation for newcmax compounds
newCmax$cmax <- 1
colnames(newCmax) <- c("treatment", "dose_uM", "cmax")
cmax5 <- newCmax
cmax10 <- newCmax
cmax25 <- newCmax
cmax50 <- newCmax
cmax100 <- newCmax

cmax5$dose_uM<-newCmax$dose_uM*5
cmax5$cmax <- 5
cmax10$dose_uM<- newCmax$dose_uM*10
cmax10$cmax<-10
cmax25$dose_uM<- newCmax$dose_uM*25
cmax25$cmax<-25
cmax50$dose_uM <- newCmax$dose_uM*50
cmax50$cmax<-50
cmax100$dose_uM <- newCmax$dose_uM*100
cmax100$cmax<-100

newCmax<- rbind(newCmax,cmax5,cmax10, cmax25, cmax50, cmax100)
newCmax<- as.data.table(newCmax)

write.table(file = '../generated/newCmax.txt', newCmax, sep = "\t", col.names = TRUE)

lapply(newCmax, class)
class(newcmaxPlates$dose_uM)


newcmaxPlates[ , treatment := as.character(treatment)]
newcmaxPlates[ , dose_uM := as.character(dose_uM)]
newCmax[ , treatment := as.character(treatment)]
newCmax[ , dose_uM := as.character(dose_uM)]

ind<-(newCmax$dose_uM %in% unique(newcmaxPlates$dose_uM))
newCmax[!ind, ]

ind2 <- unique(newcmaxPlates$dose_uM) %in% newCmax$dose_uM
unique(newcmaxPlates$dose_uM)[!ind2] #the DMSO

cbind( sort(newCmax[!ind, dose_uM ]), sort(unique(newcmaxPlates$dose_uM)[!ind2]))

setkeyv(newcmaxPlates, c("treatment", "dose_uM") )
setkeyv(newCmax, c("treatment", "dose_uM"))

newcmaxPlates<-newCmax[newcmaxPlates]

newcmaxPlates[ is.na(cmax) , 1:5]
newcmaxPlates[treatment %in% "dmso", cmax := 0 ]
newcmaxPlates[treatment %in% "dmso", dose_uM]

newcmaxPlates[treatment %in% "dmso", dose_uM := "0" ]

mean.data.ICAM1[ treatment %in% "dmso", list(treatment, dose_uM, cmax) ]
table(mean.data.ICAM1[ treatment %in% "dmso", list(treatment, dose_uM, cmax) ]$dose_uM)
# apparently percentage & fraction for dmso concentrations was both used in layout files.

mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 100, dose_uM := 0.2 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 50, dose_uM := 0.1 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 10, dose_uM := 0.02 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 5, dose_uM := 0.01 ]
mean.data.ICAM1[ treatment %in% "dmso" & dose_uM == 1, dose_uM := 0.002 ]

# test for effect of DMSO concentration
dmsotest <- mean.data.ICAM1[ treatment %in% "dmso"]

dmsotest <- aggregate( data = dmsotest, obj_cyto_only_Intensity_IntegratedIntensity_image_GFP ~ dose_uM + plateID, mean )
plot(data= dmsotest, obj_cyto_only_Intensity_IntegratedIntensity_image_GFP ~ dose_uM, ylim = c(0,50),
     col = as.factor(dmsotest$plateID))
# plate effect apparant, but no DMSO concentration effect. Pooling DMSO to simplify analysis:
mean.data.ICAM1[ treatment %in% "dmso" , dose_uM := 0]
mean.data.ICAM1[ treatment %in% "dmso" , cmax := "0"]


lapply(mean.data.ICAM1[,1:7], class)
lapply(newcmaxPlates[,1:7], class)
newcmaxPlates[, cmax := as.character(cmax)]
mean.data.ICAM1[ , dose_uM := as.numeric(dose_uM)]
# combine both sets
mean.data.ICAM1 <- rbind(mean.data.ICAM1, newcmaxPlates)
# remove 25 cmax
mean.data.ICAM1 <- mean.data.ICAM1[ cmax != "25"]
mean.data.ICAM1.long<- melt(mean.data.ICAM1,  id.vars = c("treatment", "dose_uM","cmax", "cell_line", "plateID", "timeID", "timeAfterExposure"))


# add replicate ID
 mean.data.ICAM1.long[ plateID == "20160113 - 100cMax_wells", replID := "replicate_1" ]  #icam1 100cmax repl1
 mean.data.ICAM1.long[ plateID == "20150830 - 100cMax_wells", replID := "replicate_2"]  #icam1 100cmax repl2
 mean.data.ICAM1.long[ plateID == "20140701 - 50cMax_wells", replID := "replicate_1"]  #icam1 50cmax repl1
 mean.data.ICAM1.long[ plateID == "20150828 - 50cMax_wells", replID := "replicate_2"]  #icam1 50cmax repl2
 mean.data.ICAM1.long[ plateID == "20150604 - 10cMax_wells", replID := "replicate_1"]  #icam1 10cmax repl1
 mean.data.ICAM1.long[ plateID == "20150608 - 10cMax_wells", replID := "replicate_2"]  #icam1 10cmax repl2
 mean.data.ICAM1.long[ plateID == "20150601 - 5cMax_wells", replID := "replicate_1"]  #icam1 5cmax repl1
 mean.data.ICAM1.long[ plateID == "20151231 - 5cMax_wells", replID := "replicate_2"]  #icam1 5cmax repl2
 mean.data.ICAM1.long[ plateID == "20150829 - 1cMax_wells", replID := "replicate_1"]  #icam1 1cmax repl1
 mean.data.ICAM1.long[ plateID == "20150914 - 1cMax_wells", replID := "replicate_2"]  #icam1 1cmax repl2

 unique(mean.data.ICAM1.long[ is.na(replID), plateID])
mean.data.ICAM1.long[ plateID == "20150923_ICAM1", replID := "replicate_1"]  #icam1 new cmax repl1 
mean.data.ICAM1.long[ plateID == "20150930_ICAM1", replID := "replicate_2"]  #icam1 new cmax repl2

unique(mean.data.ICAM1.long[ cmax != "0" , list(plateID, cmax)])

save(file = '../tmp/mean.data.ICAM1.long.Rdata', mean.data.ICAM1.long)


```

plots for quality control   
```{r plotsQQ_ICAM1 }

# plot time curves, grid the concentrations and treatments, loop over variables

fingerprintVars <- unique(mean.data.ICAM1.long[ , variable])
writepdfs <- "../generated/results/ICAM1_qqplots/"
if(!dir.exists(writepdfs)){
  dir.create(writepdfs)
}

for( i in seq_along(fingerprintVars)){

  plotData <- mean.data.ICAM1.long[ variable %in% fingerprintVars[i]]
  
  p <- ggplot(data =plotData, aes(x= timeAfterExposure, y=value, color = replID)) + facet_grid(treatment~cmax)
  p<-p + geom_point(aes(color=replID, shape = replID)) + geom_line(aes(group=replID, color=replID)) + 
    theme_sharp() + ggtitle( label = fingerprintVars[i]) 
  pdf(file = paste(writepdfs, fingerprintVars[i], ".pdf", sep =""), width =12, height = 100)
  print(p)
  dev.off()
}

```

## Summary data Srxn1, Chop, p21  

load summary data files from H5CellProfiler output for cell lines p21 srxn1 & chop  
This includes original screen + adjusted subset of compounds with updated cmax values  

```{r load_summary_data_files}

path.to.nonICAM <- "../data/Summary data files"
raw.data =list()
dir.files <- dir(path.to.nonICAM)
dir.files <- dir.files[grepl("(Summary Data)", dir.files)]

for (i in seq_along(dir.files)){
  raw.data[[i]] <- as.data.table(
    read.table(file = paste(path.to.nonICAM, dir.files[i], sep ="/"), header = TRUE, sep ="\t")
  )
}



```

Data cleaning - new cmax

```{r newcmax_data_cleaning}
#20150930_SRXN1

#20151001_SRXN1

lapply(raw.data, function(x) unique(x$timeID))
# 37 through 43 are newcmax plates containing multiple doses
for(i in 37:43){
  raw.data[[i]][ , plateID := paste(plateID, "newCmax", sep = "_")]
}


# De plaat met SRXN1 en ICAM1 van 0930 op 1001 is gecrashed na 5 uur en 45 minuten. 
# Het eerste experiment (dus alles in map 0930)  was 's middags gestart om 16:55
# Het experiment is herstart om 9:02
# Het tweede deel (dus alles in map 1001) duurt nog 7 uur. Tijdpunten zijn elke 1 uur en 35 minuten. 

# dus 5:45 --> gecrasht om 16:55 + 5u45 min = 22:40 gecrasht. Start 10:20 later
lapply(raw.data, function(x) length(unique(x$timeID)))

unique((raw.data[[42]][, plateID])) 
unique((raw.data[[43]][, plateID])) 
#change plateID

raw.data[[43]][, plateID:="20150930_SRXN1_newCmax"]
#modify time

timeBetweenFrames <- "01:35:00"
exposureDelay <- "16:05"

timeBetweenFrames <- round(as.integer(strftime(strptime(timeBetweenFrames, format = "%H:%M:%S"), "%H")) + 
                             1/60 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                 format = "%H:%M:%S"), "%M")) +
                             1/3600 * as.integer(strftime(strptime(timeBetweenFrames, 
                                                                   format = "%H:%M:%S"), "%S"))
                           , digit =2 )

exposureDelay <- round(as.integer(strftime(strptime(exposureDelay, format = "%H:%M"), "%H")) + 
                         1/60 * as.integer(strftime(strptime(exposureDelay, 
                                                             format = "%H:%M"), "%M")), digit =1 )

raw.data[[43]][, timeAfterExposure:=round(as.numeric(timeID)*timeBetweenFrames+exposureDelay - timeBetweenFrames, digits = 1) ]

unique((raw.data[[43]][, timeAfterExposure])) 
unique((raw.data[[43]][, timeID])) 
raw.data[[43]][, timeID:=as.numeric(timeID)+4]
unique((raw.data[[42]][, timeAfterExposure])) 
unique((raw.data[[42]][, timeID])) 



#combine:
object.size(raw.data[[42]]) #199880 bytes
object.size(raw.data[[43]]) #214776 bytes
nrow(raw.data[[42]]) #3724
nrow(raw.data[[43]]) #3724

raw.data[[42]] <- rbind(raw.data[[42]], raw.data[[43]])
object.size(raw.data[[42]])  #423888 bytes
nrow(raw.data[[42]])  #7448
#199880+214776 = 414656
raw.data[[43]] <- NULL
unique(raw.data[[42]][, timeID])
unique(raw.data[[42]][, timeAfterExposure])
raw.data[[42]][ treatment%in%"DMSO" & as.numeric(as.character(dose_uM)) <= 0.2] # checking if controls available..
unique(raw.data[[42]]$variable)
unique(raw.data[[42]][ treatment == "Zimelidine", dose_uM])

unique(raw.data[[42]][ , variable])
# multiple background values for the combined crashed plate. Gsub them to 3 unique values, and problem with 4 timepoint data later on should be solved.
raw.data[[42]][ , variable := gsub("count_Cytoplasm_Intensity_IntegratedIntensity_image_GFP_larger_9.582",
                                   "count_Cytoplasm_Intensity_IntegratedIntensity_image_GFP_larger_8.074", variable)]

raw.data[[42]][ , variable := gsub("count_Cytoplasm_Intensity_IntegratedIntensity_image_GFP_larger_14.373",
                                   "count_Cytoplasm_Intensity_IntegratedIntensity_image_GFP_larger_12.111", variable)]
raw.data[[42]][ , variable := gsub("count_Cytoplasm_Intensity_IntegratedIntensity_image_GFP_larger_38.816",
                                   "count_Cytoplasm_Intensity_IntegratedIntensity_image_GFP_larger_34.524", variable)]




```

# testing if length 4 time is fixed
```{r }


lapply(raw.data, colnames)
raw.data[[42]]$singlelCurveName = paste(raw.data[[42]]$variable, raw.data[[42]]$cell_line, raw.data[[42]]$treatment, raw.data[[42]]$cmax, raw.data[[42]]$replID, sep = "__")  

test <- split(raw.data[[42]], raw.data[[42]]$singlelCurveName)

sort(unique(paste0(raw.data[[42]]$treatment, raw.data[[42]]$dose_uM)))


ind<- lapply(test, function(x) { length(unique(x$timeAfterExposure)) }  )

unique(ind)

indd <- lapply(ind, function(x) x == 4)

raw.data[[42]]$singlelCurveName <- NULL
```


data cleaning - original cmax data



```{r data_cleaning}

# first 3 no timeAfterExposure
# 2013-07-10 1.2  0.8
# 2013-07-24 1.076 tr  40min del
# 2013-07-29  59 min  20 min


timeBetweenFrames <- 1.2
exposureDelay <- 0.8
raw.data[[1]]$timeAfterExposure<- as.integer(raw.data[[1]]$timeID) * timeBetweenFrames + exposureDelay - timeBetweenFrames

timeBetweenFrames <- 1.076
exposureDelay <- 0.667
raw.data[[2]]$timeAfterExposure<- as.integer(raw.data[[2]]$timeID) * timeBetweenFrames + exposureDelay - timeBetweenFrames

timeBetweenFrames <- 0.983
exposureDelay <- 0.333
raw.data[[3]]$timeAfterExposure<- as.integer(raw.data[[3]]$timeID) * timeBetweenFrames + exposureDelay - timeBetweenFrames

which(unlist(lapply(raw.data, ncol)) != 9 )

raw.data[[13]]$control <-1
raw.data[[26]]$doseLevel <- NULL

which(unlist(lapply(raw.data, ncol)) != 9 )


raw.data <- do.call("rbind" ,raw.data)

raw.data$treatment <- tolower(raw.data$treatment)

raw.data$control <-NULL
sum(is.na(raw.data))

head(raw.data)

raw.data$variable <- gsub("_>_", "_larger_", raw.data$variable)
raw.data$variable <- gsub("_<_", "_smaller_", raw.data$variable)
raw.data$variable <- gsub("[_]{1}$", "", raw.data$variable)
raw.data$variable <- gsub("[_]{1}$", "", raw.data$variable)

unique(raw.data$variable)

# fix cell line names
unique(raw.data$cell_line)
raw.data$cell_line <- gsub("Chop", "DDIT3", raw.data$cell_line)
raw.data$cell_line <- gsub("CHOP", "DDIT3", raw.data$cell_line)
raw.data$cell_line <- gsub("SRXN1", "Srxn1", raw.data$cell_line)
raw.data$cell_line <- gsub("P21", "p21", raw.data$cell_line)
unique(raw.data$plateID)



raw.data$replID <- "none"
raw.data$cmax <- "none"
unique(raw.data$plateID)

raw.data[ raw.data$plateID == "2013_07_10_Srxn1_z1", "replID"] <-   "replicate_1"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_07_10_Srxn1_z1", "cmax"] <-   "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_07_24_Srxn1", "replID"] <-      "replicate_2"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_07_24_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_07_29_Srxn1", "replID"] <-      "replicate_3"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_07_29_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_08_01_Srxn1", "replID"] <-      "replicate_4"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_08_01_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_08_14_Srxn1", "replID"] <-      "replicate_5"  #Srxn1 100cmax
raw.data[ raw.data$plateID == "2013_08_14_Srxn1", "cmax"] <-      "100cmax"  #Srxn1 100cmax

raw.data[ raw.data$plateID == "2013_08_15_Srxn1", "replID"] <-      "replicate_1"  #Srxn1 50cmax
raw.data[ raw.data$plateID == "2013_08_15_Srxn1", "cmax"] <-      "50cmax"  #Srxn1 50cmax

raw.data[ raw.data$plateID == "2013_08_21_Srxn1", "replID"] <-      "replicate_2"  #Srxn1 50cmax
raw.data[ raw.data$plateID == "2013_08_21_Srxn1", "cmax"] <-      "50cmax"  #Srxn1 50cmax

raw.data[ raw.data$plateID == "2013_08_22_Srxn1", "replID"] <-      "replicate_3"  #Srxn1 50cmax     
raw.data[ raw.data$plateID == "2013_08_22_Srxn1", "cmax"] <-      "50cmax"  #Srxn1 50cmax

raw.data[ raw.data$plateID == "2013_08_28_nii_Srxn1", "replID"] <-  "replicate_1"  #Srxn1 10cmax
raw.data[ raw.data$plateID == "2013_08_28_nii_Srxn1", "cmax"] <-  "10cmax"  #Srxn1 10cmax

raw.data[ raw.data$plateID == "2013_08_28_niii_Srxn1", "replID"] <- "replicate_2"  #Srxn1 10cmax  
raw.data[ raw.data$plateID == "2013_08_28_niii_Srxn1", "cmax"] <- "10cmax"  #Srxn1 10cmax

raw.data[ raw.data$plateID == "2013_09_04_Srxn1", "replID"] <-      "replicate_3"  #Srxn1 10cmax
raw.data[ raw.data$plateID == "2013_09_04_Srxn1", "cmax"] <-      "10cmax"  #Srxn1 10cmax

raw.data[ raw.data$plateID == "2013_09_05_Srxn1", "replID"] <-      "replicate_1"  #Srxn1 5cmax
raw.data[ raw.data$plateID == "2013_09_05_Srxn1", "cmax"] <-      "5cmax"  #Srxn1 5cmax

raw.data[ raw.data$plateID == "2013_09_09_Srxn1", "replID"] <-      "replicate_2"  #Srxn1 5cmax
raw.data[ raw.data$plateID == "2013_09_09_Srxn1", "cmax"] <-      "5cmax"  #Srxn1 5cmax

raw.data[ raw.data$plateID == "2013_09_16_Srxn1", "replID"] <-      "replicate_1"  #Srxn1 1cmax
raw.data[ raw.data$plateID == "2013_09_16_Srxn1", "cmax"] <-      "1cmax"  #Srxn1 1cmax


raw.data$plateID <- gsub("25-9-2013_Srxn1", "2013_09_25_Srxn1", raw.data$plateID)

raw.data[ raw.data$plateID == "2013_09_25_Srxn1", "replID"] <-       "replicate_2"  #Srxn1 1cmax
raw.data[ raw.data$plateID == "2013_09_25_Srxn1", "cmax"] <-       "1cmax"  #Srxn1 1cmax

raw.data[ raw.data$plateID == "2013_09_26_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 100cmax
raw.data[ raw.data$plateID == "2013_09_26_DDIT3", "cmax"] <-      "100cmax"  #DDIT3 100cmax

raw.data[ raw.data$plateID == "2013_10_03_DDIT3", "replID"] <-      "replicate_2"  #DDIT3 100cmax
raw.data[ raw.data$plateID == "2013_10_03_DDIT3", "cmax"] <-      "100cmax"  #DDIT3 100cmax

raw.data[ raw.data$plateID == "2013_10_04_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 50cmax
raw.data[ raw.data$plateID == "2013_10_04_DDIT3", "cmax"] <-      "50cmax"  #DDIT3 50cmax

raw.data[ raw.data$plateID == "2013_10_09_niii_p21", "replID"] <-   "replicate_1"  #p21 100cmax
raw.data[ raw.data$plateID == "2013_10_09_niii_p21", "cmax"] <-   "100cmax"  #p21 100cmax

raw.data[ raw.data$plateID == "2013_10_09_nii_p21", "replID"] <-    "replicate_2"  #p21 100cmax
raw.data[ raw.data$plateID == "2013_10_09_nii_p21", "cmax"] <-    "100cmax"  #p21 100cmax

raw.data[ raw.data$plateID == "2013_10_17_nii_DDIT3", "replID"] <-  "replicate_2"  #DDIT3 50cmax
raw.data[ raw.data$plateID == "2013_10_17_nii_DDIT3", "cmax"] <-  "50cmax"  #DDIT3 50cma

raw.data[ raw.data$plateID == "2013_10_17_niii", "replID"] <-       "replicate_3"  #DDIT3 50 cmax
raw.data[ raw.data$plateID == "2013_10_17_niii", "cmax"] <-       "50cmax"  #DDIT3 50 cm

raw.data[ raw.data$plateID == "2013_10_24_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 10 cmax
raw.data[ raw.data$plateID == "2013_10_24_DDIT3", "cmax"] <-      "10cmax"  #DDIT3 10 cm

raw.data[ raw.data$plateID == "2013_11_20_DDIT3", "replID"] <-      "replicate_2"  #DDIT3 10 cmax
raw.data[ raw.data$plateID == "2013_11_20_DDIT3", "cmax"] <-      "10cmax"  #DDIT3 10 cm

raw.data[ raw.data$plateID == "2013_11_27_DDIT3", "replID"] <-      "replicate_1"  #DDIT3 5 cmax
raw.data[ raw.data$plateID == "2013_11_27_DDIT3", "cmax"] <-      "5cmax"  #DDIT3 5 cma

raw.data[ raw.data$plateID == "2013_12_04_DDIT3_niii", "replID"] <-      "replicate_1"  #DDIT3 1 cmax
raw.data[ raw.data$plateID == "2013_12_04_DDIT3_niii", "cmax"] <-      "1cmax"  #DDIT3 

raw.data[ raw.data$plateID == "2013_12_04_DDIT3_nii", "replID"] <-  "replicate_2"  #DDIT3 1 cmax
raw.data[ raw.data$plateID == "2013_12_04_DDIT3_nii", "cmax"] <-  "1cmax"  #DDIT3 1 cma

raw.data[ raw.data$plateID == "2013_12_11_DDIT3", "replID"] <-  "replicate_2"  #DDIT3 5 cmax
raw.data[ raw.data$plateID == "2013_12_11_DDIT3", "cmax"] <-  "5cmax"  #DDIT3 5 cmax

raw.data[ raw.data$plateID == "2014_02_05_nii_p21", "replID"] <-    "replicate_1" #p21 10cmax
raw.data[ raw.data$plateID == "2014_02_05_nii_p21", "cmax"] <-    "10cmax" #p21 10cma

raw.data[ raw.data$plateID == "2014_02_05_p21_niii", "replID"] <-   "replicate_2" #p21 10cmax
raw.data[ raw.data$plateID == "2014_02_05_p21_niii", "cmax"] <-   "10cmax" #p21 10cma

raw.data[ raw.data$plateID == "2014_02_11_p21", "replID"] <-        "replicate_1" #p21 50cmax
raw.data[ raw.data$plateID == "2014_02_11_p21", "cmax"] <-        "50cmax" #p21 50cma

raw.data[ raw.data$plateID == "p21_50Cmax", "replID"] <-        "replicate_2" #p21 50cmax
raw.data[ raw.data$plateID == "p21_50Cmax", "cmax"] <-        "50cmax" #p21 50cmax

raw.data[ raw.data$plateID == "2014_02_18_p21", "replID"] <-        "replicate_1" #p21 5cmax 
raw.data[ raw.data$plateID == "2014_02_18_p21", "cmax"] <-        "5cmax" #p21 5cmax

raw.data[ raw.data$plateID == "2014_02_19_p21", "replID"] <-        "replicate_2" #p21 5cmax
raw.data[ raw.data$plateID == "2014_02_19_p21", "cmax"] <-        "5cmax" #p21 5cmax

raw.data[ raw.data$plateID == "2014_02_25_p21", "replID"] <-        "replicate_1" #p21 1cmax
raw.data[ raw.data$plateID == "2014_02_25_p21", "cmax"] <-        "1cmax" #p21 1cmax

raw.data[ raw.data$plateID == "2014_03_05_p21", "replID"] <-        "replicate_2" #p21 1cmax
raw.data[ raw.data$plateID == "2014_03_05_p21", "cmax"] <-        "1cmax" #p21 1cmax



unique(raw.data[ replID == "none", plateID ])
sum((raw.data$replID == "none")) #0
sum((raw.data$cmax == "none")) #0
unique(raw.data$cmax)


# for newcmax data, add cmax on compound basis.
unique(raw.data[ cmax == "none", plateID])


newcmax.data <- raw.data[ cmax == "none", ]
raw.data <- raw.data[ cmax != "none", ]

raw.data[treatment == "metformin ", treatment := "metformin"]

# remove newcmaxcompounds from raw.data
unique(newcmax.data[newcmax.data$plateID == "20150930_SRXN1_newCmax", c( "plateID", "replID", "timeID") ])
 unique(raw.data[(treatment %in% newcmaxcomps), ]$plateID)

 raw.data <- raw.data[!(treatment %in% newcmaxcomps), ]

#Carmustine 0.037 ipv 0.356

newcmax.data[, dose_uM := as.numeric(dose_uM)]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 0.356, dose_uM:= 0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 1.78, dose_uM:= 5*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 3.56, dose_uM:= 10*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 8.90, dose_uM:= 25*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 17.80, dose_uM:= 50*0.037]
newcmax.data[ treatment%in% "carmustine" & dose_uM %in% 35.60, dose_uM:= 100*0.037]


unique(newcmax.data$treatment)%in% newCmax$treatment # only dmso not
newcmax.data[, dose_uM := as.character(dose_uM)]
unique(newcmax.data$dose_uM)%in% newCmax$dose_uM # missing 1 (the dmso 0.2)
newcmax.data[, cmax := NULL]
newCmax <- read.delim( file ='../generated/newCmax.txt', sep = "\t", header = TRUE) # load 1cmax concentrations of new cmax compound set 
newCmax <- as.data.table(newCmax)
newcmax.data[ , dose_uM := as.numeric(dose_uM)]
setkeyv(newCmax, c("treatment", "dose_uM")) # this lookup file was generated earlier in the ICAM1 newcmax part
setkeyv(newcmax.data, c("treatment", "dose_uM"))

newcmax.data.cmax <- newCmax[newcmax.data]

min(newcmax.data.cmax[ , length(unique(timeID)), by = list(treatment, variable, plateID, replID)]$V1)


# add cmax for dmso
newcmax.data.cmax[ treatment == "dmso", cmax := 0 ]
unique(newcmax.data.cmax[ is.na(cmax), treatment])
newcmax.data.cmax[ cmax == "none"]

# add replID for newcmax compounds
newcmaxplates <- unique(newcmax.data.cmax[, plateID])
newcmax.data.cmax[ plateID == "20150923_CHOP_newCmax", replID := 'replicate_1' ]
newcmax.data.cmax[ plateID == "20150930_CHOP_newCmax", replID := 'replicate_2' ]
newcmax.data.cmax[ plateID == "20150923_P21_newCmax", replID := 'replicate_1' ]
newcmax.data.cmax[ plateID == "20150930_P21_newCmax", replID := 'replicate_2' ]
newcmax.data.cmax[ plateID == "20150923_SRXN1_newCmax", replID := 'replicate_1' ]
newcmax.data.cmax[ plateID == "20150930_SRXN1_newCmax", replID := 'replicate_2' ]



raw.data <- rbind(raw.data, newcmax.data.cmax)
raw.data <- raw.data[ cmax != 25,]
unique(raw.data[, cmax])

raw.data[ cmax == 0, cmax := '0cmax']
raw.data[ cmax == 1, cmax := '1cmax']
raw.data[ cmax == 5, cmax := '5cmax']
raw.data[ cmax == 10, cmax := '10cmax']
raw.data[ cmax == 50, cmax := '50cmax']
raw.data[ cmax == 100, cmax := '100cmax']

unique(raw.data[ , c("plateID", "cell_line", "cmax", "replID")])


sort( unique(raw.data$treatment))

raw.data$treatment <- gsub("metformin ", "metformin", raw.data$treatment )

# there are multiple & varying number of replicates, because manual inspection had shown failed experiments due to microscope crashes/ CO2 failure etc. after which experiments were repeated.
# there are however, at least two replicates for all experiments (cell line dose combinations)


```

Make sure concentrations are exactly the same  

```{r fix_dose }

raw.data$comp_dose <- paste(raw.data$treatment, raw.data$dose_uM, sep="_")
raw.data[, dose_uM := as.numeric(dose_uM)]
raw.data$dose_uM <- round(raw.data$dose_uM, digits = 4)

ind.more10 <- raw.data$dose_uM >= 10
raw.data$dose_uM[ind.more10] <- round(raw.data$dose_uM[ind.more10], digits = 1)
ind.more1 <- raw.data$dose_uM >= 1
raw.data$dose_uM[ind.more1] <- round(raw.data$dose_uM[ind.more1], digits = 2)


# tabel met compound namen en concentraties maken
raw.data[, comp_dose:= paste(treatment, dose_uM, sep ="_")]
compDosetabel <- unique(raw.data[!cell_line %in% "ICAM1", list(treatment, cmax, dose_uM, comp_dose)])

compDosetabel <- as.data.frame(compDosetabel)
compDosetabel<- compDosetabel[ order(compDosetabel$treatment, compDosetabel$dose_uM),]
# count how many doses each compound has and fix if incorrect

compDosetabel$comp_dose <- paste(compDosetabel$treatment, compDosetabel$dose_uM, sep="_")
comps <- unique(compDosetabel[ , c("treatment", "dose_uM", "cmax")])[ order(unique(compDosetabel$comp_dose)),  ]
comps <- comps[ order(comps$treatment, comps$dose_uM),]
tt <- ddply(comps, .(treatment), summarize, length(treatment))
tt[ tt[, "..1"] >5,]


# the newcmax compounds from plate p21_50Cmax are adjusted, these should therefor not be replaced later on when newcmax compounds are added.


#fix compDosetabel, daarna merge operatie ervan uitgaande dat de cmax'n kloppen


incDose <- comps[ comps$treatment %in%  c("digoxin","epinephrine", "haloperidol", "moxisylyte",
                               "paroxetine","phenacetin", "propranolol","ribavirin",
                               "simvastatin","sulindac", "tacrine", "ticlopidine"), ]
incDose


raw.data[ treatment == "digoxin" & dose_uM == 0.2830 & cmax == "100cmax", "dose_uM" ] <-0.2800
raw.data[ treatment == "epinephrine" & dose_uM == 0.1763 & cmax == "100cmax", "dose_uM" ] <-0.1800
raw.data[ treatment == "haloperidol" & dose_uM == 0.5321 & cmax == "100cmax", "dose_uM" ] <-0.53
raw.data[ treatment == "moxisylyte" & dose_uM == 15.7000 & cmax == "100cmax", "dose_uM" ] <-15.8
raw.data[ treatment == "paroxetine" & dose_uM == 3.0400 & cmax == "50cmax", "dose_uM" ] <-3.05
raw.data[ treatment == "phenacetin" & dose_uM == 30.8000 & cmax == "50cmax", "dose_uM" ] <-31.0
raw.data[ treatment == "propranolol" & dose_uM == 10.1000 & cmax == "50cmax", "dose_uM" ] <-10.0
raw.data[ treatment == "ribavirin" & dose_uM == 130.6000 & cmax == "50cmax" , "dose_uM" ] <-130.7
raw.data[ treatment == "simvastatin" & dose_uM == 4.1200 & cmax == "50cmax" , "dose_uM" ] <-4.1
raw.data[ treatment == "sulindac" & dose_uM == 1599.2000 & cmax == "50cmax", "dose_uM" ] <-1599.3
raw.data[ treatment == "tacrine" & dose_uM == 3.9800 & cmax == "50cmax", "dose_uM" ] <-4
raw.data[ treatment == "ticlopidine" & dose_uM ==  403.7000 & cmax == "50cmax", "dose_uM" ] <- 403.8
# wat niet klopt: 
#digoxin 
#epinephrine
#haloperidol
#moxisylyte
#paroxetine
#phenacetin
#propranolol
#ribavirin
#simvastatin
#sulindac
#tacrine
#ticlopidine

raw.data$comp_dose <- NULL


# lets have a look at the cmax dose_uM levels with respect to each other
all.t<- unique(raw.data$treatment)
k=NULL

all.t <- all.t[!all.t %in% newcmaxcomps]


for(i in seq_along(all.t)){
  mdim <- dim(unique(raw.data[ raw.data$treatment == all.t[i] , list(dose_uM,cmax) ]))
print(mdim)
  if(mdim[1] != 5){
    k = c(k, i)
  }
  } # 5 2 for all?

# print unexpected compound dose #
all.t[k]
# for the control compounds (.._c) this makes sense. Also for dmso and dmem

# for the new cmax compounds 10 are expected 
#diclofenac 500.5 -- > 505 (for new cmax p21 plate)

raw.data[ treatment == "diclofenac" & plateID ==  'p21_50Cmax' & dose_uM == 500.5, dose_uM := 505 ]

for(i in seq_along(newcmaxcomps)){
  #print(i)
  print(dim(unique(raw.data[ raw.data$treatment == newcmaxcomps[i] , list(dose_uM,cmax) ])))
}
 newcmaxcomps[15] # this concentration remained the same, but true analogue this time  

 for(i in seq_along(newcmaxcomps)){
 print(newcmaxcomps[i])
   print(unique(raw.data[ treatment == newcmaxcomps[i] & plateID == "p21_50Cmax", dose_uM]))
 }
 unique(raw.data[ plateID == "p21_50Cmax", dose_uM ])
 
 
  raw.data[ treatment == "aspirin" & plateID == "p21_50Cmax", dose_uM := 275]
  unique(raw.data[ treatment == "aspirin" & plateID == "p21_50Cmax", dose_uM ])
  raw.data[ treatment == "metformin" & plateID == "p21_50Cmax", dose_uM := 389]
  unique(raw.data[ treatment == "metformin" & plateID == "p21_50Cmax", dose_uM ])
 
  for(i in seq_along(newcmaxcomps)){
   print(newcmaxcomps[i])
   print(length(unique(raw.data[ treatment == newcmaxcomps[i] & plateID %in% newcmaxplates, dose_uM])))
 }
 
```


Check for completeness of data  
together with this data + after plotting data select 2 replicates of each cell line dose combination  
```{r checkCompleteness}

# count number of treatments for all experiments

raw.data[ , length(unique(treatment))  , by =  c("plateID", "replID", "cmax") ]
# low treatment count for plate 2013_10_04_DDIT3
all.treats <- unique(raw.data$treatment)

indNotIn_2013_10_04_DDIT3  <- which(! all.treats %in% unique(raw.data[ plateID %in% "2013_10_04_DDIT3", treatment]) )
all.treats[indNotIn_2013_10_04_DDIT3]

# check missing treatments for all plates
all.plates <- unique(raw.data[, plateID])
missingTreat = alist()
for( i in seq_along(all.plates)) {
  ind  <- which(! all.treats %in% unique(raw.data[ plateID %in% all.plates[i], treatment]) )
    tmp <- list( plate = all.plates[i], missingComps = all.treats[ind])
    missingTreat[[i]] <- tmp
  }
# plates that contain missing (non _c) compounds:
# 2013_07_10_Srxn1_z1 (121)
# 2013_07_24_Srxn1 (63)
# 2013_08_14_Srxn1 (10)
missingTreat[[5]]
# 2013_10_04_DDIT3 (16)
missingTreat[[18]]
# p21_50Cmax
missingTreat[[36]]
sort(unique(raw.data[ plateID == "p21_50Cmax", treatment]))

rel.treats <- sort(unique(raw.data[ plateID == "p21_50Cmax", treatment]))

missingTreatRel = alist()
for( i in seq_along(all.plates)) {
  ind  <- which(! rel.treats %in% unique(raw.data[ plateID %in% all.plates[i], treatment]) )
    tmp <- list( plate = all.plates[i], missingComps = rel.treats[ind])
    missingTreatRel[[i]] <- tmp
  }

# 2013_07_10_Srxn1_z1
# 2013_07_24_Srxn1 
# 2013_08_14_Srxn1 (5)
# 2013_10_04_DDIT3

unique(raw.data[plateID == "2013_08_14_Srxn1", list(cmax, plateID, cell_line)])
unique(raw.data[cell_line == "Srxn1" & cmax == "100cmax", list(cmax, plateID, cell_line)])


```

Change & select variable names  

```{r transform_variable_names}



unique(raw.data$variable)

raw.data[, variable:= gsub("_obj_cyto_only_", "_Cytoplasm_", variable) ]
raw.data[, variable:= gsub("_obj_nc_", "_Nuclei_", variable) ]
raw.data[, variable:= gsub("_img_cyto", "_Image_GFP", variable) ]
raw.data[, variable:= gsub("obj_nc_", "Nuclei_", variable) ]
raw.data[, variable:= gsub("_img_gfp", "_Image_GFP", variable) ]
raw.data[, variable:= gsub("Intensity_image_GFP_", "Intensity_Image_GFP_", variable)]


raw.data[, variable:= gsub("obj_cyto_only_Intensity_IntegratedIntensity", "Cytoplasm_Intensity_IntegratedIntensity", variable) ]

raw.data[ , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_7.5.1",
                            "count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_7.51", variable)]


unique(raw.data$variable)


raw.data[, ThreshN:= str_match(variable,"_larger_([0-9 .]{2,6})$")[,2]]

#unique(raw.data[, ThreshN])

raw.data[, ThreshN:= as.numeric(ThreshN)]
#unique(raw.data$ThreshN)

raw.data<- ddply(raw.data, .(plateID), transform, isMin= ThreshN == min(ThreshN, na.rm=TRUE))

raw.data<- ddply(raw.data, .(plateID), transform, isMax= ThreshN == max(ThreshN, na.rm=TRUE))

raw.data<- ddply(raw.data, .(plateID), transform, isMiddle= ThreshN != max(ThreshN, na.rm=TRUE) & ThreshN!=min(ThreshN, na.rm=TRUE))


#change variables to consistent names

raw.data<-as.data.table(raw.data)

# as.data.frame(unique(raw.data[, list(plateID,variable, ThreshN, isMin,isMax, isMiddle)]))

raw.data[ isMin ==TRUE  & !grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                        "count_Cyto.2m",variable)]

raw.data[ isMin ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                  "count_Nuclei.2m",variable)]
raw.data[ isMin ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= 
            gsub("count_Nuclei_Intensity_MeanIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                  "count_Nuclei.2m",variable)]

raw.data[ isMiddle ==TRUE  & !grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}",                                                                                   "count_Cyto.3m",variable)]

raw.data[ isMiddle ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                 "count_Nuclei.3m",variable)]
raw.data[ isMiddle ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_MeanIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                 "count_Nuclei.3m",variable)]

raw.data[ isMax ==TRUE  & !grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                     "count_Cyto.m3sd",variable)]

raw.data[ isMax ==TRUE  & grepl("count_Nuclei_Intensity",variable) , variable:= gsub("count_Nuclei_Intensity_IntegratedIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                    "count_Nuclei.m3sd",variable)]
raw.data[ isMax ==TRUE  & grepl("count_Nuclei_Intensity",variable) , 
          variable:= gsub("count_Nuclei_Intensity_MeanIntensity_Image_GFP_larger_[0-9 .]{3,6}", 
                                                                                    "count_Nuclei.m3sd",variable)]

unique(raw.data$variable)


raw.data[, variable:= gsub("count_Cyto", "GFP_pos", variable)]
raw.data[, variable:= gsub("count_Nuclei", "GFP_pos", variable)]

raw.data[, variable:= gsub("Nuclei_TrackObjects_DistanceTraveled_[0-9]{2}",
                       "CellSpeed", variable)]

raw.data[, variable:= gsub("imageCountTracked",
                       "CellNumber", variable)]

# fix more inconsitant variable names  
sort(unique(raw.data$variable))

raw.data[, variable := gsub("_image_GFP", 
                            "_Image_GFP", variable)]

raw.data[, variable := gsub("Image_Count_obj_nc", 
                            "CellNumber", variable)]

raw.data[, variable := gsub("_img_nc", 
                            "_Image_Hoechst", variable)]

raw.data[, variable := gsub("_image_hoechst", 
                            "_Image_Hoechst", variable)]

# remove irrelevant variables;
min(raw.data[ , length(unique(timeAfterExposure)), by = list(treatment, variable, plateID, replID, cmax)]$V1)

raw.data <- raw.data[ !variable %in% c( "min_maxNorm_CellNumber", "min_maxNorm_CellSpeed", "min_maxNorm_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP", "min_maxNorm_Nuclei_Intensity_IntegratedIntensity_Image_GFP")]

sort(unique(raw.data$variable))

raw.data[, ThreshN:=NULL]
raw.data[, isMin:=NULL]
raw.data[, isMax:=NULL]
raw.data[, isMiddle:=NULL]




```


plots for quality control (non icam1)  

```{r plotQQ_srxn1_chop_p21}

raw.data[ treatment == "dmso", cmax := "0cmax" ]
raw.data[, cmax := factor(cmax, levels = c("0cmax", "1cmax", "5cmax", "10cmax", "50cmax", "100cmax"))]


# plot time curves, grid the concentrations and treatments, loop over variables
raw.data[, variable_CL := paste0(variable, cell_line)]
fingerprintVarsC <- unique(raw.data[ , variable_CL])
# writepdfs <- "../generated/results/nonicam_qqplots/"
# if(!dir.exists(writepdfs)){
#   dir.create(writepdfs)
# }
# 
# for( i in seq_along(fingerprintVarsC)){
# 
#   plotData <- raw.data[ variable_CL %in% fingerprintVarsC[i]]
#   p <- ggplot(data =plotData, aes(x= timeAfterExposure, y=value, color = replID)) + facet_grid(treatment~cmax)
#   p<-p + geom_point(aes(color=replID, shape = replID)) + geom_line(aes(group=replID, color=replID)) + 
#     theme_sharp() + ggtitle( label = fingerprintVarsC[i])
#   pdf(file = paste(writepdfs, fingerprintVarsC[i], ".pdf", sep =""), width =12, height = 100)
#   print(p)
#   dev.off()
# }



```

Select plates with full compound sets.
Verify features acros plates/ replicates: each feature of interest should be represented by 2 replicates.   

2013_07_29_Srxn1 : no CO2 - verified by no to little responses compared to other replicates
2013_07_24_Srxn1, 2013_07_10_Srxn1_z1: low compunds amount
````{r selectplates}

unique(raw.data[ order(cell_line, cmax,plateID, replID), list(cell_line, cmax,plateID, replID)])[ cmax != "0cmax",]
# 3 10cmax Srxn1 replicates
# 3 50cmax Srxn1 replicates
# 3 50cmax DDIT3 replicates
rm.plates <- c( "2013_07_10_Srxn1_z1", "2013_07_24_Srxn1", "2013_07_29_Srxn1")

raw.data <- raw.data[ !(plateID %in% rm.plates), ]

raw.data[ cell_line == "Srxn1" & (cmax == "100cmax" | cmax == "0cmax") & plateID == "2013_08_01_Srxn1", replID := "replicate_1"]
raw.data[ cell_line == "Srxn1" & (cmax == "100cmax"| cmax == "0cmax") & plateID == "2013_08_14_Srxn1", replID := "replicate_2"]

# check variable names over replicates

countFeats <- unique(raw.data[ order(cell_line, cmax,plateID, replID, variable), list(cell_line, cmax, variable, replID)])

# by summarizing over replID, at least 2 N should appear for each feature of interest;

countFeats[,list(cell_line, cmax, variable)][ ,.N , by = list(cell_line, cmax, variable)][ N < 2,]
# Nuclei_Intensity_IntegratedIntensity_Image_GFP occurs once, remove since nuclei mean intensity is required (and also measured)
raw.data <- raw.data[ !(cell_line == "p21" & cmax == "50cmax" & variable == "Nuclei_Intensity_IntegratedIntensity_Image_GFP")]

 raw.data[ , fingerprints:= variable ]
 raw.data[variable %in% "GFP_pos.m3sd", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "GFP_pos.2m", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "GFP_pos.3m", fingerprints:= paste(variable, cell_line, sep = "_")]
 
 raw.data[variable %in% "Cytoplasm_Intensity_IntegratedIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "Cytoplasm_Intensity_MeanIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "Nuclei_Intensity_IntegratedIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]
 raw.data[variable %in% "Nuclei_Intensity_MeanIntensity_Image_GFP", fingerprints:= paste(variable, cell_line, sep = "_")]

 min(raw.data[ , length(unique(timeID)), by = list(treatment, fingerprints, plateID, replID, cmax)]$V1)
 
  unique(raw.data[,fingerprints])

 countFeats <- unique(raw.data[ order(cell_line, cmax,plateID, replID, fingerprints), list(cell_line, cmax, fingerprints, replID)])
countFeats[,list(cell_line, cmax, fingerprints)][ ,.N , by = list(cell_line, cmax, fingerprints)][ N<2]



```


Combine ICAM1 and Srxn1-DDIT3-p21   
```{r combine_sets}

load('../tmp/mean.data.ICAM1.long.Rdata')



raw.data[, variable_CL:=NULL]

unique(mean.data.ICAM1.long[, variable])

dim(raw.data)
dim(mean.data.ICAM1.long)

unique(raw.data[, fingerprints])
# for ICAM1 variables change:
# imageCountTracked -> CellNumber
# obj_nuclei_AreaShape_Area -> Nuclei_AreaShape_Area
# obj_nuclei_TrackObjects_DistanceTraveled -> CellSpeed
# obj_nuclei_Intensity_MeanIntensity_image_hoechst -> Nuclei_Intensity_MeanIntensity_Image_Hoechst
mean.data.ICAM1.long[ , variable := gsub( "imageCountTracked", "CellNumber" , variable) ]
mean.data.ICAM1.long[ , variable := gsub( "obj_nuclei_AreaShape_Area", "Nuclei_AreaShape_Area" , variable) ]
mean.data.ICAM1.long[ , variable := gsub( "obj_nuclei_TrackObjects_DistanceTraveled", "CellSpeed" , variable) ]
mean.data.ICAM1.long[ , variable := gsub( "obj_nuclei_Intensity_MeanIntensity_image_hoechst",
                                          "Nuclei_Intensity_MeanIntensity_Image_Hoechst" , variable) ]


# features to remove from ICAM1 data:
rmICAM1feats <- c("obj_icam1_AreaShape_Area","norm_obj_icam1_Intensity_MeanIntensity_image_GFP" ,
                  "norm_obj_cyto_only_Intensity_MeanIntensity_image_GFP",
                  "backgroundValue.obj_icam1_Intensity_MeanIntensity_image_GFP",
                   "backgroundValue.obj_cyto_only_Intensity_MeanIntensity_image_GFP",
                  "norm_obj_icam1_Intensity_IntegratedIntensity_image_GFP",
                  "norm_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP",
                  "backgroundValue.obj_icam1_Intensity_IntegratedIntensity_image_GFP",
                  "backgroundValue.obj_cyto_only_Intensity_IntegratedIntensity_image_GFP")

mean.data.ICAM1.long <- mean.data.ICAM1.long[ !variable %in% rmICAM1feats, ]

# create fingerprints
notFP <- c("CellNumber", "CellSpeed", "Nuclei_AreaShape_Area", "Nuclei_Intensity_MeanIntensity_Image_Hoechst")
mean.data.ICAM1.long[ , fingerprints := variable]
mean.data.ICAM1.long[ !variable %in% notFP  , fingerprints := paste(variable, cell_line, sep = "_") ]

mean.data.ICAM1.long[cmax == 0, cmax := "0cmax"]
mean.data.ICAM1.long[cmax == 1, cmax := "1cmax"]
mean.data.ICAM1.long[cmax == 5, cmax := "5cmax"]
mean.data.ICAM1.long[cmax == 10, cmax := "10cmax"]
mean.data.ICAM1.long[cmax == 50, cmax := "50cmax"]
mean.data.ICAM1.long[cmax == 100, cmax := "100cmax"]
mean.data.ICAM1.long[, cmax:=factor(cmax)]

all.data <- rbind(raw.data, mean.data.ICAM1.long)





```

## Quality control for nonICAM1 & ICAM1 data

plate based quality control: cell viability per plate, image segmentation; use CellNumber & Nuclei_AreaShape_Area
plate based cell viability: check if cells are dying; use CellNumber, CellSpeed


compound based quality control: autofluorescence; use compound based intensity distribution & compound based CellNumber & compound based Hoechst intensity
PI endpoint data:  
several times PI was added after live cell imaging to check for cell viability.  
include PI-end point data for compound-based cell viability  


```{r QC_plate_based}
# goal: what are the outliers on plate-to-plate basis and what is the cause?
# create compound ordered box plots per QC-feature, facet over plates 

if(!dir.exists('../generated/results/plateQC')){
  dir.create('../generated/results/plateQC')
}

# select QC feats and per plate-cell line 1 intensity measure
plateQCfeats <- c("CellNumber", "Nuclei_Intensity_MeanIntensity_Image_Hoechst", "Nuclei_AreaShape_Area", "CellSpeed",
                  "Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1",
                  "Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3",
                  "Nuclei_Intensity_MeanIntensity_Image_GFP_p21",
                  "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1")

plateQC_data <- all.data[ fingerprints %in% plateQCfeats, ]



for(i in seq_along(plateQCfeats)){
# select feat and compound order
  subsetPlateQC <- plateQC_data[ fingerprints == plateQCfeats[i], ]

  subsetPlateQC[ , treatment := reorder(treatment, value, FUN = median) ]
  subsetPlateQC[ , plateID := reorder(plateID, value, FUN = median) ]
  
  
  pdf(file = paste0('../generated/results/plateQC/_plateQC_', plateQCfeats[i], '.pdf'), height = 200, width = 60)
p <- ggplot(data = subsetPlateQC, aes( x = treatment, y = value)) + geom_boxplot() + facet_wrap( ~plateID, ncol = 1) + theme( axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.4, size = 12 , 
                                    colour = "grey50") ) 

print(p)

dev.off()

}

# based on plate-QC plots: remove outliers, re-do plotting cycle for more detail (y-axis zoom)

# CellNumber: doxycycline & tetracycline & aflatoxin b1 100 uM: extreme high CellNumber counts in many plates (dozen interquantile ranges above)
# Chop nuclei int: menadione autofl, doxorubicin, doxycycline. 2013_12_11_DDIT3: penicillamine  2013_11_27_DDIT3 carmustine

all.data <- all.data[ treatment != 'doxycycline', ]
all.data <- all.data[ treatment != 'tetracycline', ]
all.data <- all.data[ !( treatment == 'aflatoxin b1' & dose_uM == 100), ]
all.data <- all.data[ treatment != 'menadione', ]
all.data <- all.data[ treatment != 'doxorubicin', ]
all.data <- all.data[ !( treatment == 'penicillamine' & plateID == '2013_12_11_DDIT3'), ]
all.data <- all.data[ !( treatment == 'carmustine' & plateID == '2013_11_27_DDIT3'), ]

# replot data with extra underscore
save(file = '../tmp/all.data.Rdata', all.data)
```


summarize quality control data to value per treatment + cmax  

```{r QC_compound_based}
sort(unique(all.data[, fingerprints]))

#load PI end point data 
# old part
PI.data <- as.data.table(
  read.delim(file = '../data/summary data files cell death/cytotox Summary Data.txt', sep = '\t', header=TRUE)
)
PI.data[ PI.data$treatment == "cyclosporin A" ,]
PI.data$treatment <- tolower(PI.data$treatment)

icam.files <- dir('../data/summary data files cell death/CD summary data ICAM1')
icam.path <- '../data/summary data files cell death/CD summary data ICAM1'

PI.data.icam = alist()
for( i in seq_along(icam.files)){
PI.data.icam[[i]] <- read.delim(file = paste(icam.path, icam.files[i], sep ="/"), sep = "\t")
}

PI.data.icam <- do.call('rbind', PI.data.icam)
head(PI.data)
head(PI.data.icam)
PI.data.icam$treatment <- tolower(PI.data.icam$treatment)



PI.data.icam <- as.data.table(PI.data.icam)
unique(PI.data.icam[, variable])
unique(PI.data.icam[ variable == "count_PI_obj_masked_primaryID_AreaShape_Area.DIV.Nuclei_obj_AreaShape_Area_larger_0.02", plateID])
unique(PI.data.icam[, variable])
PI.data.icam <-PI.data.icam[ variable == "count_PI_obj_masked_primaryID_AreaShape_Area.DIV.Nuclei_obj_AreaShape_Area_larger_0.02", ]
PI.data.icam[, variable := "necrosis_pos_TNF"  ]


unique(PI.data$variable)

PI.data <- PI.data[variable == "count_PI_obj_masked_primaryID_AreaShape_Area.DIV.Nuclei_obj_AreaShape_Area_larger_0.02_",]
PI.data[, variable := "necrosis_pos"]
PI.data$treatment <- tolower(PI.data$treatment)

# remove updated cmax compounds;
PI.data <- PI.data[ !treatment %in% newcmaxcomps, ]

# new part
pncmax <- '../data/summary data files cell death/nieuwcmax CD summary data/'
file.l <- dir(pncmax)
PI.data_ncmax = alist()
for( i in seq_along(file.l)){
PI.data_ncmax[[i]] <- read.delim(file = paste0(pncmax, file.l[i]), sep = "\t", header = TRUE)
}



PI.data_ncmax <- do.call('rbind', PI.data_ncmax)
PI.data_ncmax$treatment <- tolower(PI.data_ncmax$treatment)
PI.data_ncmax <- as.data.table(PI.data_ncmax)
unique(PI.data_ncmax[ , variable])
unique(PI.data_ncmax[plateID == "20150923_ICAM1" ,variable])

PI.data_ncmax <- PI.data_ncmax[ variable %in% c("count_PI_masked_primaryID_AreaShape_Area.DIV.Nuclei_AreaShape_Area_larger_0.02", 
                                "count_obj_final_PI_AreaShape_Area.DIV.obj_nuclei_AreaShape_Area_larger_0.02"), ]


unique(PI.data_ncmax[, plateID])

PI.data_ncmax[ , variable := 'necrosis_pos']
PI.data_ncmax$treatment <- tolower(PI.data_ncmax$treatment)
PI.data_ncmax[ grepl("ICAM1", plateID), variable := "necrosis_pos_TNF"]

PI.data_ncmax[, cell_line := "ICAM1"]
PI.data.icam[, cell_line := "ICAM1"]
PI.data.icam[ treatment == "dmso"]


PI.data_ncmax
PI.data
PI.data.icam


plot(density(PI.data$value), ylim = c(0,30))
lines(density(PI.data.icam$value), col = 'red')

length(PI.data.icam$value)

PI.data[, cell_line := NULL]
PI.data.icam[, cell_line := NULL]
PI.data.icam[, replID := NULL]
PI.data_ncmax[, cell_line := NULL]
PI.data <- rbind(PI.data_ncmax, PI.data, PI.data.icam)

table(PI.data[, variable])

sort(unique(PI.data$treatment))

# add cmax values to PI.data

lookupcmax <- unique(all.data[ , list(treatment, cmax, dose_uM)])
newCmax
lookupcmax <- rbind(lookupcmax, newCmax)
PI.data[, dose_uM := as.numeric(dose_uM)]
lookupcmax[, dose_uM := as.numeric(dose_uM)]


PI.data[, dose_uM := as.numeric(dose_uM)]
PI.data$dose_uM <- round(PI.data$dose_uM, digits = 4)

ind.more10 <- PI.data$dose_uM >= 10
PI.data$dose_uM[ind.more10] <- round(PI.data$dose_uM[ind.more10], digits = 1)
ind.more1 <- PI.data$dose_uM >= 1
PI.data$dose_uM[ind.more1] <- round(PI.data$dose_uM[ind.more1], digits = 2)

PI.data[, dose_uM := as.character(dose_uM)]
lookupcmax[, dose_uM := as.character(dose_uM)]


PI.data[, dose_uM := as.numeric(dose_uM)]
PI.data[ treatment%in% "carmustine" & dose_uM %in% 0.356, dose_uM:= 0.037]
PI.data[ treatment%in% "carmustine" & dose_uM %in% 1.78, dose_uM:= 5*0.037]
PI.data[ treatment%in% "carmustine" & dose_uM %in% 3.56, dose_uM:= 10*0.037]
PI.data[ treatment%in% "carmustine" & dose_uM %in% 8.90, dose_uM:= 25*0.037]
PI.data[ treatment%in% "carmustine" & dose_uM %in% 17.80, dose_uM:= 50*0.037]
PI.data[ treatment%in% "carmustine" & dose_uM %in% 35.60, dose_uM:= 100*0.037]


lookupcmax[, dose_uM := as.numeric(dose_uM)]
lookupcmax$dose_uM <- round(lookupcmax$dose_uM, digits = 4)

ind.more10 <- lookupcmax$dose_uM >= 10
lookupcmax$dose_uM[ind.more10] <- round(lookupcmax$dose_uM[ind.more10], digits = 1)
ind.more1 <- lookupcmax$dose_uM >= 1
lookupcmax$dose_uM[ind.more1] <- round(lookupcmax$dose_uM[ind.more1], digits = 2)

lookupcmax[, dose_uM := as.character(dose_uM)]
PI.data[, dose_uM := as.character(dose_uM)]

setkeyv(lookupcmax, c("treatment", "dose_uM"))
setkeyv(PI.data, c("treatment", "dose_uM"))

lookupcmax[ cmax == 25, cmax := "25cmax"]

PI.data <- lookupcmax[PI.data]


PI.data[ treatment == "aflatoxin b1" & is.na(cmax), cmax := "100cmax" ]

PI.data[ treatment == "digoxin" & dose_uM == 0.283,cmax := "100cmax" ]

PI.data[ treatment == "doxorubicin" & dose_uM == 1.18, cmax := "1cmax"]
PI.data[ treatment == "doxorubicin" & dose_uM == 5.92, cmax := "5cmax" ]
PI.data[ treatment == "doxorubicin" & dose_uM == 11.8,  cmax := "10cmax"]
PI.data[ treatment == "doxorubicin" & dose_uM == 59.1,  cmax := "50cmax"]
PI.data[ treatment == "doxorubicin" & dose_uM == 118.3,  cmax := "100cmax"]


PI.data[ treatment == "doxycycline" & dose_uM == 11.3, cmax := "1cmax"]
PI.data[ treatment == "doxycycline" & dose_uM == 56.3, cmax := "5cmax" ]
PI.data[ treatment == "doxycycline" & dose_uM == 112.6,  cmax := "10cmax"]
PI.data[ treatment == "doxycycline" & dose_uM == 562.9,  cmax := "50cmax"]
PI.data[ treatment == "doxycycline" & dose_uM == 1125.7,  cmax := "100cmax"]

PI.data[ treatment == "epinephrine" & is.na(cmax), cmax := "100cmax" ]

PI.data[ treatment == "haloperidol" & is.na(cmax), cmax := "100cmax"] 

PI.data[ treatment == "menadione" & dose_uM == 2.5, cmax := "1cmax"]
PI.data[ treatment == "menadione" & dose_uM == 12.5, cmax := "5cmax" ]
PI.data[ treatment == "menadione" & dose_uM == 25,  cmax := "10cmax"]
PI.data[ treatment == "menadione" & dose_uM == 125,  cmax := "50cmax"]
PI.data[ treatment == "menadione" & dose_uM == 250,  cmax := "100cmax"]

PI.data[ treatment == "moxisylyte" & is.na(cmax), cmax:= "100cmax" ]

PI.data[ treatment == "propranolol" & is.na(cmax), cmax := "50cmax" ]

PI.data[ treatment == "sulindac" & is.na(cmax), cmax := "50cmax" ]

PI.data[ treatment == "tetracycline" & dose_uM == 21, cmax := "1cmax"]
PI.data[ treatment == "tetracycline" & dose_uM == 104.8, cmax := "5cmax" ]
PI.data[ treatment == "tetracycline" & dose_uM == 209.6,  cmax := "10cmax"]
PI.data[ treatment == "tetracycline" & dose_uM == 1048.2,  cmax := "50cmax"]
PI.data[ treatment == "tetracycline" & dose_uM == 2096.3,  cmax := "100cmax"]


PI.data[ treatment == "tetracycline" , ] 


PI.data[is.na(cmax)] 

PI.data <- PI.data[ cmax != "25cmax", ]
unique(PI.data[, cmax])

PI.data_mean <- PI.data[ , lapply(.SD, function(x) list( mean(x), sd(x)))[[1]],
                                                  by = list(treatment, cmax,dose_uM, variable),
                                                  .SDcols = "value"]

setnames(PI.data_mean, old = c("variable", "V1", "V2"), new = c("fingerprints", "necrosis_pos", "sd"))


plot(density(PI.data_mean[  , necrosis_pos]))
sort(unique(PI.data_mean$treatment))

# calculate mean of values over time from time plate quality control data  


plateQC_data_mean <- plateQC_data[ , lapply(.SD, function(x) list( mean(x), sd(x)))[[1]],
                                                  by = list(treatment, cmax, fingerprints),
                                                  .SDcols = "value"]



setnames(plateQC_data_mean, old = "V1", new = "value")
setnames(plateQC_data_mean, old = "V2", new = "sd_value")
# calculate direction of qc values over time

model.results = list()
lmFun <- function(x) {
   lm( x$value ~ x$timeAfterExposure, data = x )$coefficients[2]
}

  
for( i in seq_along(plateQCfeats)){

  plateQC_data_sub <- plateQC_data[ fingerprints == plateQCfeats[i], ]
  plateQC_data_list <- split(plateQC_data_sub, paste(
  plateQC_data_sub$treatment, plateQC_data_sub$plateID, plateQC_data_sub$cmax, sep = '__'))

 model.results[[i]] <- as.data.frame(unlist(lapply( plateQC_data_list, lmFun )))
 model.results[[i]]$treatment <- lapply(strsplit( rownames(model.results[[i]]), split = '__'), '[[', 1)
 model.results[[i]]$cmax <- lapply(strsplit( rownames(model.results[[i]]), split = '__'), '[[', 3)
 model.results[[i]]$cmax <- gsub(".x\\$timeAfterExposure", "", model.results[[i]]$cmax)
 model.results[[i]]$fingerprints <- plateQCfeats[i]
}
length(model.results[[1]])
class(model.results[[1]])
dim(model.results[[1]])
head(model.results[[1]])


model.results.t <- do.call('rbind', model.results)
model.results.t <- as.data.table(model.results.t)
# calculate mean +sd for each compound - cmax combo (mean of slopes over plates)
setnames(model.results.t, old = 'unlist(lapply(plateQC_data_list, lmFun))', new = 'change')

mtcars.dt[, lapply(.SD, function(x) list(mean(x), median(x)))[[1]],
            by="cyl", .SDcols=c("mpg")]

model.results.t[, treatment := unlist(treatment)]
model.results.t.mean <- model.results.t[ , lapply(.SD, function(x) list( mean(x), sd(x)))[[1]],
                                                  by = list(treatment, cmax, fingerprints),
                                                  .SDcols = "change"]

setnames(model.results.t.mean, old = "V1", new = 'mean')
setnames(model.results.t.mean, old = "V2", new = 'sd')

# 3 datasets for QC
model.results.t.mean  # time course derived slopes, mean over plates
plateQC_data_mean # mean over plates & time of QC data 
PI.data_mean # mean of PI data over plates

save( file = "../tmp/model.results.t.mean.Rdata", model.results.t.mean)
save( file = "../tmp/plateQC_data_mean.Rdata", plateQC_data_mean)
save( file = "../tmp/PI.data_mean.Rdata", PI.data_mean)

# combine this data and create a QC - figure (TODO)

PI.data_mean[PI.data_mean$treatment == "digoxin",]

load( file = "../tmp/model.results.t.mean.Rdata")
load( file = "../tmp/plateQC_data_mean.Rdata")
load( file = "../tmp/PI.data_mean.Rdata")

PI.data_mean[ treatment == "cyclosporin a"]


```

Normalization of reporter responses by min-max normalization; $$ y = \frac{ x - x_{min} }{x_{max} - x_{min}} $$ , with `x_min` and `x_max` replicate-based. 
This plate normalization is valid if the underlying assumption holds that positive and negative controls exist on each plate and behave similarly on a biological level accros plates.

##laad sessie hier 16042017
```{r }
#save.image('../tmp/session_16032017.RData')

#load('../tmp/session_16032017.RData')
# min-max normalize intensity based data
all.data
all.data[ treatment =="acarbose" & cell_line == "ICAM1" ]

unique(all.data[ , fingerprints])
varsToNorm <- c("Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3", "Nuclei_Intensity_MeanIntensity_Image_Hoechst",
                 "Nuclei_Intensity_MeanIntensity_Image_GFP_p21",
                 "Cytoplasm_Intensity_MeanIntensity_Image_GFP_Srxn1", "Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1"
 )


# normFun performs the min max normalization on a per-replID basis, however first DMSO values are subtracted on a per-plate basis to control for plate-specific effects.


normFun <- function(dataIn, normVar) {
   
   buffer <- dataIn[ fingerprints%in% normVar] # select 1 variable
   #subtract DMSO per plate-time followed by min max single plate within replicates
   meanDMSO <-  buffer[ treatment %in% "dmso"  ,  
                        mean(value, na.rm=TRUE),
                        by = c("plateID", "timeID")
                        ]
   
   setkeyv(meanDMSO, c("plateID", "timeID"))
   setkeyv(buffer, c("plateID" ,"timeID"))
   
   buffer<- meanDMSO[buffer]
   buffer[, DMSO_sub.value:= value - V1 ]
   #buffer[, value:=NULL]
   
   buffer[, V1:=NULL]
   
   # min and max per replicate (because plates contain compound set for specific cmax's)
   
   minValue <- buffer[ , min(DMSO_sub.value, na.rm = TRUE), by = replID] 
   maxValue <- buffer[ , max(DMSO_sub.value, na.rm = TRUE), by = replID]
   # also the non DMSO subtracted data
   
   setkey(buffer, "replID")
   setkey(minValue, "replID")
   setkey(maxValue, "replID")
   
   buffer <- buffer[minValue]
   setnames(buffer, "V1", "minValue")
   setkey(buffer, "replID")
   buffer <- buffer[maxValue]
   setnames(buffer, "V1", "maxValue")
   
   
   minV <- buffer[ , min(value, na.rm = TRUE), by = replID] 
   maxV <- buffer[ , max(value, na.rm = TRUE), by = replID]
   
   setkey(minV, "replID")
   setkey(maxV, "replID")
   
   
   setkey(buffer, "replID")
   buffer <- buffer[maxV]
   setnames(buffer, "V1", "mvalue")
   setkey(buffer, "replID")
   buffer <- buffer[minV]
   setnames(buffer, "V1", "mivalue")
   
   
   buffer[, mmnvalue:= (DMSO_sub.value - minValue)/ 
            (maxValue-minValue)]
   
   buffer[, mmn_value:= (value - mivalue)/ 
            (mvalue-mivalue)]
   buffer[ ,DMSO_sub.value:=NULL ]
   buffer[ ,minValue:=NULL ]
   buffer[ ,maxValue:=NULL ]
   buffer[ ,mivalue:=NULL ]
   buffer[ ,mvalue:=NULL ]
   buffer[ ,value:=NULL ]
   
   buffer <- melt(buffer, id.vars = c("plateID", "timeID", "treatment", "dose_uM",
                                            "cell_line", "variable", "timeAfterExposure","replID", "cmax",
                                            "fingerprints"),
                  variable.name = 'var.temp')
   
   buffer[ var.temp == "mmnvalue", fingerprints := paste( "mmnDMSO.sub", variable, sep ="_")]
   buffer[ var.temp == "mmn_value", fingerprints := paste( "mmn", variable, sep ="_")]
   buffer[, var.temp := NULL]
   
   output <- buffer
   return(output)  
 }




# perform min max normalization
mmn.list = list()
 for( i in seq_along(varsToNorm)){
   
   mmn.list[[i]] <- normFun(dataIn = all.data, normVar = varsToNorm[i] )
 }
 
 mmn.df <- do.call("rbind", mmn.list)
 
 
 
 # perform min max normalization ICAM1 data
source('normFunICAM1.R')

ICAMnorm <- normFunIcam(dataIn = all.data.norm, normVar = "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1")

all.data.norm <- rbind(all.data.norm, ICAMnorm)

 head(mmn.df)
 
 all.data.norm <- rbind(all.data, mmn.df)
all.data.norm <- as.data.table(all.data.norm)
unique(all.data.norm[, fingerprints])

save( file = '../tmp/all.data.norm.Rdata', all.data.norm)

load('../tmp/all.data.norm.Rdata')
``` 

# select features relevant for ML and plot  

```{r select_feats_ML_plot }

# combine above and below to 1 feature (for the 2m version)


mean2above <- all.data.norm[ fingerprints %in% "mean2above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]
mean2bellow <- all.data.norm[ fingerprints %in% "mean2below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]

all(mean2above[, timeID] == mean2bellow[, timeID])
GFP_dif.m2_ICAM1 <- cbind( mean2above, mean2bellow[, value])
GFP_dif.m2_ICAM1[, GFP_dif.m2_ICAM1 := value - V2 ]
summary(GFP_dif.m2_ICAM1$GFP_dif.m2_ICAM1)
GFP_dif.m2_ICAM1$fingerprints <- "GFP_dif.m2_ICAM1"
GFP_dif.m2_ICAM1[, V2:=NULL]
GFP_dif.m2_ICAM1[, value:=NULL]

setnames(GFP_dif.m2_ICAM1, "GFP_dif.m2_ICAM1", "value")
GFP_dif.m2_ICAM1[, variable := NULL]


fingerprints <- unique(all.data.norm[, fingerprints])
all.data.norm[ fingerprints == "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP",]

selfingerprints <- c("mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP",
                     "mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP",
                     "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1")

selfingerprints <- c(selfingerprints, fingerprints[ grepl("2m", fingerprints)])




# include counting feature for the reporters (2m or 3m)

ML_data <- all.data.norm[ fingerprints %in% selfingerprints, ]
unique(ML_data[, fingerprints])



GFP_dif.m2_ICAM1
ML_data[ , variable := NULL]
ML_data <- rbind(ML_data, GFP_dif.m2_ICAM1)
unique(ML_data[ , list(fingerprints, cell_line)])


# select feats from quality control data for ML
unique(model.results.t.mean[ , fingerprints ])  # time course derived slopes, mean over plates
unique(plateQC_data_mean[ , fingerprints]) # mean over plates & time of QC data : nothing for ML
PI.data_mean # mean of PI data over plates

setnames(PI.data_mean, old = 'necrosis_pos', new = 'value')

QCslope_data <- model.results.t.mean[ fingerprints %in% c( "CellNumber", "Nuclei_AreaShape_Area", 
                                                           "Nuclei_Intensity_MeanIntensity_Image_Hoechst",
                                                           "CellSpeed")]

QCslope_data[, fingerprints := paste0('slope_', fingerprints )]
setnames(QCslope_data, old = 'mean', new = 'value')

QCslope_data[ , sd := NULL]
PI.data_mean[ , sd := NULL]
PI.data_mean[ , dose_uM := NULL]

ML_data_QC <- rbind(QCslope_data, PI.data_mean)


ML_data_QC[ cmax == "1", cmax := "1cmax"]
ML_data_QC[ cmax == "5", cmax := "5cmax"]
ML_data_QC[ cmax == "10", cmax := "10cmax"]
ML_data_QC[ cmax == "50", cmax := "50cmax"]
ML_data_QC[ cmax == "100", cmax := "100cmax"]

ML_data_QC[ , cmax := factor(cmax, levels = c("0cmax","1cmax", "5cmax", "10cmax", "50cmax", "100cmax"))]

write.table( ML_data, file = "../generated/summarydataDILI_screen.txt", sep ="\t", col.names = NA)
write.table(ML_data_QC, file = "../generated/QC_DILI_screen.txt", sep = "\t", col.names = NA)


MLfingerprints <- unique(ML_data[, fingerprints])
ML_QC_fingerprints <- unique(ML_data_QC[, fingerprints])

# plot data, to check normalization + for ML selected QC

# writepdfs <- "../generated/results/ML_data_time/"
# if(!dir.exists(writepdfs)){
#   dir.create(writepdfs)
# }
# 
# for( i in seq_along(MLfingerprints)){
# 
#   plotData <- ML_data[ fingerprints %in% MLfingerprints[i]]
#   
#   p <- ggplot(data =plotData, aes(x= timeAfterExposure, y=value, color = replID)) + facet_grid(treatment~cmax)
#   p<-p + geom_point(aes(color=replID, shape = replID)) + geom_line(aes(group=replID, color=replID)) + 
#     theme_sharp() + ggtitle( label = MLfingerprints[i]) 
#   pdf(file = paste(writepdfs, MLfingerprints[i], ".pdf", sep =""), width =12, height = 100)
#   print(p)
#   dev.off()
# 
#   }
# 
# writepdfs <- "../generated/results/ML_data_QC/"
# if(!dir.exists(writepdfs)){
#   dir.create(writepdfs)
# }
# 
# for( i in seq_along(ML_QC_fingerprints)){
# 
#   plotData <- ML_data_QC[ fingerprints %in% ML_QC_fingerprints[i]]
#   
#   p <- ggplot(data =plotData, aes(x= cmax, y=value )) + facet_wrap(~treatment)
#   p<-p + geom_point() + geom_line(aes(group=treatment)) + 
#     theme_sharp() + ggtitle( label = ML_QC_fingerprints[i]) 
#   pdf(file = paste(writepdfs, ML_QC_fingerprints[i], ".pdf", sep =""), width =30, height = 30)
#   print(p)
#   dev.off()
# 
#   }

```

extract time dynamics features  

```{r extract_time_dynamics_features }
source('D://src/lss_fda/celloscillate.R')

# first create a list with entries single time curves
# testje op 1 time curve

# some fixes of ML_data to enable single time curve defining
ML_data[ treatment == "dmso", dose_uM := "0"]
ML_data[ treatment == "dmso",]


ML_data <- ML_data[ !grepl("_c$", treatment), ]
ML_data <- ML_data[ treatment != "dmem", ]

ML_data[ , singleCurveName := paste(fingerprints,cell_line, treatment, cmax, replID, plateID)]

ML_data[ ,.N , by = list(singleCurveName) ][N>40]

# for dmso data there is no factor seperating the multiple well dmso treatments
# calculate mean of wells on per plate basis for dmso
ML_data[, singleCurveName:=NULL]

dmso_data <- ML_data[ treatment == "dmso"]
ML_data <- ML_data[ treatment != "dmso"]

dmso_data <- dmso_data[ ,  mean(value), by = list(treatment, dose_uM, plateID, timeID, cell_line, timeAfterExposure, replID, cmax, fingerprints )]
setnames(dmso_data, old = "V1", new = "value")
ML_data <- rbind(ML_data, dmso_data)

ML_data[ , singleCurveName := paste(fingerprints, cell_line, treatment, cmax, replID, plateID, sep = "__")]
ML_data[ ,.N , by = list(singleCurveName) ][N>40]

all.singleCurveNames <- unique(ML_data[ , singleCurveName])
save.image('../tmp/ML_data.Rdata')


allml <- na.omit(ML_data)
allml <- split( allml, allml$singleCurveName)


#pdf( "../generated/results/ML_time_fits_.pdf", width = 6, height = 6)

output <- lapply( allml, function(x) celloscillate(Frame = x$timeAfterExposure, value = x$value,  keepFrameTime = TRUE,
              locationID = x$singleCurveName, timeInterval = NULL,aboveRegr = 5, suppresMaxFrames = 5,
              slopeTH = 0.02,basisType = 'spline', plotFit = TRUE, plotDomains = FALSE, 
               slopeDomain = c("00:00:00", "08:00:00"), slopeDomain2 = c("08:00:00", "24:00:00"), timeToTH = c(0.2, 'absoluut'), maxValueTime = TRUE,
              nbasis = 13, lambda = 1, THpeaks = 0.1, f = 0.4,
               signal1 = NULL, signal2 = NULL, signal1TH = NULL, xCoord = NULL, yCoord = NULL, pix.x = NULL, pix.y=NULL, ylim = c(-1,1)) )
#dev.off()


tail(names(output))
names(output[[4]])
# select: maxslope + maxvalue + slopeDomain + slopeDomain2 + timeToTH + maxValueTime + valueStart + valueEnd

# maxslope
# maxvalue
# slopeDomain: (mean slope between 0 and 8 hours)
# slopeDomain: (mean slope between 8 and 24 hours)
# timeToTH: time that absoluut value of response is greater than 0.2
# maxValueTime: time where max value is reached
# valueStart: usefull for QC
# valueEnd: 



# to extract for example all perpeak_peakwidths do
 maxValueTime <- lapply(output, '[[', 'maxValueTime' )
 maxslope <- lapply( output, '[[', 'maxslope')
 maxvalue <- lapply( output, '[[', 'maxvalue')
 slopeDomain <- lapply( output, '[[', 'slopeDomain')
 slopeDomain2 <- lapply( output, '[[', 'slopeDomain2')
 timeToTH <- lapply( output, '[[', 'timeToTH')
 valueStart <- lapply( output, '[[', 'valueStart')
 valueEnd <- lapply( output, '[[', 'valueEnd')
 timeDomain <- lapply( output, '[[', 'timedomain')
 timeDomain <- sapply(timeDomain, '[[', 2)
 maxMagnitudeValue <- lapply( output, '[[', 'maxMagnitudeValue')
 # format into a usefull table


length(unlist(maxValueTime)) == length(unlist(maxValueTime)) 
length(unlist(maxValueTime)) == length(unlist(maxvalue))
length(unlist(maxvalue)) == length(unlist(slopeDomain))
length(unlist(slopeDomain)) == length(unlist(timeToTH))
length(unlist(timeToTH)) == length(unlist(slopeDomain2))
length(unlist(slopeDomain2)) == length(unlist(valueStart))
length(unlist(valueStart)) == length(unlist(valueEnd))



head(timedynamics_feats)
timedynamics_feats <- data.frame(maxValueTime = unlist(maxValueTime),
                           maxSlope = unlist(maxslope),
                           slopeDomain = unlist(slopeDomain),
                           slopeDomain2 = unlist(slopeDomain2),
                           valueStart = unlist(valueStart),
                           timeDomain = timeDomain,
                           maxMagnitudeValue = unlist(maxMagnitudeValue))
#_#
tail(timedynamics_feats)


lapply(timedynamics_feats, function(x) any(is.na(x)))

sum(is.na(timedynamics_feats$slopeDomain)) # these are the missing start curves. 

length(feature_names)

unique(rownames(timedynamics_feats))

feature_names <- unlist(lapply( strsplit(rownames(timedynamics_feats), "__"), "[[", 1 ))
cell_line_names <- unlist(lapply( strsplit(rownames(timedynamics_feats), "__"), "[[", 2 ))
treatment_names <- unlist(lapply( strsplit(rownames(timedynamics_feats), "__"), "[[", 3 ))
cmax_names <-  unlist(lapply( strsplit(rownames(timedynamics_feats), "__"), "[[", 4 ))
rep_names <-  unlist(lapply( strsplit(rownames(timedynamics_feats), "__"), "[[", 5 ))
unlist(lapply( strsplit(rownames(timedynamics_feats), "__"), "[[", 6 ))

timedynamics_feats$feature_names <- feature_names
timedynamics_feats$cell_line_names <- cell_line_names
timedynamics_feats$treatment_names <- treatment_names
timedynamics_feats$cmax_names <- cmax_names
timedynamics_feats$rep_names <- rep_names
ind1 <- which(grepl("Srxn1",timedynamics_feats$feature_names ))
ind2 <- which(grepl("p21",timedynamics_feats$feature_names ))
ind3 <- which(grepl("DDIT3",timedynamics_feats$feature_names ))
ind4 <- which(grepl("ICAM1",timedynamics_feats$feature_names ))

ind <- c(ind1, ind2, ind3, ind4)
timedynamics_feats$feature_names[-ind] <- paste(timedynamics_feats$feature_names[-ind], timedynamics_feats$cell_line_names[-ind], sep ="_")
unique(timedynamics_feats$feature_names)



head(timedynamics_feats)
dim(timedynamics_feats)
save(timedynamics_feats, file = '../tmp/timedynamics_feats.Rdata')
save( ML_data, file =  '../tmp/ML_data.Rdata')
load('../tmp/timedynamics_feats.Rdata')

```

plot time dynamics features dose-responses: decide on method to remove dose dimension but keep the dose information as intact as possible   likely solution is to expand the relevant variable X 5 (1 for each cmax) 

for example: choose the value where the value is max over the difference cmax. Also include lowest obs cmax for measure.  
This way the value itself for each compound is specified as max in dose-response. And also for each value the cmax where effect takes place.  
Note the use of cmax ( as numerical values ) and not dose, as dose is wildly different per compound. And we are interested in when the reporters pick up effect as compared to in clinic cmax benchmark.  


```{r plot_dose_response_timedynamics}


writepdfs <- "../generated/results/ML_data_dose_time_dynamics/"
if(!dir.exists(writepdfs)){
  dir.create(writepdfs)
}


timedynamics_feats <- data.table(timedynamics_feats)

lapply(timedynamics_feats, class)
timedynamics_feats_long <- melt(timedynamics_feats, id.vars = c('feature_names', 'cell_line_names', 'treatment_names', 'cmax_names', 'rep_names'))
timedynamics_feats_long[ , fingerprints := paste(feature_names, variable, sep = '_')]
ML_td_fingerprints <- unique(timedynamics_feats_long[, fingerprints])

# for( i in seq_along(ML_td_fingerprints)){
# 
#   plotData <- timedynamics_feats_long[ fingerprints %in% ML_td_fingerprints[i], ]
#   plotData[ , cmax := factor(cmax_names, levels = c('0cmax', '1cmax', '5cmax', '10cmax', '50cmax', '100cmax'))]
#   
#   p <- ggplot(data =plotData, aes(x= cmax, y=value, color = rep_names )) + facet_wrap(~treatment_names)
#   p<-p + geom_point() + geom_line(aes(group=rep_names)) + 
#     theme_sharp() + ggtitle( label = ML_td_fingerprints[i]) 
#   pdf(file = paste(writepdfs, ML_td_fingerprints[i], ".pdf", sep =""), width =50, height = 30)
#   print(p)
#   dev.off()
# 
#   }

## TODO remove based on QC plots and remove based on QC values




```



Select cmax data: max observations, also lowest observed effect level (loel) (decide which based on graphs)

### ML_data_QC  
necrosis positive:  
* max necrosis positive fraction irrespective of cmax value  
considering the rarity of compounds where significant cell death occurs at lower than 100 cmax, no further cmax features are included  

slope_CellNumber:  
This feature is a measure for cell death or cell proliferation (increase/decrease in cell number for each cmax and change of this slope over the cmax-range)
* max of slope_CellNumber (proliferative effect) 
* min of slope_CellNumber (toxicity effect)

slope_CellSpeed:  
* max of slope_CellSpeed  (increase migration speed) 
* min of slope_CellSpeed  (decrease migration speed/ increase toxicity)  

slope_Nuclei_AreaShape_Area:  
* max (flattening/ increase size)
* min (death/ apoptosis/ toxicity) 

slope_Nuclei_Intensity_MeanIntensity_Image_Hoechst:  
Seems to be a dose-dependent relation for nuclear hoechst intensity.  
Unsure what this feature would mean. One observed effect is increase in hoechst intensity for dying cells. Also autofluorescence of compounds is seen. 
* cmax_slope_Nuclei_hoechst_int (calculate linear int ~ cmax relation for each compound)

### timedynamics_feats_long  
63 features for each of 5 cmax values  
observe graphs (any effects concernable?), note replicate reproducability 

```{r select_cmax}
# decide how to summarize/ select cmax values
# decide which time derived features to use
# decide what to do with replicate oservations: keep or summarize--> summarize

unique(ML_data_QC[, fingerprints])
unique(timedynamics_feats[, feature_names])
unique(timedynamics_feats_long[, fingerprints])

# first the ML_data_QC data:
# necrosis positive: 
# 1) max cell death fraction per compound
# 2) 


```

Combine data, annotate data
```{r }
# combine data
timedynamics_feats_long[ , observations := paste(treatment_names, cmax_names, sep ="_")]

# calculate average over replicates

timedynamics_feats_long_mean <- timedynamics_feats_long[ , mean(value, na.rm = TRUE),
                                                         by = list( treatment_names, cmax_names, observations, fingerprints ) ]
setnames(timedynamics_feats_long_mean, old = 'V1', 'value')


ML_data_QC[ , observations := paste(treatment, cmax, sep = "_")]
ML_data_QC_mean <- ML_data_QC[ , mean(value, na.rm = TRUE),
                                                         by = list( treatment, cmax, observations, fingerprints ) ]
setnames(ML_data_QC_mean, old = c('treatment', 'cmax', 'V1'), new = c('treatment_names', 'cmax_names', 'value'))

ML_data_final_long <- rbind(timedynamics_feats_long_mean, ML_data_QC_mean)

ML_data_final_long[ treatment_names == "dmso", cmax_names := "100cmax"]
ML_data_final_long[ cmax_names == '0cmax',]
# cmax as features too;
#ML_data_final_long <- ML_data_final_long[ cmax_names != '0cmax',]

# replicate the DMSO over the 5 cmax values (there is effectively 1 dmso concentration)
dmso_tmp <- ML_data_final_long[ treatment_names == "dmso"]

dmso_tmp$cmax_names <- "1cmax"
dmso_tmp1 <- dmso_tmp
dmso_tmp$cmax_names <- "5cmax"
dmso_tmp_5 <- dmso_tmp
dmso_tmp$cmax_names <- "10cmax"
dmso_tmp_10 <- dmso_tmp
 dmso_tmp$cmax_names <- "50cmax"
dmso_tmp_50 <- dmso_tmp

ML_data_final_long <- rbind(ML_data_final_long, dmso_tmp1, dmso_tmp_5, dmso_tmp_10, dmso_tmp_50)
unique(ML_data_final_long[treatment_names == "dmso", cmax_names])

ML_data_final_long[ , fingerprints := paste( fingerprints, cmax_names, sep ="_" )]


sort(unique(ML_data_final_long$treatment_names))

ML_data_final_long[ treatment_names ==  "cyclosporin a", value]


ML_data_final <- dcast(data = ML_data_final_long, formula = treatment_names   ~ fingerprints, value.var = 'value' , fun = function(x) mean(x, na.rm=TRUE))
sort(unique(ML_data_final_long$treatment))
sort(unique(ML_data_final$treatment))

ML_data_final[1:5,1:5]

ind<- unique(which(is.na(ML_data_final), arr.ind = T)[,1])

ML_data_final[ind, 1:5]

inddd<- which(is.na(ML_data_final[ ML_data_final$treatment_names == "cyclosporin a",]))
ML_data_final[ ML_data_final$treatment_names == "cyclosporin a",]

colnames(ML_data_final)

ML_data_final<-as.data.table(ML_data_final)
dim(na.omit(ML_data_final))
dim((ML_data_final))
ML_data_final[, list(treatment_names, necrosis_pos_TNF_100cmax)]



ML_data_final <- na.omit(ML_data_final)
ML_data_final <- data.table(ML_data_final)




ML_data_final[treatment_names == "carbamazapine", treatment_names := 'carbamazepine']
#ML_data_final[treatment_names == "carbamazepine", observations := gsub('carbamazapine', 'carbamazepine', observations) ]
ML_data_final[treatment_names == "carbamazepine",1:4 ]
ML_data_final[treatment_names == "etoposide ", treatment_names := 'etoposide' ]

# annotate data
annotationData <- read.delim(file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep = "\t", header = T )

annotationData <- data.table(annotationData)

setkey(ML_data_final, 'treatment_names')  
setkey(annotationData, 'treatment')
dim(ML_data_final)
ML_data_final <- annotationData[ML_data_final]

ML_data_final[1:5,1:11]
ML_data_final[ treatment == "carbamazepine", 1:4]
save(ML_data_final, file = "../tmp/ML_data_final.Rdata")
colnames(ML_data_final)
sort(unique(ML_data_final$treatment))



#as.data.frame(unique(all.data.norm[cmax == "1cmax" & treatment == "tacrolimus", list(treatment,cmax, dose_uM)]))

```



Fit time curves for time course plots


```{r fit_time}
sort(unique(ML_data$treatment))
load('../tmp/ML_data.Rdata')

ML_data[treatment == "carbamazapine", treatment := 'carbamazepine']

ML_data[treatment == "carbamazepine",1:4 ]
ML_data[treatment == "etoposide ", treatment := 'etoposide' ]

sort(unique(ML_data[ , treatment]))

annotationData <- read.delim(file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep = "\t", header = T )

annotationData <- data.table(annotationData)

setnames(annotationData, old = "cmax", new = "onecmax")
setkey(ML_data, 'treatment')  
setkey(annotationData, 'treatment')

sort(unique(ML_data[, treatment]))

ML_data <- annotationData[ML_data]
# select data with fda label and correct dissolve
unique(ML_data[ ,Bob_anot ])

ML_data <- ML_data[ DILIConcern != "N/A",  ]
ML_data <- ML_data[ Bob_anot != "general_cytotox_reactive",  ]

ML_data <- ML_data[ EndDissolvedQuality != "no",  ]

sort(unique(ML_data$treatment))
# select features for plotting

ML_data <- ML_data[ fingerprints %in% c("GFP_pos.2m_Srxn1", "GFP_pos.2m_DDIT3", "GFP_pos.2m_p21", "GFP_dif.m2_ICAM1"), ]

# generate replicates for dmso per plate

replDMSO_srxn1 <- data.frame( plateID = unique(ML_data[ treatment == "dmso" & cell_line == "Srxn1", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(ML_data[ treatment == "dmso" & cell_line == "Srxn1", plateID])))),
       cell_line = "Srxn1", treatment ="dmso")


replDMSO_chop <- data.frame( plateID = unique(ML_data[ treatment == "dmso" & cell_line == "DDIT3", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(ML_data[ treatment == "dmso" & cell_line == "DDIT3", plateID])))),
       cell_line = "DDIT3", treatment = "dmso")

replDMSO_p21 <- data.frame( plateID = unique(ML_data[ treatment == "dmso" & cell_line == "p21", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(ML_data[ treatment == "dmso" & cell_line == "p21", plateID])))),
       cell_line = "p21", treatment = "dmso")

replDMSO_ICAM1 <- data.frame( plateID = unique(ML_data[ treatment == "dmso" & cell_line == "ICAM1", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(ML_data[ treatment == "dmso" & cell_line == "ICAM1", plateID])))),
       cell_line = "ICAM1", treatment = "dmso")

replDMSO <- rbind(replDMSO_srxn1, replDMSO_chop, replDMSO_p21, replDMSO_ICAM1)
replDMSO <- as.data.table(replDMSO)
setnames(replDMSO, old = "replID", new = "replID_dmso")
setkeyv(ML_data, c("plateID", "cell_line", "treatment"))
setkeyv(replDMSO, c("plateID", "cell_line", "treatment"))
ML_data <- replDMSO[ML_data]
ML_data[!is.na(replID_dmso), replID := replID_dmso]

ML_data[ , singleCurveName := paste(fingerprints, treatment, cmax, dose_uM, replID, sep = "__")]
length(ML_data$singleCurveName)


sort(unique(ML_data$treatment))

# testing for missing data; no missing data.
write.table(unique(ML_data[order( treatment,fingerprints, cmax, dose_uM) , list(treatment,fingerprints, cmax, dose_uM)]),
            file = "test.txt", sep = "\t")




GFP_data.list <- split(ML_data, ML_data$singleCurveName)
length(GFP_data.list)

ind<- lapply(GFP_data.list, function(x) { length(unique(x$timeAfterExposure)) }  )

head(ind)
sort(unique(unlist(ind)))

indd <- lapply(ind, function(x) x < 12)
inddd<- unlist(indd)
length(inddd)
sum(inddd)
length(GFP_data.list)
sum(inddd)

GFP_data.list.lowTP <- GFP_data.list[inddd]
length(GFP_data.list.lowTP)
ind3 <- lapply(GFP_data.list.lowTP, "[[", 'treatment')

ind3 <- (sapply(ind3, unique)) == "zimelidine" 
GFP_data.list.lowTP[ind3]

length(GFP_data.list)
GFP_data.list <- GFP_data.list[!inddd]
length(GFP_data.list.lowTP) 
length(GFP_data.list) 


model.results.GFP_data_lowTP = list()

#include the fitted parameters to perform a F-test
# perform t-test for fitted/sampled values after model fit

pdf(file = "../generated/results/model fit graphs_lowTPwithDMSO_replDMSO.pdf", height = 8, width = 12)

for( i in seq_along(GFP_data.list.lowTP) ){ #)

  # acarbose 0.1502 replicate_1 GFP_pos.m3sd_DDIT3
  fm1 <- lm(value ~ ns(timeAfterExposure, df =4), data = GFP_data.list.lowTP[[i]])
  model.results.GFP_data_lowTP[[i]] <-  predict(fm1, dtTime<-data.frame(
    timeAfterExposure = round(seq(0.6,23, length.out=22), digits=2)))
  model.results.GFP_data_lowTP[[i]] <- as.data.frame(model.results.GFP_data_lowTP[[i]] )
  colnames(model.results.GFP_data_lowTP[[i]])<- "mod"
  
  model.results.GFP_data_lowTP[[i]]$treatment <- unique(GFP_data.list.lowTP[[i]]$treatment)
  model.results.GFP_data_lowTP[[i]]$dose_uM <- unique(GFP_data.list.lowTP[[i]]$dose_uM)
  model.results.GFP_data_lowTP[[i]]$cmax <- unique(GFP_data.list.lowTP[[i]]$cmax)
  model.results.GFP_data_lowTP[[i]]$replID <- unique(GFP_data.list.lowTP[[i]]$replID)
  model.results.GFP_data_lowTP[[i]]$timeAfterExposure <- dtTime$timeAfterExposure
  model.results.GFP_data_lowTP[[i]]$fingerprints <- unique(GFP_data.list.lowTP[[i]]$fingerprints)
  
   p <- ggplot(data =  model.results.GFP_data_lowTP[[i]], aes(x=timeAfterExposure, y = mod)) + geom_point() + 
      geom_point(data= GFP_data.list.lowTP[[i]], aes(x=timeAfterExposure, y = value, color = replID)) + 
   ggtitle(unique(GFP_data.list.lowTP[[i]]$singleCurveName)) + ylim(c(-1.2,1.2))
  
  print(p)
}
dev.off()


model.results.GFP_data = list()

pdf(file = "../generated/results/model fit graphs with DMSO_replDMSO.pdf", height = 8, width = 12)
#nog een keer runnen (zonder pdf) - om fit p-waarden te extraheren
for( i in seq_along(GFP_data.list)){ #
  
  # acarbose 0.1502 replicate_1 GFP_pos.m3sd_DDIT3
  fm1 <- lm(value ~ ns(timeAfterExposure, df =8), data = GFP_data.list[[i]])
  model.results.GFP_data[[i]] <-  predict(fm1, dtTime<-data.frame(
    timeAfterExposure = round(seq(0.6,23, length.out=22), digits=2)))
  model.results.GFP_data[[i]] <- as.data.frame(model.results.GFP_data[[i]] )
  colnames(model.results.GFP_data[[i]])<- "mod"
  
  
  model.results.GFP_data[[i]]$treatment <- unique(GFP_data.list[[i]]$treatment)
  model.results.GFP_data[[i]]$dose_uM <- unique(GFP_data.list[[i]]$dose_uM)
  model.results.GFP_data[[i]]$cmax <- unique(GFP_data.list[[i]]$cmax)
  model.results.GFP_data[[i]]$replID <- unique(GFP_data.list[[i]]$replID)
  model.results.GFP_data[[i]]$timeAfterExposure <- dtTime$timeAfterExposure
  model.results.GFP_data[[i]]$fingerprints <- unique(GFP_data.list[[i]]$fingerprints)
  
  p <- ggplot(data =  model.results.GFP_data[[i]], aes(x=timeAfterExposure, y = mod)) + geom_line() + 
    geom_point(data= GFP_data.list[[i]], aes(x=timeAfterExposure, y = value, color = replID)) + 
    ggtitle(unique(GFP_data.list[[i]]$singleCurveName)) + ylim(c(-1.2,1.2))
  
  print(p)
  
  
  if((i%%500)==0){
   write.table(file = paste("../tmp/progres", i ,".txt", sep =""), i/5133 )
  }
  
}
dev.off()

##==##==##==##voor pauze
# dont forgot to combine low TP with high TP

#save.image("../tmp/20170331aftermodelrun.Rdata")

head(model.results.GFP_data[[3]])
model.results.GFP_data.df <- do.call("rbind", model.results.GFP_data)

sort(unique(model.results.GFP_data.df$treatment))
model.results.GFP_data_lowTP.df <- do.call("rbind", model.results.GFP_data_lowTP)

model.results.GFP_data.df <- rbind(model.results.GFP_data.df, model.results.GFP_data_lowTP.df)

model.results.GFP_data.df <- as.data.table(model.results.GFP_data.df)

save(model.results.GFP_data.df, file = '../tmp/model.results.GFP_data.df.RData')





```

```{r annotate}
#annotate again, after modeling
# donderdag pauze, vrijdag verder
sort(unique(model.results.GFP_data.df$treatment))
dir('../metadata')
anotData <- read.delim( file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt' , sep ="\t" , header = TRUE)
anotData <- as.data.table(anotData)
setnames( anotData, old ='cmax', new = 'onecmax' )
setkey(anotData, 'treatment')
setkey(model.results.GFP_data.df, 'treatment' )
model.results.GFP_data.df <- anotData[model.results.GFP_data.df]

model.results.GFP_data.df[DILIConcern == "Most-DILI-Concern", diliClass := "severe"]
model.results.GFP_data.df[DILIConcern != "Most-DILI-Concern", diliClass := "nonSevere"]



``` 

Create the time course figure

```{r, time_plots }
# calculate mean 
require(plyr)
sort(unique(model.results.GFP_data.df[, treatment]))

model.results.GFP_data.df.m <- model.results.GFP_data.df[ ,mean(mod, na.rm = TRUE) ,by = list(treatment, cmax, fingerprints, timeAfterExposure)]
model.results.GFP_data.df.s <- model.results.GFP_data.df[ ,sd(mod, na.rm = TRUE) ,by = list(treatment, cmax, fingerprints, timeAfterExposure)]                            
model.results.GFP_data.df.s
setnames(model.results.GFP_data.df.m, old = "V1", new = "meanR")
setnames(model.results.GFP_data.df.s, old = "V1", new = "sd")

unique(model.results.GFP_data.df$fingerprints)
unique(model.results.GFP_data.df$treatment)
all.treats <- unique(model.results.GFP_data.df$treatment)
length(all.treats)/3


model.results.GFP_data.df
model.results.GFP_data.df.m$treatment<- as.character(model.results.GFP_data.df.m$treatment)

model.results.GFP_data.df.m$treatment <- factor(model.results.GFP_data.df.m$treatment, levels =
                                                    sort(as.character(unique(model.results.GFP_data.df.m$treatment))) )
model.results.GFP_data.df.m <- as.data.table(model.results.GFP_data.df.m)
# for graphical purpose add dmso data for each cmax
dmso <- model.results.GFP_data.df.m[ cmax == "0cmax", ]

dmso$cmax  <- "1cmax"
model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
dmso$cmax  <- "5cmax"
model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
dmso$cmax  <- "10cmax"
model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
dmso$cmax  <- "50cmax"
model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
dmso$cmax  <- "100cmax"
model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)

model.results.GFP_data.df.m <- model.results.GFP_data.df.m[ cmax != "0cmax", ]

model.results.GFP_data.df.m[ , cmax := factor(cmax, levels =
                                                c("1cmax", "5cmax", "10cmax", "50cmax", "100cmax"))]


model.results.GFP_data.df.m[ , fingerprints := factor(fingerprints, levels =
 c("GFP_pos.2m_Srxn1", "GFP_pos.2m_DDIT3", "GFP_pos.2m_p21", "GFP_dif.m2_ICAM1"  ))]





(as.data.frame(model.results.GFP_data.df.m[ treatment == "digoxin", .N,by = list(cmax, fingerprints)]))

all.treats <- sort(as.character(unique(model.results.GFP_data.df.m$treatment)))

# color annot.
require(RColorBrewer)

DILIConcern <- c(brewer.pal(9,"YlOrRd")[c(1,3,6)])
hist(1:100 , col=DILIConcern)

names(DILIConcern) <- c("No-DILI-Concern","Less-DILI-Concern", "Most-DILI-Concern")

myColors <- list(DILIConcern = DILIConcern ) 

myColors$cmax <- brewer.pal(5, "BuGn" )
names(myColors$cmax) <- c("1cmax", "5cmax","10cmax", "50cmax", "100cmax")

myColors$reporter <- c("light blue", "green", "#CC6633", "purple")
names(myColors$reporter) <- c("Srxn1", "Chop", "p21", "Icam1")
unique(model.results.GFP_data.df.m[, fingerprints])
myColors$fingerprint <- c("blue", "seagreen", "#CC6633", "purple")
names(myColors$fingerprint) <- c("GFP_pos.2m_Srxn1", "GFP_pos.2m_DDIT3", "GFP_pos.2m_p21", "GFP_dif.m2_ICAM1"  )

119/3
40*2+39
length(1:40)
length(41:80)
length(81:length(all.treats))


if( !(dir.exists('../generated/results/time_figure'))){
  dir.create('../generated/results/time_figure')
}


sel.comps <- sort(all.treats)[1:40]
sel.comps <- sort(all.treats)[41:80]
sel.comps <- sort(all.treats)[81:length(all.treats)]

  pdf(file = "../generated/results/time_figure/time_fig 1 of 3 figure.pdf", height = 60, width = 10)
  p<- ggplot(data= model.results.GFP_data.df.m[ treatment %in% sel.comps, ]  , aes(x = timeAfterExposure, y = meanR, color = fingerprints)) + facet_grid(  treatment ~ cmax) +
    geom_line( size = 2)  + scale_color_manual(values=myColors$fingerprint) +
    theme_bw() +
    theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank()) 
  p <- p + coord_cartesian( ylim =c(-1.1,1.1))
  print(p)
  dev.off()

unique(model.results.GFP_data.df.m$treatment)

# sessie 31032017_afterTimePlots.Rdata gesaved
```



Create the dose response figure

```{r, dose_figure}
# calculate max in time

icamFun <- function(x) {
  ifelse(abs(max(x)) >= abs(min(x)), max(x), min(x))
}

model.results.GFP_data.df.m_maxtime <- model.results.GFP_data.df.m[ 
   , icamFun(meanR), 
by = list(treatment, cmax, fingerprints)]


setnames(model.results.GFP_data.df.m_maxtime, old = "V1", new = "maxR")
setnames(model.results.GFP_data.df.m_maxtime, old = "fingerprints", new = "fingerprint")
if( !(dir.exists('../generated/results/dose_figure'))){
  dir.create('../generated/results/dose_figure')s
}
sel.comps <- sort(all.treats)[1:42]
sel.comps <- sort(all.treats)[43:84]
sel.comps <- sort(all.treats)[85:length(all.treats)]

length(unique(model.results.GFP_data.df.m_maxtime[, treatment]))

unique(model.results.GFP_data.df.m_maxtime[, fingerprint])
pdf(file = "../generated/results/dose_figure/concentration_figure.pdf", height = 80, width = 10)
  p<- ggplot(data= model.results.GFP_data.df.m_maxtime  , aes(x = cmax, y = maxR, color = fingerprint)) + 
    geom_point(size = 3)+
  
   facet_grid(  treatment ~ fingerprint) +
    geom_line(aes(group = treatment), size = 2)  + 
    geom_hline(yintercept = 0, linetype = 2)+
    scale_color_manual(values=myColors$fingerprint) +
    theme_bw() +
    theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank()) 
  p <- p + coord_cartesian( ylim =c(-1.1,1.1))
  print(p)
  dev.off()


```




## Statistical learning; supervised classification  

* include lipophilicity value of compounds (based on fda paper)  
* include daily dose of oral medications

Classes:  
* DILI vs non-DILI  
* DILI vs less-DILI vs severe-sDILI  


```{r feature_selection_and_prediction}
require(ISLR)
require(leaps) # best subset selection

dim(ML_data_final)
#load( file = "../tmp/ML_data_final.Rdata")
ML_data_final[, 1:11]
colnames(ML_data_final)
sort(unique(ML_data_final$treatment))
density(ML_data_final[, GFP_dif.m2_ICAM1_maxMagnitudeValue_100cmax])
colnames(ML_data_final)
# remove general reactive compounds

unique(ML_data_final[ ,DILIConcern ])
ML_data_final <- ML_data_final[ DILIConcern != "N/A",]
table(ML_data_final[  ,EndDissolvedQuality  ])
unique(ML_data_final[, Bob_anot])
ML_data_final <- ML_data_final[ Bob_anot != "general_cytotox_reactive",  ]
ML_data_final <- ML_data_final[  EndDissolvedQuality != "no",  ]

ML_data_final_annot <-ML_data_final[,1:11]
ML_data_final_data <- ML_data_final[,-(1:11)]

ML_data_final_annot[DILIConcern == "Most-DILI-Concern", diliClass := "severe"]
ML_data_final_annot[DILIConcern != "Most-DILI-Concern", diliClass := "nonSevere"]

dim(ML_data_final)
ML_data_final_data[1:11, 1:11]



ML_data_final_annot$DILIConcern <- factor(ML_data_final_annot$DILIConcern )
colnames(ML_data_final_annot)
ML_data_final_annot$DILIConcern
ML_data_final_data[ , DILIConcern := ML_data_final_annot$DILIConcern ]
ML_data_final_data[ , EndDissolvedQuality := ML_data_final_annot$EndDissolvedQuality ]
ML_data_final_data[ , Bob_anot := ML_data_final_annot$Bob_anot ]
ML_data_final_data[ , diliClass := ML_data_final_annot$diliClass ]

save(ML_data_final_data, file = '../tmp/ML_data_final_data.Rdata')
save(ML_data_final_annot, file = '../tmp/ML_data_final_annot.Rdata')
dim(ML_data_final_data)
```



```{r visualization_exploration}

indmaxmag <- grepl( "maxMagnitudeValue", colnames(ML_data_final_data) )

ML_data_final_data[, indmaxmag, with = F]

sum(indmaxmag)
anothm <- ML_data_final_data[, list(DILIConcern, diliClass)]
head(ML_data_final_data[, indmaxmag, with = F])
rmCompsInd <- ML_data_final_data$DILIConcern == "N/A"
subSetexpl <- as.data.frame(ML_data_final_data[!rmCompsInd, indmaxmag, with = F])
rownames(subSetexpl) <- ML_data_final_annot$treatment[!rmCompsInd]
pdf("../generated/results/ML_data_QC/exploratory3.pdf", height = 32, width = 20)
aheatmap(subSetexpl, annRow = anothm[!rmCompsInd,])
dev.off()
annotationData[ DILIConcern == "No-DILI-Concern"]
table(paste0(anothm$DILIConcern))
unique(anothm[!rmCompsInd,DILIConcern])
```



feature selection, use training set (70%) for feature selection + SVM model tuning. Test on test set.
Repeat several times changing the training/test entries to check consistency of results
First add calculated BMC to data.
```{r Feature_selection}
colnames(ML_data_final_data)
dim(ML_data_final_data)
dim(ML_data_final_annot)


ML_data_final_annot$diliClass == ML_data_final_data$diliClass

ML_data_final_data$treatment <- ML_data_final_annot$treatment

ML_data_final_data$Bob_anot <- NULL
ML_data_final_data$EndDissolvedQuality <- NULL
ML_data_final_data$DILIConcern <- NULL


ML_data_final_data_long <- melt(ML_data_final_data, id.vars = c("diliClass", "treatment"))
ML_data_final_data_long <- dcast(data = ML_data_final_data_long, variable+ treatment ~ diliClass  )
ML_data_final_data_long <- as.data.table(ML_data_final_data_long)
ML_data_final_data_long

ML_data_final_data_long[!is.na(nonSevere) , value := nonSevere]
ML_data_final_data_long[is.na(nonSevere) , value := severe]

ML_data_final_data_long[ !is.na(nonSevere), class := "nonSevere"]
ML_data_final_data_long[ is.na(nonSevere), class := "severe"]
pdf(file ="../generated/results/density_variables_class.pdf", height = 60, width = 100)
ggplot(data = ML_data_final_data_long, aes(x=value, color = class)) + geom_density(aes(group = class)) + facet_wrap(~variable, scales = "free") +
  theme_minimal()
dev.off()
# simple feature selection method. Followed by removing highly correlated features.
head(ML_data_final_data_long)
unique(ML_data_final_data_long$variable)

# add BMC data (from later in script), note; adjusted outlier handling compared to BMC analysis later on

wp <- read.table(  file ="../generated/results/BMD_table.txt", sep ="\t")

BMC_data_add <- pp[pp$variable == "ED_est.Estimate",]
#dim(na.omit(BMC_data))
BMC_data_add <- as.data.table(BMC_data_add)
sort(unique(BMC_data_add[, treatment]))
length(unique(na.omit(BMC_data_add)[, treatment])) 

BMC_data_add <- merge(BMC_data_add, annotationData, by = "treatment", all.x = TRUE, all.y = FALSE)

head(BMC_data_add)
BMC_data_add <- as.data.table(BMC_data_add)

BMC_data_add[ , cmax := as.numeric(cmax)]

# replace outliers by NA
BMC_data_add[, iqr_BMC := IQR(value, na.rm = TRUE)]
BMC_data_add[abs(value) > (abs(value) + 3* iqr_BMC), value := NA ]

BMC_data_add[ value < 1*cmax , value := NA]
BMC_data_add[ value > 2*100*cmax, value := NA ]
BMC_data_add[ DILIConcern == "Most-DILI-Concern" , class := "severe"]
BMC_data_add[ DILIConcern != "Most-DILI-Concern" , class := "nonSevere"]
BMC_data_add[, diliClass := factor(class, levels = c("severe", "nonSevere"))]
BMC_data_add[ , cmaxnorn_BMC := log(value/cmax)]


# select per compound minimum value;
BMC_data_add <- BMC_data_add[ , min(value, na.rm = TRUE), by = list(treatment, cmax, class)]

setnames(BMC_data_add, old = "V1", new = "BMC")

BMC_data_add[ is.infinite(BMC), BMC := NA]

summary(BMC_data_add$BMC)

unique(BMC_data_add$treatment[ !is.na(BMC_data_add$BMC)])

# 81 compounds of 119 have a BMC value. remaining had a response < 0.25. NA values are not possible.
# add dummy values to non-responsive treatments; without variation between classes and significantly higher than max BMC's:

BMC_data_add[ is.na(BMC), BMC := 300 * cmax]

BMC_data_add[ , cmaxnorm_BMC := log(BMC/cmax)]
summary(BMC_data_add$cmaxnorm_BMC)

sort(unique(BMC_data_add[, treatment]))
BMC_data_add[ , cmax := log(cmax) ]
BMC_data_add[ , BMC := log(BMC) ]

BMC_data_add_long <- melt(BMC_data_add, id.vars = c('treatment', 'class'), variable.name = "variable" )

  ML_data_final_data_long[ , severe:=NULL]
 ML_data_final_data_long[ , nonSevere:=NULL]
 
 ML_data_final_data_long <- rbind(ML_data_final_data_long,BMC_data_add_long )
#KS test to asses difference in distributions of variables between the two classes
 # split data in training and test set.
all.ks.feats <- unique(ML_data_final_data_long[, variable])


all.treatsnoDMSO_dili <- unique(ML_data_final_data_long[treatment != "dmso", list(treatment, class)])
require(caret)
caseInd <- createDataPartition(all.treatsnoDMSO_dili$class,p=.7,list=FALSE)

table(all.treatsnoDMSO_dili[caseInd, class])
table(all.treatsnoDMSO_dili[-caseInd, class])

trainData_long<- as.data.frame(ML_data_final_data_long[ treatment %in% all.treatsnoDMSO_dili[caseInd, treatment] ])
testData_long <- as.data.frame(ML_data_final_data_long[ treatment %in% all.treatsnoDMSO_dili[-caseInd, treatment] ])

trainData_long <- as.data.table(trainData_long)

results.ks = alist()
for( i in seq_along(all.ks.feats)){
results.ks[[i]] <- ks.test(x = trainData_long[ variable == all.ks.feats[i] & class == "nonSevere" , value ],
                           y = trainData_long[ variable == all.ks.feats[i] & class == "severe" , value ],
                           alternative = "two.sided", exact = FALSE)
  
}

ks_results <- data.table(data.frame(feature = all.ks.feats, 
                                    statistic = sapply(results.ks, "[[", "statistic"),
                                    p.value = sapply(results.ks, "[[", "p.value")))

write.table(ks_results, file = "../generated/results/feat_sel_ks_results.txt", sep = "\t", col.names = NA)
ks_results <- ks_results[ order(ks_results$p.value), ]
sign_ks_results <- ks_results[ p.value <= 0.05, ]


ML_data_final_data$treatment[!unique(ML_data_final_data$treatment) %in% unique(BMC_data_add$treatment)] # dmso

BMC_data_add
ML_data_final_data[treatment == "dmso",]
#ML_data_final_data <- (merge(ML_data_final_data, BMC_data_add, by = 'treatment', all.x = TRUE))


ind <- colnames(ML_data_final_data) %in% sign_ks_results$feature
# sel_data is training data
sel_data <- as.data.frame(
  ML_data_final_data[ treatment %in% all.treatsnoDMSO_dili[caseInd, treatment], ind, with = FALSE]
)
dim(sel_data)

colnames(sel_data)
write.table(cor(sel_data), file = "../generated/results/selFeatsCormatrix.txt", sep ="\t")

cor_data <- cor(sel_data)
head(cor_data)

library('caret')
df2 = cor(sel_data)

hc = findCorrelation(abs(df2), cutoff=0.8) # putt any value as a "cutoff" 
hc = sort(hc)
reduced_Data = sel_data[,-c(hc)]
print(reduced_Data)
dim(reduced_Data)
colnames(reduced_Data)

write.table(reduced_Data, file = "../generated/results/reduced_sel_features.txt", sep ="\t")
write.table(cor(reduced_Data), file = "../generated/results/corr_reduced_sel_features.txt", sep ="\t")
sel_data <- reduced_Data
dim(sel_data)
colnames(sel_data)
selFeats <- colnames(sel_data)

cor(sel_data)

``` 




# SVM classifier, further feature selection & tuning on training set
```{r }

require(gbm)
require(MASS)
require(caret)
require(doParallel) # parallel processing
require(dplyr) # Used by caret
require(pROC) # 


dim(sel_data)


indKeep <-  colnames(ML_data_final_data) %in% selFeats
sum(indKeep)

indKeep <- indKeep | colnames(ML_data_final_data) %in% c("diliClass")

ML_data_final_data[, diliClass := ML_data_final_annot$diliClass ]
ML_data_final_data[, diliClass := factor(diliClass) ]

trainData <- as.data.frame(
  ML_data_final_data[ treatment %in% all.treatsnoDMSO_dili[caseInd, treatment] , indKeep, with = FALSE]
)
testData <- as.data.frame(
  ML_data_final_data[ treatment %in% all.treatsnoDMSO_dili[-caseInd, treatment] , indKeep, with = FALSE]
)

trainData$diliClass <- factor(trainData$diliClass, levels =c("severe","nonSevere"))
testData$diliClass <- factor(testData$diliClass, levels =c("severe","nonSevere"))
dim(testData)

# feature selection on 26 features using ga selection with svm

trainX <-trainData[, !colnames(trainData) %in% 'diliClass'] # Create training feature data frame
testX <- testData[,!colnames(trainData) %in% 'diliClass'] # Create test feature data frame 
y=trainData$diliClass # Target variable for training
#Next run the GA. Note the first line of code registers the parallel workers to set up for having the caret run the GA in parallel using the 4 cores on my Windows laptop. 


# registerDoParallel(7)
# 
# 
# ga_ctrl <- gafsControl(functions = rfGA, # Assess fitness with RF
#                        method = "cv",    # 10 fold cross validation
#                        genParallel=TRUE, # Use parallel programming
#                        allowParallel = TRUE
# 
#                        )
# 
# 
# set.seed(10)
# lev <- c("severe","nonSevere")     # Set the levels
# ##warenwe 
# 
# system.time(rf_ga2 <- gafs(x = trainX, y = y,
#                            iters = 200, # 200 generations of algorithm
#                            popSize = 15, # population size for each generation
#                            levels = lev,
#                            gafsControl = ga_ctrl
#                            ))
# registerDoParallel(7)
# system.time(rf_ga3 <- gafs(x = trainX, y = y,
#                            iters = 200, # 200 generations of algorithm
#                            popSize = 10, # population size for each generation
#                            levels = lev,
#                            gafsControl = ga_ctrl
#                            ))
# registerDoParallel(7)
# system.time(rf_ga4 <- gafs(x = trainX, y = y,
#                            iters = 100, # 200 generations of algorithm
#                            popSize = 30, # population size for each generation
#                            levels = lev,
#                            gafsControl = ga_ctrl
#                            ))
# 
# rf_ga
# rf_ga2
# rf_ga3
# rf_ga4
# 
# plot(rf_ga)
# plot(rf_ga2)
# plot(rf_ga3)
# plot(rf_ga4)
# 
# # TRY 2 AND 4
# 
# rf_ga$ga$final
# rf_ga2$ga$final
# rf_ga3$ga$final
# rf_ga4$ga$final
# 
# Reduce(intersect, list(rf_ga$ga$final,rf_ga2$ga$final,rf_ga3$ga$final,rf_ga4$ga$final))

#This next section of code trains an SVM using only the selected features setting up a grid to search the parameter #space; again, using the parallel computing feature built into caret.

#final <- rf_ga2$ga$final # Get features selected by GA
#trainX2 <- as.data.frame(trainX[,final]) # training data: selected features
#testX2 <- as.data.frame(testX[,final]) # test data: selected features

# no fs?

trainX2 <- as.data.frame(trainX) # training data: selected features
testX2 <- as.data.frame(testX) # test data: selected features



## SUPPORT VECTOR MACHINE MODEL
 dim(testX2)
#Note the default method of picking the best model is accuracy and Cohen's Kappa 
# Set up training control
ctrl <- trainControl(method="repeatedcv", # 10fold cross validation
                     number = 10,
repeats=10, # do 5 repititions of cv
summaryFunction=twoClassSummary, # Use AUC to pick the best model
classProbs=TRUE)
 
#Use the expand.grid to specify the search space 
#Note that the default search grid selects 3 values of each tuning parameter
 
grid <- expand.grid(interaction.depth = c(1,2,3), #tree depths from 1 to 4
n.trees=seq(10,100,by=10), # let iterations go from 10 to 100
shrinkage=c(0.01,0.1), # Try 2 values fornlearning rate 
n.minobsinnode = 20)
# 
# Set up for parallel processing
set.seed(1951)
registerDoParallel(6,cores=8)
 
 #support vector machine or random forest that deals well with a large number of predictors.
#Train and Tune the SVM
psvmTuneGrid <- expand.grid(C=seq(0.005,0.1, length.out=5), sigma=seq(0.0005, 0.1, length.out=5))
svm.tune <- train(x=trainX2,
                  y= trainData$diliClass,
                  method = "svmRadial",
                  degree = 2,
                 # tuneLength = 9, # 9 values of the cost function
                  preProc = c("center","scale"),
                  metric="ROC",
                  trControl=ctrl,
                 tuneGrid=psvmTuneGrid
                 ) # same as for gbm above

svm.tune
#Finally, assess the performance of the model using the test data set.

#Make predictions on the test data with the SVM Model

svm.pred <- predict(svm.tune, newdata = testX2, type = "raw")

confusionMatrix(svm.pred,testData$diliClass)



svm.probs <- predict(svm.tune,testX2,type="prob") # Gen probs for ROC
 
svm.ROC <- roc(predictor=svm.probs$severe,
               response=testData$diliClass,
               levels=rev(levels(testData$diliClass)))
svm.ROC
#Area under the curve: 0.8881
plot(svm.ROC,main="ROC for SVM built with GA selected features")


#====#====+#=====#+==


svmFit_lin <- train( diliClass~ ., data = ML_data_final_data_sel[ ML_data_final_data$treatment != "dmso",], 
                 method = "svmRadial", degree = 1, 
                 trControl = fitControl, 
                 preProc = c("center", "scale"),
                tuneLength = 12,
                 metric = "ROC"
                 #tuneGrid = psvmTuneGrid
                 )


psvmTuneGrid <- expand.grid(C=c(0.01,0.05,0.1), degree=c(1,2,3), scale=c( 0.01, 0.25,0.5,1))
svmFit_poly <- train( diliClass~ ., data = ML_data_final_data_sel[ ML_data_final_data$treatment != "dmso",], 
                 method = "svmPoly", 
                 trControl = fitControl, 
                 preProc = c("center", "scale"),
                # tuneLength = 12,
                 metric = "ROC",
                 tuneGrid = psvmTuneGrid
                 )



# evalueer resultaten en schrijf weg



print(sum(predict(svmFit, newdata = ML_data_final_data_sel[-trainInd, ] ) == ML_data_final_data_sel$diliClass[-trainInd])/ length(ML_data_final_data_sel$diliClass[-trainInd]))
resultTest[[i]] <- sum(predict(svmFit, newdata = ML_data_final_data_sel[-trainInd, ] ) == ML_data_final_data_sel$diliClass[-trainInd])/ length(ML_data_final_data_sel$diliClass[-trainInd])
}

mean(unlist(resultTest))

sum(predict(svmFit, newdata = ML_data_final_data_sel ) == ML_data_final_data_sel$diliClass)/ length(ML_data_final_data_sel$diliClass)



```




```{r heatmap_sel_features_prediction}
dim(ML_data_final_data_sel)
# annotate DILI class and reporter type / cytotox

annotationData <- read.delim(file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep = "\t", header = T )

annotationData <- data.table(annotationData)
setnames(annotationData, old = "cmax", new = "cmaxDose")

ML_data_final_data_sel$treatment <- ML_data_final_annot$treatment
setkey(ML_data_final_data_sel, 'treatment')  
setkey(annotationData, 'treatment')
hm_data_metadata <- annotationData[ML_data_final_data_sel]
dim(hm_data_metadata)
colnames(hm_data_metadata)
hm_data_data <- hm_data_metadata[, -c(1:11,ncol(hm_data_metadata)), with = FALSE]
hm_data_metadata <- hm_data_metadata[, c(1:11,ncol(hm_data_metadata)), with = FALSE]
require(RColorBrewer)

#diliClass <-  c(brewer.pal(9,"YlOrRd")[c(1,6)])
#DILIConcern <- c(brewer.pal(9,"YlOrRd")[c(1, 2, 3,6)])

names(DILIConcern) <- c("No-DILI-Concern", "Ambiguous DILI-concern", "Less-DILI-Concern", "Most-DILI-Concern")
names(diliClass) <- c("nonSevere", "severe")

myColors <- list(DILIConcern = DILIConcern, diliClass = diliClass ) 


myColors$type <- c("light blue", "light green", "#CC6633", "purple", "black")
names(myColors$type) <- c("Srxn1", "Chop", "p21", "Icam1", "tox")
hist(1:100, col =myColors$reporter)

#hm_data_metadata$diliClass <- factor(hm_data_max$diliClass, levels =c("severe", "nonSevere"))
treatmentAnot<-data.frame(DILIConcern = hm_data_metadata$DILIConcern, diliClass = hm_data_metadata$diliClass)



# annotate columns, 

ind_srxn1<- which(grepl("Srxn1", colnames(hm_data_data)))
ind_p21<- which(grepl("p21", colnames(hm_data_data)))
ind_DDIT3<- which(grepl("DDIT3", colnames(hm_data_data)))
ind_ICAM1<- which(grepl("ICAM1", colnames(hm_data_data)))

ind_tox<- c(1:ncol(hm_data_data))[-c(ind_srxn1, ind_p21, ind_DDIT3, ind_ICAM1)]

reporter_anot <- data.frame(type = rep(NA, ncol(hm_data_data)))
reporter_anot$type[ind_srxn1] <- "Srxn1"
reporter_anot$type[ind_p21] <- "p21"
reporter_anot$type[ind_DDIT3] <- "Chop"
reporter_anot$type[ind_ICAM1] <- "Icam1"
reporter_anot$type[ind_tox] <- "tox"

annCol <- list(type =
  reporter_anot$type
    )

min(hm_data_data, na.rm=TRUE)

colBreaks <- seq(min(scale(hm_data_data), na.rm=TRUE)-2, max(scale(hm_data_data), na.rm=TRUE), length.out = 50)

#colBreaks <-c(  -seq(1.01, 0.411, length.out = 8), -seq( 0.4, 0.01, length.out=16)  , 
#                c(seq(0.01, 0.4,length.out=16), seq(0.411,1.01, length.out = 8)) )

my.colors <- c(rev(brewer.pal(9, "YlGnBu")) , brewer.pal(9, "YlOrRd"))

#my.colors <-  brewer.pal(9, "YlOrRd")


pie(rep(1, length(my.colors)), labels = sprintf("%d (%s)", seq_along(my.colors), 
                                                my.colors), col = my.colors)


library(dendextend)
hm_data_data <- as.data.frame(hm_data_data)
rownames(hm_data_data) <- hm_data_metadata$treatment
dist_hm_data <- dist(scale(hm_data_data), method = c("euclidean", "maximum", "manhattan", "canberra", "binary" , "minkowski")[3])

clust_hm_data<-hclust(dist_hm_data, method = c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median","centroid")[1])
dd <- as.dendrogram(clust_hm_data)
#dd.reorder <- reorder(dd, wts =  c(150, 125:2))

#cutree(dd.reorder,h=7) # it now works on a dendrogram#
# It is like using:
#dend1 <-dendextend:::cutree.dendrogram(dd.reorder,h=7)

dend1 <- color_branches(dd, k = 4)
dend1 <- color_labels(dend1, k = 4)
plot(dend1)

pdf("../generated/results/heatmap/rowClusterDendogram_manh_wardD_k4.pdf", width = 24, height = 10)
plot(dend1)
dev.off()


hm_data_rowOrder <- labels(dend1)

indOrder <- match( hm_data_rowOrder, rownames(hm_data_data))

# cluster columns
dist_hm_data2 <- dist(t(scale(hm_data_data)), method = c("euclidean", "maximum", "manhattan", "canberra", "binary" , "minkowski")[3])
clust_hm_data2<-hclust(dist_hm_data2, method = c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median","centroid")[1])

hm_data_colOrder <- labels(clust_hm_data2)

colIndex <- match( hm_data_colOrder, colnames(hm_data_data))


head(hm_data_data)
pdf("../generated/results/heatmap/heatmap_manh_wardD.pdf", width= 12, height = 18)
aheatmap(hm_data_data[ indOrder ,colIndex], Rowv = NA, Colv=NA, scale = "column",
         color = my.colors, breaks = colBreaks,
         fontsize = 10, width = 10, height=10, legend = TRUE,
         annRow = treatmentAnot[indOrder, , drop = F] , annCol = as.data.frame(annCol)[colIndex,, drop = FALSE], annColors = myColors   #,txt =hm_data_data[ indOrder ,colIndex]
)

dev.off()




```



#== check of dit nog klopt. (input data)

```{r heatmap}
#rm("all.data.norm")

which("digoxin" == unique(all.data.norm$treatment))

load('../tmp/all.data.norm.Rdata')
colnames(all.data.norm)
unique(all.data.norm[, fingerprints])
all.data.norm[, variable:=NULL]
# add ICAM1 total fractions:

all.data.norm[ treatment == "acarbose" & cell_line == "ICAM1", ]


all.data.norm <- all.data.norm[ fingerprints != "GFP_dif.m1_ICAM1", ]
all.data.norm <- all.data.norm[ fingerprints != "GFP_dif.m2_ICAM1", ]
all.data.norm <- all.data.norm[ fingerprints != "GFP_dif.m3_ICAM1", ]


unique(all.data.norm[, fingerprints])
mean1above <- all.data.norm[ fingerprints %in% "mean1above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]
mean1bellow <- all.data.norm[ fingerprints %in% "mean1below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]

all(mean1above[, timeID] == mean1bellow[, timeID])
GFP_dif.m1_ICAM1 <- cbind( mean1above, mean1bellow[, value])

GFP_dif.m1_ICAM1[, GFP_dif.m1_ICAM1 := value - V2 ]
summary(GFP_dif.m1_ICAM1$GFP_dif.m1_ICAM1)
GFP_dif.m1_ICAM1$fingerprints <- "GFP_dif.m1_ICAM1"
GFP_dif.m1_ICAM1[, V2:=NULL]
GFP_dif.m1_ICAM1[, value:=NULL]

setnames(GFP_dif.m1_ICAM1, "GFP_dif.m1_ICAM1", "value")

all.data.norm <- rbind( all.data.norm, GFP_dif.m1_ICAM1 )

plot(density(all.data.norm[ fingerprints == "GFP_dif.m1_ICAM1" & treatment == "dmso", value]))

# for mean 2
mean2above <- all.data.norm[ fingerprints %in% "mean2above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]
mean2bellow <- all.data.norm[ fingerprints %in% "mean2below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]

all(mean2above[, timeID] == mean2bellow[, timeID])
GFP_dif.m2_ICAM1 <- cbind( mean2above, mean2bellow[, value])
GFP_dif.m2_ICAM1[, GFP_dif.m2_ICAM1 := value - V2 ]
summary(GFP_dif.m2_ICAM1$GFP_dif.m2_ICAM1)
GFP_dif.m2_ICAM1$fingerprints <- "GFP_dif.m2_ICAM1"
GFP_dif.m2_ICAM1[, V2:=NULL]
GFP_dif.m2_ICAM1[, value:=NULL]

setnames(GFP_dif.m2_ICAM1, "GFP_dif.m2_ICAM1", "value")
all.data.norm <- rbind( all.data.norm, GFP_dif.m2_ICAM1 )

plot(density(all.data.norm[ fingerprints == "GFP_dif.m2_ICAM1" & treatment == "dmso", value]))
# for mean3

mean3above <- all.data.norm[ fingerprints %in% "mean3above_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]
mean3bellow <- all.data.norm[ fingerprints %in% "mean3below_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"]

all(mean3above[, timeID] == mean3bellow[, timeID])
GFP_dif.m3_ICAM1 <- cbind( mean3above, mean3bellow[, value])
GFP_dif.m3_ICAM1[, GFP_dif.m3_ICAM1 := value - V2 ]
summary(GFP_dif.m3_ICAM1$GFP_dif.m3_ICAM1)
GFP_dif.m3_ICAM1$fingerprints <- "GFP_dif.m3_ICAM1"
GFP_dif.m3_ICAM1[, V2:=NULL]
GFP_dif.m3_ICAM1[, value:=NULL]

setnames(GFP_dif.m3_ICAM1, "GFP_dif.m3_ICAM1", "value")
all.data.norm <- rbind( all.data.norm, GFP_dif.m3_ICAM1 )
plot(density(all.data.norm[ fingerprints == "GFP_dif.m3_ICAM1" & treatment == "dmso", value]))



all.data.norm[cell_line == "ICAM1"]
source('normFunICAM1.R')
source('normFunICAM1_noDMSO_sub.R')
all.data.norm <- all.data.norm[ fingerprints != "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1",]

ICAMnorm <- normFunIcam(dataIn = all.data.norm, normVar = "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1")

ICAMnormNoDMSOSub <- normFunIcamnodmso(dataIn = all.data.norm, normVar = "obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1")

all.data.norm <- rbind(all.data.norm, ICAMnorm)
all.data.norm <- rbind(all.data.norm, ICAMnormNoDMSOSub)

save(all.data.norm, file = '../tmp/all.data.norm.Rdata')
load('../tmp/all.data.norm.Rdata')
unique(all.data.norm[ , fingerprints])

# normalize ICAM1 to DMSO, by subtracting median dmso value from all ICAM1 values

ICAM1_dmso <- all.data.norm[ fingerprints == "GFP_dif.m2_ICAM1" & treatment == "dmso",
                           mean(value, na.rm=TRUE), by = list(timeAfterExposure) ]

setnames(ICAM1_dmso, old = 'V1', new = 'ICAM1_dmso')
setkey(ICAM1_dmso, 'timeAfterExposure')
setkey(all.data.norm, 'timeAfterExposure')
all.data.norm<- ICAM1_dmso[ all.data.norm]


all.data.norm[ fingerprints == "GFP_dif.m2_ICAM1",
                           value := value - ICAM1_dmso ]


all.data.norm[, ICAM1_dmso:= NULL]

plot(density(all.data.norm[ fingerprints == "GFP_dif.m2_ICAM1" & treatment == "dmso", value]))

##==

ICAM1_dmso <- all.data.norm[ fingerprints == "GFP_dif.m1_ICAM1" & treatment == "dmso",
                            mean(value, na.rm=TRUE), by = list(timeAfterExposure) ]

setnames(ICAM1_dmso, old = 'V1', new = 'ICAM1_dmso')
setkey(ICAM1_dmso, 'timeAfterExposure')
setkey(all.data.norm, 'timeAfterExposure')
all.data.norm<- ICAM1_dmso[ all.data.norm]

all.data.norm[ fingerprints == "GFP_dif.m1_ICAM1",
                           value := value - ICAM1_dmso ]

all.data.norm[, ICAM1_dmso:= NULL]
plot(density(all.data.norm[ fingerprints == "GFP_dif.m1_ICAM1" & treatment == "dmso", value]))

##==

ICAM1_dmso <- all.data.norm[ fingerprints == "GFP_dif.m3_ICAM1" & treatment == "dmso",
                            mean(value, na.rm=TRUE), by = list(timeAfterExposure) ]

setnames(ICAM1_dmso, old = 'V1', new = 'ICAM1_dmso')
setkey(ICAM1_dmso, 'timeAfterExposure')
setkey(all.data.norm, 'timeAfterExposure')
all.data.norm<- ICAM1_dmso[ all.data.norm]

all.data.norm[ fingerprints == "GFP_dif.m3_ICAM1",
                           value := value - ICAM1_dmso ]
all.data.norm[, ICAM1_dmso:= NULL]
plot(density(all.data.norm[ fingerprints == "GFP_dif.m3_ICAM1" & treatment == "dmso", value]))
##==

plot(density(all.data.norm[ fingerprints == "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1" & treatment == "dmso", value]))

unique(all.data.norm[ , fingerprints])
ICAM1_dmso <- all.data.norm[ fingerprints == "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1" & treatment == "dmso",
                            mean(value, na.rm=TRUE), by = list(timeAfterExposure) ]


setnames(ICAM1_dmso, old = 'V1', new = 'ICAM1_dmso')
setkey(ICAM1_dmso, 'timeAfterExposure')
setkey(all.data.norm, 'timeAfterExposure')
all.data.norm<- ICAM1_dmso[ all.data.norm]

all.data.norm[ fingerprints == "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1",
                           value := value - ICAM1_dmso ]
all.data.norm[, ICAM1_dmso:= NULL]
##==


unique(all.data.norm[, fingerprints])

all.data.norm[ grepl("mmnDMSO.sub", fingerprints),fingerprints:= paste(fingerprints , cell_line, sep = "_")]

all.data.norm[ ,fingerprints := gsub("mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1_ICAM1",
                      "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1",
                      fingerprints)]

hm_feats <- c("mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1", "GFP_pos.m3sd_Srxn1", "GFP_pos.3m_Srxn1", "GFP_pos.2m_Srxn1", 
              "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3", "GFP_pos.m3sd_DDIT3", "GFP_pos.3m_DDIT3", "GFP_pos.2m_DDIT3",
              "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_p21", "GFP_pos.m3sd_p21", "GFP_pos.3m_p21", "GFP_pos.2m_p21",
              "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1", "GFP_dif.m3_ICAM1", "GFP_dif.m2_ICAM1", "GFP_dif.m1_ICAM1" )

hm_data <- all.data.norm[ fingerprints %in% hm_feats]
unique(hm_data[, fingerprints])


# change names to more suitable for publication. 

hm_data[ fingerprints == "mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1", fingerprints := "Int_Srxn1" ]
hm_data[ fingerprints == "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3", fingerprints := "Int_Chop" ]
hm_data[ fingerprints == "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_p21", fingerprints := "Int_p21" ]
hm_data[ fingerprints == "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1", fingerprints := "Int_Icam1" ]
hm_data[ ,fingerprints := gsub("DDIT3", "Chop", fingerprints)]
hm_data[ ,fingerprints := gsub("ICAM1", "Icam1", fingerprints)]
unique(hm_data[, fingerprints])

# calculate max of each time curve

hm_data[ , .N, by = list(treatment, plateID, cmax, fingerprints, replID, dose_uM)]



icamFun2 <- function(x) {
  ifelse(abs(max(x, na.rm=T)) >= abs(min(x,na.rm=T)), max(x,na.rm=T), min(x,na.rm=T))
}

hm_data_max <- hm_data[ , icamFun2(value), by = list(treatment, plateID, cmax, fingerprints, replID, dose_uM)]

hm_data_max <- hm_data_max[ , mean(V1, na.rm= TRUE), by = list(treatment, cmax, fingerprints)]
setnames(hm_data_max, old = "V1", new = "value")


annotationData <- read.delim(file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep = "\t", header = T )

annotationData <- data.table(annotationData)
severityClass <- read.delim( file = '../metadata/severityClass.txt', sep = "\t", header = T)
severityClass <- data.table(severityClass)
setkey(annotationData, 'treatment' )
setkey(severityClass, 'LabelCompoundName' )
annotationData <- severityClass[annotationData]
setnames(annotationData, old = 'LabelCompoundName', new = 'treatment' )
setnames(annotationData, old = "cmax", new = "cmaxDose")
annotationData <- annotationData[Bob_anot != 'general_cytotox_reactive']
annotationData <- annotationData[DILIConcern != 'N/A',]
annotationData <- annotationData[EndDissolvedQuality != 'no']
table(annotationData$SeverityLabel)
annotationData[ SeverityLabel == 0,SeverityLabel := 'No match']

write.table(annotationData, file ='../tmp/annotatie_met_severityLabel.txt' , sep = "\t", col.names=NA)


hm_data_max[ treatment == "carbamazapine", treatment := "carbamazepine"]
hm_data_max[ treatment == "etoposide ", treatment := "etoposide"]

setkey(hm_data_max, 'treatment')  
setkey(annotationData, 'treatment')
hm_data_max <- annotationData[hm_data_max]
sort(unique(hm_data_max$treatment))
save(file = '../tmp/hm_data_max_.Rdata', data = hm_data_max) 

summary(hm_data_max[, value])

# create wide data format

dmsoD <- hm_data_max[ cmax == "0cmax"]
hm_data_max <- hm_data_max[ cmax != "0cmax"]
dmsoD <- as.data.frame(dmsoD)
dmsoD1 <- dmsoD
dmsoD2 <- dmsoD
dmsoD3 <- dmsoD
dmsoD4 <- dmsoD
dmsoD5 <- dmsoD

dmsoD1$cmax <- "1cmax"
dmsoD2$cmax <- "5cmax"
dmsoD3$cmax <-  "10cmax"
dmsoD4$cmax <- "50cmax"
dmsoD5$cmax <- "100cmax"

dmsoD <- rbind(dmsoD1, dmsoD2,dmsoD3,dmsoD4,dmsoD5)

dmsoD <- as.data.table(dmsoD)

hm_data_max <- rbind(hm_data_max, dmsoD)
hm_data_max[ , fingerprints:= paste(fingerprints, cmax, sep = "_")]

# need a fix for DMSO
colnames(hm_data_max)
hm_data_max_w <- dcast(hm_data_max, treatment + Bob_anot + EndDissolvedQuality + DILIConcern +SeverityLabel ~ fingerprints  , value.var = "value" )



hm_data_max_w[1:5,1:10]

hm_data_max_w[1:5,1:11]
colnames(hm_data_max_w)
hm_data_max_w$treatment


hm_data_max_w <- as.data.table(hm_data_max_w)
class(hm_data_max_w)

table(hm_data_max_w[, DILIConcern])
hm_data_max_w <- hm_data_max_w[ ! DILIConcern %in% "N/A"]
hm_data_max_w[ ,DILIConcern := factor(DILIConcern)]
colnames(hm_data_max_w)[1:10]
unique(hm_data_max_w)
hm_data_max_w <- hm_data_max_w[Bob_anot != "general_cytotox_reactive", ]
hm_data_max_w <- hm_data_max_w[EndDissolvedQuality != "no", ]

sort(unique(hm_data_max_w$treatment))
hm_data_max_w[ DILIConcern == "Most-DILI-Concern", diliClass := "severe"]
hm_data_max_w[ DILIConcern != "Most-DILI-Concern", diliClass := "nonSevere"]

hm_data_treatments <- hm_data_max_w$treatment
hm_data_DILIConcern <- hm_data_max_w$DILIConcern
head(hm_data_data)
colnames(hm_data_max_w)
dim(hm_data_max_w)
hm_data_data <- as.matrix(hm_data_max_w[, -c(1:5,86)] )

rownames(hm_data_data) <- hm_data_treatments
hm_data_max_w[,1:5,1:3]
dim(hm_data_max_w)
# add TNF cell death
unique(ML_data_final_data_long$treatment)

ind_necrosis <- which(grepl("necrosis", ML_data_final_data_long$variable))
ind_slope_CellNumber <- which(grepl("CellNumber", ML_data_final_data_long$variable))


CD_TNF <- ML_data_final_data_long[c(ind_necrosis, ind_slope_CellNumber),  ]
CD_TNF <- dcast( data = CD_TNF, formula = treatment ~ variable, value.var = "value" )
sum(is.na(CD_TNF))
# normalize the slope columns between -1 and 1
indSlope <- which(grepl("slope", colnames(CD_TNF)))

for(i in seq_along(indSlope)){
  minV <- min(CD_TNF[, indSlope[i]])
  maxV <- max(CD_TNF[, indSlope[i]])
  CD_TNF[, indSlope[i]] <- 2*((CD_TNF[, indSlope[i]] - minV) / (maxV - minV)) - 1
}

# normalize cell death to dmso

head(CD_TNF)
CD_TNF[ CD_TNF$treatment == "dmso",]

indCD <- which(grepl("necrosis", colnames(CD_TNF)))

for(i in seq_along(indCD)){
  dmsoV <- CD_TNF[CD_TNF$treatment == "dmso", indCD[i]]
  CD_TNF[, indCD[i]] <- CD_TNF[, indCD[i]] - dmsoV
}



hm_data_max_w <- merge(hm_data_max_w, CD_TNF, by = "treatment", all.x = TRUE, all.y = FALSE)
colnames(hm_data_max_w)



# color annotations
require(RColorBrewer)

diliClass <-  c(brewer.pal(9,"BuPu")[c(4,9)])
DILIConcern <- c(brewer.pal(9,"BuPu")[c(1, 3, 5,9)])
SeverityLabel <- c(brewer.pal(9,"Greys")[-1])
hist(1:100 , col=DILIConcern)

names(DILIConcern) <- c("No-DILI-Concern", "Ambiguous DILI-concern", "Less-DILI-Concern", "Most-DILI-Concern")
names(diliClass) <- c("nonSevere", "severe")
names(SeverityLabel) <- c("No match", "Cholestasis; steatohepatitis",
                          "Liver aminotransferases increase","Hyperbilirubinemia",
                          "Jaundice", "Liver necrosis", "Acute liver failure",
                          "Fatal hepatotoxicity"
                          ) 
                            
  
myColors <- list(DILIConcern = DILIConcern, diliClass = diliClass, SeverityLabel = SeverityLabel ) 



myColors$cmax <- brewer.pal(5, "BuGn" )
names(myColors$cmax) <- c("cmax1", "cmax5","cmax10", "cmax50", "cmax100")

myColors$reporter <- c("light blue", "light green", "#CC6633", "purple", "black")
names(myColors$reporter) <- c("Srxn1", "Chop", "p21", "Icam1", "Tox")


hm_data_max_w$diliClass <- factor(hm_data_max_w$diliClass, levels =c("severe", "nonSevere"))
treatmentAnot<-data.frame(DILIConcern = hm_data_DILIConcern, diliClass = hm_data_max_w$diliClass)
cbind(as.character(hm_data_DILIConcern), as.character(hm_data_max_w$diliClass))
treatmentAnot$SeverityLabel <- hm_data_max_w$SeverityLabel
# color anotations for columns. 
# order columns, create triple color annotation: reporter, sensitivity, cmax

old.colnames.order <- colnames(hm_data_max_w)
write.table(old.colnames.order, file = "../tmp/old.colnames.order.txt", sep = "\t")

new.colnames.order <- read.table(file = '../tmp/new.colnames.order.txt', sep ="\t")
colnames(hm_data_max_w)
hm_data_data <-  hm_data_max_w[ , -c(1:5, 86)]
colnames(hm_data_data)
colIndex <- match(   new.colnames.order$V1, colnames(hm_data_data))

all(colnames(hm_data_data)[colIndex] == new.colnames.order$V1)
19*5

annCol <- list(cmax=
  rep(
    c("cmax1","cmax5", "cmax10","cmax50", "cmax100"),  19
    ),
  reporter = c( 
    rep(c("Srxn1", "Chop", "p21", "Icam1"), each = 20),
    rep("Tox", 15)
  )
)


dim(hm_data_data)

#colBreaks <-c(seq(-0.01, 0.3,length.out=15), seq(0.301,1.01, length.out = 14))


colBreaks <-c(  -seq(1.14, 0.411, length.out = 8), -seq( 0.4, 0.01, length.out=16)  , 
                c(seq(0.01, 0.4,length.out=16), seq(0.411,1.01, length.out = 8)) )


my.colors <- c(rev(brewer.pal(9, "YlGnBu")) , brewer.pal(9, "YlOrRd"))


pie(rep(1, length(my.colors)), labels = sprintf("%d (%s)", seq_along(my.colors), 
                                                my.colors), col = my.colors)


library(dendextend)

hm_data_data <- as.data.frame(hm_data_data)
# for DMSO only cellnumber has per cmax values, change this to mean value;

rownames(hm_data_data) <- hm_data_max_w$treatment
head(hm_data_data)
hm_data_data[ rownames(hm_data_data) == "dmso", grepl("CellNumber", colnames(hm_data_data))]<-
rowMeans(hm_data_data[ rownames(hm_data_data) == "dmso", grepl("CellNumber", colnames(hm_data_data))])




dist_hm_data <- dist(hm_data_data, method = c("euclidean", "maximum", "manhattan", "canberra", "binary" , "minkowski")[3])

clust_hm_data<-hclust(dist_hm_data, method = c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median","centroid")[1])
dd <- as.dendrogram(clust_hm_data)
dd.reorder <- reorder(dd, wts =  c(rep(1, 9), rep(50, 84) ,rep(1,26)))



#cutree(dd.reorder,h=7) # it now works on a dendrogram#
# It is like using:
#dend1 <-dendextend:::cutree.dendrogram(dd.reorder,h=7)

dend1 <- color_branches(dd, k = 4)
dend1 <- color_labels(dend1, k = 4)
plot(dend1)

pdf("../generated/results/heatmap/orig_hm_rowClusterDendogram_manh_wardD_noreo.pdf", width = 24, height = 10)
plot(dend1)
dev.off()


hm_data_rowOrder <- labels(dend1)

indOrder <- match( hm_data_rowOrder, rownames(hm_data_data))
hm_data_data <- as.matrix(hm_data_data)

dim(hm_data_data)



  
head(hm_data_data)
pdf("../generated/results/heatmap/orig_hm_heatmap_manh_wardDnoreo.pdf", width= 12, height = 18)
aheatmap(hm_data_data[ indOrder ,colIndex], Rowv = NA, Colv=NA, 
         color = my.colors, breaks = colBreaks,
         fontsize = 10, width = 10, height=10, legend = TRUE,
         annRow = treatmentAnot[indOrder, , drop = F] , annCol = annCol, annColors = myColors   #,txt =hm_data_data[ indOrder ,colIndex]
)
dev.off()

?reorder
```



Create the time course figure with significance,


```{r, fit_for_stats }
load('../tmp/all.data.norm.Rdata')


unique(all.data.norm[ , fingerprints])

sort(unique(all.data.norm$treatment))

table(all.data.norm[treatment == "dmso", dose_uM])

all.data.norm[treatment == "carbamazapine", treatment := 'carbamazepine']

all.data.norm[treatment == "carbamazepine",1:4 ]
all.data.norm[treatment == "etoposide ", treatment := 'etoposide' ]

sort(unique(all.data.norm[ , treatment]))
sort(unique(all.data.norm[ , fingerprints]))

# 
# annotationData <- read.delim(file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep = "\t", header = T )
# 
# annotationData <- data.table(annotationData)
# 
# setnames(annotationData, old = "cmax", new = "onecmax")
# setkey(all.data.norm, 'treatment')  
# setkey(annotationData, 'treatment')
# 
# sort(unique(all.data.norm[, treatment]))
# 
# all.data.norm <- annotationData[all.data.norm]
# # select data with fda label and correct dissolve
# unique(all.data.norm[ ,Bob_anot ])

all.data.norm <- all.data.norm[ DILIConcern != "N/A",  ]
all.data.norm <- all.data.norm[ Bob_anot != "general_cytotox_reactive",  ]
all.data.norm <- all.data.norm[ EndDissolvedQuality != "no",  ]
sort(unique(all.data.norm$treatment))
# select features for plotting
unique(all.data.norm$fingerprints)





 timeCourseData <- all.data.norm[ fingerprints %in% c("GFP_pos.2m_Srxn1", "GFP_pos.2m_DDIT3", "GFP_pos.2m_p21", "GFP_dif.m2_ICAM1"), ]

unique(all.data.norm[, fingerprints])
 
 
# timeCourseData <- all.data.norm[ fingerprints %in% c("mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1", "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3", "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_p21", "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"), ]
# 
# timeCourseData[, fingerprints := gsub("mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1",
#                                       "Srxn1_intensity", fingerprints)]
# timeCourseData[, fingerprints := gsub("mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3",
#                                       "Chop_intensity",fingerprints)]
# timeCourseData[, fingerprints := gsub("mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_p21",
#                                       "p21_intensity",fingerprints)]
# timeCourseData[, fingerprints := gsub("mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1",
#                                       "Icam1_intensity",fingerprints)]
unique(timeCourseData[, fingerprints])
# generate replicates for dmso per plate

replDMSO_srxn1 <- data.frame( plateID = unique(timeCourseData[ treatment == "dmso" & cell_line == "Srxn1", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(timeCourseData[ treatment == "dmso" & cell_line == "Srxn1", plateID])))),
       cell_line = "Srxn1", treatment ="dmso")


replDMSO_chop <- data.frame( plateID = unique(timeCourseData[ treatment == "dmso" & cell_line == "DDIT3", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(timeCourseData[ treatment == "dmso" & cell_line == "DDIT3", plateID])))),
       cell_line = "DDIT3", treatment = "dmso")

replDMSO_p21 <- data.frame( plateID = unique(timeCourseData[ treatment == "dmso" & cell_line == "p21", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(timeCourseData[ treatment == "dmso" & cell_line == "p21", plateID])))),
       cell_line = "p21", treatment = "dmso")

replDMSO_ICAM1 <- data.frame( plateID = unique(timeCourseData[ treatment == "dmso" & cell_line == "ICAM1", plateID]),
       replID = paste0( "replicate_",as.numeric(as.factor(unique(timeCourseData[ treatment == "dmso" & cell_line == "ICAM1", plateID])))),
       cell_line = "ICAM1", treatment = "dmso")


replDMSO <- rbind(replDMSO_srxn1, replDMSO_chop, replDMSO_p21, replDMSO_ICAM1)
replDMSO <- as.data.table(replDMSO)
setnames(replDMSO, old = "replID", new = "replID_dmso")
setkeyv(timeCourseData, c("plateID", "cell_line", "treatment"))
setkeyv(replDMSO, c("plateID", "cell_line", "treatment"))
timeCourseData <- replDMSO[timeCourseData]
timeCourseData[!is.na(replID_dmso), replID := replID_dmso]

timeCourseData[ , singleCurveName := paste(fingerprints, treatment, cmax, dose_uM, replID, sep = "__")]

ggplot(data = timeCourseData[ treatment == "dmso" & cell_line == "ICAM1"], aes( x = timeAfterExposure, y = value,
                                                                              color = replID)) + geom_point() 


# testing for missing data; no missing data.
write.table(unique(timeCourseData[order( treatment,fingerprints, cmax, dose_uM) , list(treatment,fingerprints, cmax, dose_uM)]),
            file = "test.txt", sep = "\t")




GFP_data.list <- split(timeCourseData, timeCourseData$singleCurveName)
length(GFP_data.list)

ind<- lapply(GFP_data.list, function(x) { length(unique(x$timeAfterExposure)) }  )

head(ind)
sort(unique(unlist(ind)))

indd <- lapply(ind, function(x) x < 12)
inddd<- unlist(indd)
length(inddd)
sum(inddd)
length(GFP_data.list)
sum(inddd)

GFP_data.list.lowTP <- GFP_data.list[inddd]
length(GFP_data.list.lowTP)
ind3 <- lapply(GFP_data.list.lowTP, "[[", 'treatment')

ind3 <- (sapply(ind3, unique)) == "zimelidine" 
GFP_data.list.lowTP[ind3]

length(GFP_data.list)
GFP_data.list <- GFP_data.list[!inddd]
length(GFP_data.list.lowTP) 
length(GFP_data.list) 


model.results.GFP_data_lowTP = list()

#include the fitted parameters to perform a F-test
# perform t-test for fitted/sampled values after model fit

pdf(file = "../generated/results/model fit graphs_lowTPwithDMSO_replDMSO.pdf", height = 8, width = 12)

for( i in seq_along(GFP_data.list.lowTP) ){ #)

  # acarbose 0.1502 replicate_1 GFP_pos.m3sd_DDIT3
  fm1 <- lm(value ~ ns(timeAfterExposure, df =4), data = GFP_data.list.lowTP[[i]])
  model.results.GFP_data_lowTP[[i]] <-  predict(fm1, dtTime<-data.frame(
    timeAfterExposure = round(seq(0.6,23, length.out=22), digits=2)))
  model.results.GFP_data_lowTP[[i]] <- as.data.frame(model.results.GFP_data_lowTP[[i]] )
  colnames(model.results.GFP_data_lowTP[[i]])<- "mod"
  
  model.results.GFP_data_lowTP[[i]]$treatment <- unique(GFP_data.list.lowTP[[i]]$treatment)
  model.results.GFP_data_lowTP[[i]]$dose_uM <- unique(GFP_data.list.lowTP[[i]]$dose_uM)
  model.results.GFP_data_lowTP[[i]]$cmax <- unique(GFP_data.list.lowTP[[i]]$cmax)
  model.results.GFP_data_lowTP[[i]]$replID <- unique(GFP_data.list.lowTP[[i]]$replID)
  model.results.GFP_data_lowTP[[i]]$timeAfterExposure <- dtTime$timeAfterExposure
  model.results.GFP_data_lowTP[[i]]$fingerprints <- unique(GFP_data.list.lowTP[[i]]$fingerprints)
  
   p <- ggplot(data =  model.results.GFP_data_lowTP[[i]], aes(x=timeAfterExposure, y = mod)) + geom_point() + 
      geom_point(data= GFP_data.list.lowTP[[i]], aes(x=timeAfterExposure, y = value, color = replID)) + 
   ggtitle(unique(GFP_data.list.lowTP[[i]]$singleCurveName)) 
  
  print(p)
}
dev.off()


model.results.GFP_data = list()

pdf(file = "../generated/results/model fit graphs with DMSO_replDMSO.pdf", height = 8, width = 12)
#nog een keer runnen (zonder pdf) - om fit p-waarden te extraheren
for( i in seq_along(GFP_data.list)){ #

  # acarbose 0.1502 replicate_1 GFP_pos.m3sd_DDIT3
  fm1 <- lm(value ~ ns(timeAfterExposure, df =8), data = GFP_data.list[[i]])
  model.results.GFP_data[[i]] <-  predict(fm1, dtTime<-data.frame(
    timeAfterExposure = round(seq(0.6,23, length.out=22), digits=2)))
  model.results.GFP_data[[i]] <- as.data.frame(model.results.GFP_data[[i]] )
  colnames(model.results.GFP_data[[i]])<- "mod"
  
  
  model.results.GFP_data[[i]]$treatment <- unique(GFP_data.list[[i]]$treatment)
  model.results.GFP_data[[i]]$dose_uM <- unique(GFP_data.list[[i]]$dose_uM)
  model.results.GFP_data[[i]]$cmax <- unique(GFP_data.list[[i]]$cmax)
  model.results.GFP_data[[i]]$replID <- unique(GFP_data.list[[i]]$replID)
  model.results.GFP_data[[i]]$timeAfterExposure <- dtTime$timeAfterExposure
  model.results.GFP_data[[i]]$fingerprints <- unique(GFP_data.list[[i]]$fingerprints)
  
  p <- ggplot(data =  model.results.GFP_data[[i]], aes(x=timeAfterExposure, y = mod)) + geom_line() + 
    geom_point(data= GFP_data.list[[i]], aes(x=timeAfterExposure, y = value, color = replID)) + 
    ggtitle(unique(GFP_data.list[[i]]$singleCurveName)) 
  
  print(p)
  
  
  if((i%%500)==0){
   write.table(file = paste("../tmp/progres", i ,".txt", sep =""), i/5133 )
  }
  
}
dev.off()

# 25-5-2017 verder. (ik doe even de time courses voor suus om aan verder te werken. nierna feature selection om heatmap te maken)
# dont forgot to combine low TP with high TP

#save.image("../tmp/20170331aftermodelrun.Rdata")
model.results.GFP_data[[1]]
head(model.results.GFP_data[[3]])
model.results.GFP_data.df <- do.call("rbind", model.results.GFP_data)
sort(unique(model.results.GFP_data.df$treatment))
model.results.GFP_data_lowTP.df <- do.call("rbind", model.results.GFP_data_lowTP)

model.results.GFP_data.df <- rbind(model.results.GFP_data.df, model.results.GFP_data_lowTP.df)


dim(rbind(do.call("rbind", model.results.GFP_data), model.results.GFP_data_lowTP.df))
head(model.results.GFP_data_lowTP.df)

model.results.GFP_data.df[treatment == "acetaminophen" & cmax =="100cmax" & replID == "replicate_2" &
                            fingerprints == "GFP_dif.m2_ICAM1"]

dim(model.results.GFP_data_lowTP.df)
dim(model.results.GFP_data.df)


model.results.GFP_data.df <- as.data.table(model.results.GFP_data.df)



```





# annotate, then normalize ICAM1 to dmso, then statistics + plotting
```{r annotate}
#annotate again, after modeling

sort(unique(model.results.GFP_data.df$treatment))
dir('../metadata')
anotData <- read.delim( file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt' , sep ="\t" , header = TRUE)
anotData <- as.data.table(anotData)
setnames( anotData, old ='cmax', new = 'onecmax' )
setkey(anotData, 'treatment')
setkey(model.results.GFP_data.df, 'treatment' )
model.results.GFP_data.df <- anotData[model.results.GFP_data.df]

model.results.GFP_data.df[DILIConcern == "Most-DILI-Concern", diliClass := "severe"]
model.results.GFP_data.df[DILIConcern != "Most-DILI-Concern", diliClass := "nonSevere"]

save(model.results.GFP_data.df, file = '../tmp/model.results.GFP_data.df.RData')
load( '../tmp/model.results.GFP_data.df.RData')
```



```{r statistics}
require(data.table)
require("fda.usc")
# try ML_data
 load("../tmp/model.results.GFP_data.df.Rdata")
model.results.GFP_data.df <- as.data.table(model.results.GFP_data.df)

# normalize ICAM1 to DMSO, by subtracting median dmso value from all ICAM1 values



ICAM1_dmso <- model.results.GFP_data.df[ fingerprints == "GFP_dif.m2_ICAM1" & treatment == "dmso",
                           median(mod), by = list(timeAfterExposure) ]
setnames(ICAM1_dmso, old = 'V1', new = 'ICAM1_dmso')
setkey(ICAM1_dmso, 'timeAfterExposure')
setkey(model.results.GFP_data.df, 'timeAfterExposure')
model.results.GFP_data.df<- ICAM1_dmso[ model.results.GFP_data.df]

model.results.GFP_data.df[ fingerprints == "GFP_dif.m2_ICAM1",
                           mod := mod - ICAM1_dmso ]


all.fingerprints <- unique(model.results.GFP_data.df[, fingerprints])

model.results.GFP_data.df[ , TD := paste0(treatment, "(", cmax, ")")]
model.results.GFP_data.df[ treatment == "dmso", TD := "dmso" ]


# remove non-relevant dmso levels
model.results.GFP_data.df <- model.results.GFP_data.df[! (treatment == "dmso" & dose_uM %in% c(
  "0.3", "0.4", "0.6", "0.8")) ,]

# add approx cmax values for DMSO treatments based on dose.
unique(model.results.GFP_data.df[treatment == "dmso", dose_uM])
table(model.results.GFP_data.df[treatment == "dmso", dose_uM])
# 0.2 100cmax
# 0.1 50cmax
# 0.02 10 cmax
# 0.01 5 cmax
# 0.002 1 cmax


model.results.GFP_data.df[ treatment == "dmso" & as.numeric(dose_uM) > 0.1, cmax := "100cmax" ]

model.results.GFP_data.df[ treatment == "dmso" & as.numeric(dose_uM) <= 0.1 & 
                             as.numeric(dose_uM) > 0.04 , cmax := "50cmax" ]

model.results.GFP_data.df[ treatment == "dmso" & as.numeric(dose_uM) > 0.01 &
                             as.numeric(dose_uM) <= 0.04, cmax := "10cmax" ]

model.results.GFP_data.df[ treatment == "dmso" & as.numeric(dose_uM) > 0.004 & 
                             as.numeric(dose_uM) <= 0.01, cmax := "5cmax" ]

model.results.GFP_data.df[ treatment == "dmso" & as.numeric(dose_uM) <= 0.004, cmax := "1cmax" ]
unique(model.results.GFP_data.df[treatment == "dmso", list(cmax, dose_uM)])
table(model.results.GFP_data.df[treatment == "dmso", cmax])

model.results.GFP_data.df[, cmax := factor(cmax, levels = c("1cmax", "5cmax", "10cmax", "50cmax", "100cmax"))]

table(model.results.GFP_data.df[, cmax])



model.results.GFP_data.df<-model.results.GFP_data.df[ , mean(mod), by = list(treatment, cmax, replID, timeAfterExposure, TD, fingerprints)]


setnames(model.results.GFP_data.df, old ="V1", new = "mod")

all.fingerprints
unique(model.results.GFP_data.df[ fingerprints == "GFP_pos.2m_DDIT3", treatment])
all.treats<-as.character(all.treats)
all.treats.noDMSO <- all.treats[all.treats != "dmso"]

model.results.GFP_data.df[ , treatment := factor(treatment, levels = 
                                                   factor(all.treats, levels = c(all.treats.noDMSO,"dmso")))]

# ICAM1 dmso is TNF, same concentration in all treatments, solution for plotting; randomly distribute tnf controls over cmax's;
icamDMSO <- model.results.GFP_data.df[treatment == "dmso" & fingerprints == "GFP_dif.m2_ICAM1", ]
icamDMSO <- icamDMSO[ order(timeAfterExposure), ]
table(icamDMSO$timeAfterExposure)

icamDMSO[ seq(1,264, by = 12) , cmax:= "1cmax"]
icamDMSO[ seq(1,264, by = 12) + 1 , cmax:= "1cmax"]
icamDMSO[ seq(1,264, by = 12) + 2, cmax:= "5cmax"]
icamDMSO[ seq(1,264, by = 12) + 3, cmax:= "5cmax"]
icamDMSO[ seq(1,264, by = 12) + 4, cmax:= "10cmax"]
icamDMSO[ seq(1,264, by = 12) + 5, cmax:= "10cmax"]
icamDMSO[ seq(1,264, by = 12) + 6, cmax:= "50cmax"]
icamDMSO[ seq(1,264, by = 12) + 7, cmax:= "50cmax"]
icamDMSO[ seq(1,264, by = 12) + 8, cmax:= "100cmax"]
icamDMSO[ seq(1,264, by = 12) + 9, cmax:= "100cmax"]

table(icamDMSO[ , list(cmax, timeAfterExposure)])
model.results.GFP_data.df <- model.results.GFP_data.df[!(treatment == "dmso" & fingerprints == "GFP_dif.m2_ICAM1"), ]
model.results.GFP_data.df <- rbind(model.results.GFP_data.df, icamDMSO)


class(model.results.GFP_data.df$timeAfterExposure)

ggplot(data = model.results.GFP_data.df[ treatment == "dmso",], aes(x = timeAfterExposure, y = mod, color = replID) ) +
         geom_point() + facet_wrap(~fingerprints) 

save(file = '../tmp/model.results.GFP_data.df.Rdata', model.results.GFP_data.df)

metaTime <- unique(model.results.GFP_data.df[ , timeAfterExposure])

all.fingerprints.out = list() # stores all the fingerprints lists


for ( j in seq_along( all.fingerprints ) ) {

  anova.perm.out = list() # new list for each fingerprint

fingerprintSubset <-  model.results.GFP_data.df[ fingerprints %in% all.fingerprints[j] , ]

all.TD <- unique(fingerprintSubset[, TD])

all.TD <- all.TD[ all.TD != "dmso"]

for ( i in seq_along(all.TD)) {
 
 TDSubset <- fingerprintSubset[TD == all.TD[i] | TD == "dmso", ]
 
 TDSubset_wide <- dcast(data = TDSubset, formula = TD + replID + cmax ~ timeAfterExposure, value.var = "mod")

 TDSubset_wide$TD <- factor(TDSubset_wide$TD)

Group <- grepl("dmso", TDSubset_wide[ , "TD"] )
ind <- Group
Group[ ind ] <- "dmso"
Group[! ind ] <- unique(as.character(TDSubset_wide$TD)[ !grepl("dmso", TDSubset_wide$TD)])
Group <- factor(Group)

# check if dcast worked ( could be wrong cmax values for dmso .. )
if( !length(Group) ==  ( nrow(TDSubset) / (length( metaTime ) ) ) ) {
  stop( paste( "dcast failed at i: ", i, 'and j: ', j ) )
}

  mdata <- as.matrix(TDSubset_wide[,-c(1, 2, 3) ])
  argvals <-metaTime
  
  fdata.imagedata <- fdata( mdata = mdata, argvals = argvals, rangeval = range(argvals))

    if( length( Group[!ind]) > 1 ) {
    anova.perm.out[[i]] <- anova.onefactor( object = fdata.imagedata, group = Group, nboot = 1000, plot = FALSE)  
  } else {
    anova.perm.out[[i]] <- list(pvalue = NA, stat = NA) # no replicate...
  }
    anova.perm.out[[i]]$wm <- NULL
    
  names(anova.perm.out)[i] <- paste( unique(as.character(Group[Group!="dmso"])), "dmso", sep = "_")


    }
  all.fingerprints.out[[j]] <- anova.perm.out
  names(all.fingerprints.out)[j] <-  as.character( all.fingerprints[j] )
print(j)
  
}


length(all.fingerprints.out[[1]])
# na eten

result <- lapply(all.fingerprints.out, "[" ) 
result <- unlist(result)

ind_pvalue <- grepl("pvalue", rownames(as.data.frame(result)))
ind_stat <- grepl(".stat$", rownames(as.data.frame(result)))

resultstats <- as.data.frame(result)

#resultstats$p_value[ind_pvalue] <- resultstats$result[ind_pvalue]
#resultstats$stat[ind_stat] <- resultstats$result[ind_stat]
resultstats$variable[ind_stat] <- "stat"
resultstats$variable[ind_pvalue] <- "pvalue"
resultstats$TD <- gsub("_dmso.pvalue", "", rownames(resultstats))
resultstats$TD <- gsub("_dmso.stat", "", resultstats$TD)

result_stats <- dcast(resultstats, TD ~ variable, value.var = "result")
head(result_stats)
result_stats$treatfeat <- gsub( "(\\([0-9]{1,3}cmax\\))", "" , result_stats$TD)
result_stats$treatment <- sapply(strsplit(result_stats$treatfeat, "\\."), '[')[2,]
result_stats$feature <- sapply(strsplit(result_stats$treatfeat, "\\."), '[')[1,]
result_stats$cmax <- str_extract(result_stats$TD,  "[0-9]{1,3}cmax"  )

write.table( result_stats, file = "../generated/results/results_statistics_time_courses_replDMSO.txt", sep ="\t" )




```




```{r, time_plots }
# calculate mean 
require(plyr)
result_stats <- read.delim("../generated/results/results_statistics_time_courses_replDMSO.txt", sep ="\t")
sort(unique(model.results.GFP_data.df[, treatment]))
result_stats <- as.data.table(result_stats)

model.results.GFP_data.df.m <- model.results.GFP_data.df[ ,mean(mod, na.rm = TRUE) ,by = list(treatment, cmax, fingerprints, timeAfterExposure)]

model.results.GFP_data.df.s <- model.results.GFP_data.df[ ,sd(mod, na.rm = TRUE) ,by = list(treatment, cmax, fingerprints, timeAfterExposure)]                            
setnames(model.results.GFP_data.df.m, old = "V1", new = "meanR")
setnames(model.results.GFP_data.df.s, old = "V1", new = "sd")

sapply( strsplit(result_stats$treatfeat, "\\."), "[",3)

result_stats[ , treatment := sapply( strsplit(treatfeat, "\\."), "[", 3)]
result_stats[ , fingerprints := paste(sapply( strsplit(TD, "\\."), "[", 1), 
                                      sapply( strsplit(TD, "\\."), "[", 2),
                                      sep = ".")]


result_stats <- result_stats[ , list(treatment, cmax, fingerprints, pvalue)]
result_stats[ , pval := "na"]

result_stats[ pvalue <= 0.01 , pval := "*"]
result_stats[ pvalue < 0.001 , pval := "**"]
result_stats[ pvalue > 0.01 , pval := ""]
result_stats[ is.na(pvalue)  , pval := "."]



result_stats[ fingerprints == "GFP_pos.2m_Srxn1", yloc := 0.15]
result_stats[ fingerprints == "GFP_pos.2m_DDIT3", yloc := 0.4]
result_stats[ fingerprints == "GFP_pos.2m_p21", yloc := 0.65 ]
result_stats[ fingerprints == "GFP_dif.m2_ICAM1", yloc := 0.9]


unique(model.results.GFP_data.df[, fingerprints])


all.treats <- unique(model.results.GFP_data.df$treatment)
length(all.treats)/3


model.results.GFP_data.df
model.results.GFP_data.df.m$treatment<- as.character(model.results.GFP_data.df.m$treatment)

model.results.GFP_data.df.m$treatment <- factor(model.results.GFP_data.df.m$treatment, levels =
                                                    sort(as.character(unique(model.results.GFP_data.df.m$treatment))) )
model.results.GFP_data.df.m <- as.data.table(model.results.GFP_data.df.m)
# for graphical purpose add dmso data for each cmax
model.results.GFP_data.df[ treatment == "dmso"]
# dmso <- model.results.GFP_data.df.m[ cmax == "0cmax", ]
# 
# dmso$cmax  <- "1cmax"
# model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
# dmso$cmax  <- "5cmax"
# model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
# dmso$cmax  <- "10cmax"
# model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
# dmso$cmax  <- "50cmax"
# model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
# dmso$cmax  <- "100cmax"
# model.results.GFP_data.df.m <- rbind(model.results.GFP_data.df.m, dmso)
# 
# model.results.GFP_data.df.m <- model.results.GFP_data.df.m[ cmax != "0cmax", ]
# 
# model.results.GFP_data.df.m[ , cmax := factor(cmax, levels =
#                                                 c("1cmax", "5cmax", "10cmax", "50cmax", "100cmax"))]


model.results.GFP_data.df.m[ , fingerprints := factor(fingerprints, levels =
 c("GFP_pos.2m_Srxn1", "GFP_pos.2m_DDIT3", "GFP_pos.2m_p21", "GFP_dif.m2_ICAM1"  ))]


all.treats <- sort(as.character(unique(model.results.GFP_data.df.m$treatment)))

# color annot.
require(RColorBrewer)

DILIConcern <- c(brewer.pal(9,"YlOrRd")[c(1,3,6)])
hist(1:100 , col=DILIConcern)

names(DILIConcern) <- c("No-DILI-Concern","Less-DILI-Concern", "Most-DILI-Concern")

myColors <- list(DILIConcern = DILIConcern ) 

myColors$cmax <- brewer.pal(5, "BuGn" )
names(myColors$cmax) <- c("1cmax", "5cmax","10cmax", "50cmax", "100cmax")

myColors$reporter <- c("light blue", "green", "#CC6633", "purple")
names(myColors$reporter) <- c("Srxn1", "Chop", "p21", "Icam1")
unique(model.results.GFP_data.df.m[, fingerprints])
myColors$fingerprint <- c("blue", "seagreen", "#CC6633", "purple")
names(myColors$fingerprint) <- c("GFP_pos.2m_Srxn1", "GFP_pos.2m_DDIT3", "GFP_pos.2m_p21", "GFP_dif.m2_ICAM1"  )


length(all.treats)
119/3

if( !(dir.exists('../generated/results/time_figure'))){
  dir.create('../generated/results/time_figure')
}




result_stats[, cmax := factor(cmax, levels = c("1cmax", "5cmax", "10cmax" ,"50cmax", "100cmax"))]



sel.comps <- sort(all.treats)[1:40]
sel.comps <- sort(all.treats)[41:80]
sel.comps <- sort(all.treats)[81:length(all.treats)]



  pdf(file = "../generated/results/time_figure/time_fig 3 of 3 figure_stats.pdf", height = 60, width = 10)
  p<- ggplot(data= model.results.GFP_data.df.m[ treatment %in% sel.comps, ]  , aes(x = timeAfterExposure, y = meanR, color = fingerprints)) + facet_grid(  treatment ~ cmax) +
    geom_line( size = 2)  + scale_color_manual(values=myColors$fingerprint) +
    theme_bw() +
    theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank()) 
  p <- p + coord_cartesian( ylim =c(-1, 1))
  p <- p + geom_text( data = result_stats[ treatment %in% sel.comps,], 
                     aes(x = 4, y =yloc, label =  pval ), size = 10, alpha = 0.6) 
  
  print(p)
  dev.off()

unique(model.results.GFP_data.df.m$treatment)

# sessie 31032017_afterTimePlots.Rdata gesaved
```


concentration-response modeling and estimation of PODs


```{r dose_benchmarkdoseing}
require(drc)
# max of time of raw data:

icamFun2 <- function(x) {
  ifelse(abs(max(x, na.rm=T)) >= abs(min(x,na.rm=T)), max(x,na.rm=T), min(x,na.rm=T))
}
sort(unique(hm_data[, treatment]))
hm_data[ treatment == "carbamazapine", treatment := "carbamazepine"]
# fix concentrations
dir('../metadata')
annotationData <- as.data.table(read.delim(file ='../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep ="\t" ))
annotationData <- annotationData[DILIConcern != "N/A" & Bob_anot != "general_cytotox_reactive" ]
annotationData <- annotationData[ EndDissolvedQuality != "no",]

cmaxdose <- annotationData[, c(1,9)]
setnames(cmaxdose, old ="cmax", new = "conc")
cmaxdose$cmax <- "1cmax"
cmaxdose$conc <- as.numeric(cmaxdose$conc)

cmaxdose[ is.na(conc), conc := 0]


cmax5 <- cmaxdose
cmax10 <- cmaxdose
cmax50 <- cmaxdose
cmax100 <- cmaxdose

cmax5$conc<-cmaxdose$conc*5
cmax5$cmax <- "5cmax"
cmax10$conc<- cmaxdose$conc*10
cmax10$cmax<-"10cmax"
cmax50$conc <- cmaxdose$conc*50
cmax50$cmax<-"50cmax"
cmax100$conc <- cmaxdose$conc*100
cmax100$cmax<-"100cmax"

result.cmaxdose<- rbind(cmaxdose,cmax5,cmax10,  cmax50, cmax100)
result.cmaxdose[ treatment == "dmso", cmax := "0cmax"]

sort(unique(result.cmaxdose$treatment))
result.cmaxdose

dose.response.modeling.data <- hm_data[ , icamFun2(value), by = list(
  treatment, dose_uM, cell_line, replID, cmax, fingerprints
)]



dose.response.modeling.data <- dose.response.modeling.data[ fingerprints %in% 
                                                              c("GFP_pos.2m_Srxn1", "GFP_pos.2m_p21", "GFP_pos.2m_Chop", "GFP_dif.m2_Icam1")]

dose.response.modeling.data <- merge(dose.response.modeling.data, result.cmaxdose, by = c("treatment" ,"cmax" ))
unique(dose.response.modeling.data$treatment)

dose.response.modeling.data[ , dose_uM:= as.numeric(dose_uM)]

dose.response.modeling.data[, fingertreat := paste(fingerprints, treatment, sep ="__" )]
sort(unique(dose.response.modeling.data$treatment))
# create 0 concentration based on DMSO
pdf("../tmp/test.pdf", height =16, width = 16)
p<-ggplot(data = dose.response.modeling.data, aes(x=conc, y = V1)) + geom_point(aes(color = fingerprints)) + facet_wrap(~treatment, scales="free_x")
print(p)
dev.off()

dose.response.modeling.data[ treatment == "carbamazepine"]

dmso.data <- dose.response.modeling.data[ treatment == "dmso"]
dmso.data <- dmso.data[ , mean(V1), by = list(treatment,replID, cell_line, fingerprints, cmax,fingertreat)]
dmso.data[, conc :=0]
dmso.data[, dose_uM :=0]
keepComps <- annotationData$treatment[ annotationData$Bob_anot !="general_cytotox_reactive" & annotationData$DILIConcern != "N/A" & annotationData$EndDissolvedQuality != "no"]

dose.response.modeling.data <- dose.response.modeling.data[ treatment %in% keepComps]


all.fingertreats <- unique(dose.response.modeling.data[, fingertreat])
conrespmodellist <- list()

pdf("../generated/results/concentration-response modeling/all_fits.pdf", height =6, width = 6)
for(i in seq_along(all.fingertreats)) { #seq_along(all.fingertreats)

  test <- dose.response.modeling.data[ fingertreat == all.fingertreats[i]]

#dmso.data$treatment <- test$treatment[1]
#dmso.data.loop <- dmso.data[ cell_line == test$cell_line[1],]
#test <- rbind(test,dmso.data.loop)
test <- test[order(test$conc),]


model.out = NULL
try(
model.out <- drm(abs(V1) ~ conc, data = test, fct = LL.4() ) 

)
try(
plot(model.out, broken = TRUE, type = "all", ylim = c(0,1), main = all.fingertreats[i] )

)
modelpred= NULL
try(
modelpred <- predict(model.out)
)
# additional effect BMDs
ED_est = NULL
try(
ED_est <- ED( model.out, respLev = modelpred[1] + 0.25, interval = "delta", type = "absolute")
)

output = NULL
if(!is.null(ED_est)){
output <- data.frame(ED_est = unlist(ED_est), treatment = test$treatment[1], fingerprint = test$fingerprints[1])
}

conrespmodellist[[i]] <- output

}
dev.off()


conresp_result <- do.call('rbind' , conrespmodellist)
pp <- melt(conresp_result)
head(pp)

wp <- dcast(data = pp, treatment ~ fingerprint + variable   )
head(wp)
write.table( wp, file ="../generated/results/BMD_table.txt", sep ="\t", col.names=NA)


# plot BMC vs 1cmax concentration + color-annotate DILI class
tail(pp)
BMC_data <- pp[pp$variable == "ED_est.Estimate",]
#dim(na.omit(BMC_data))
BMC_data <- as.data.table(BMC_data)

length(unique(na.omit(BMC_data)[, treatment]))

BMC_data <- na.omit(BMC_data)
BMC_data <- merge(BMC_data, annotationData, by = "treatment", all.x = TRUE, all.y = FALSE)

head(BMC_data)
BMC_data <- as.data.table(BMC_data)

setnames(BMC_data, old = "value", new = "BMC")
BMC_data[ , cmax := as.numeric(cmax)]


BMC_data[, DILIConcern := factor(DILIConcern, levels = c("Most-DILI-Concern", "Less-DILI-Concern",
                                 "Ambiguous DILI-concern", "No-DILI-Concern"))]

BMC_data[ is.infinite(BMC), BMC := NA]

summary(BMC_data$BMC)


# removal outliers
BMC_data[, iqr_BMC := IQR(BMC, na.rm = TRUE)]
BMC_data <- BMC_data[abs(BMC) < (abs(BMC) + 3* iqr_BMC), ]

BMC_data <- BMC_data[ BMC > 1*cmax ]
BMC_data <- BMC_data[ BMC < 2*100*cmax ]
BMC_data[ DILIConcern == "Most-DILI-Concern" , diliClass := "severe"]
BMC_data[ DILIConcern != "Most-DILI-Concern" , diliClass := "nonSevere"]
BMC_data[, diliClass := factor(diliClass, levels = c("severe", "nonSevere"))]
BMC_data[, fingerprint := factor(fingerprint, levels = 
                                   c("GFP_pos.2m_Srxn1", "GFP_pos.2m_Chop",
                                     "GFP_pos.2m_p21","GFP_dif.m2_Icam1"))]

BMC_data[ , cmaxnorn_BMC := log(BMC/cmax)]


# save bmc data for machine learning (previously in code)
save(file = '../generated/results/concentration-response modeling/BMC_data.Rdata', BMC_data)

#BMC_data <- BMC_data[ , min(BMC), by = list(treatment, DILIConcern, cmax)]
#setnames(BMC_data, old = "V1", new = "BMC")
pdf( file = "../generated/results/concentration-response modeling/cmax_vs_BMC.pdf", height = 5, width = 6)
ggplot(data = BMC_data, aes( x = log(cmax) ,y = log(BMC))) + geom_point(aes(color = diliClass)) +
   theme_minimal() + facet_wrap(~fingerprint) +
  geom_smooth(aes(group = diliClass, color = diliClass), se = FALSE, method = "lm", linetype = "dashed")
# theme_sharp()  +# coord_cartesian(ylim=c(0,100)) + 
dev.off()





summary(BMC_data$cmaxnorn_BMC)
colScale <- scale_fill_manual(name = "DILIConcern",values = myColors$DILIConcern)

pdf(file ="../generated/results/concentration-response modeling/BMC_normalized_.pdf", height = 8, width = 6)
ggplot(data = BMC_data, aes(x = fingerprint, y = cmaxnorn_BMC, color = diliClass, group = interaction(diliClass, fingerprint))) + geom_boxplot(aes( color = diliClass), lwd = 2) +# +
   theme_minimal() + theme( axis.text.x = element_text(angle = 45, vjust =1.4, size = 14 , 
                                    colour = "grey20") )  + 
  colScale + ylab(expression(log(BMC/cmax))) + xlab("reporter")
dev.off()

# significance of BMC difference
unique(BMC_data$fingerprint)
chop <- BMC_data[ fingerprint == "GFP_pos.2m_Chop",]

lm0 <- lm(log(BMC) ~ log(cmax), data = chop)
lm1 <- lm(log(BMC) ~ log(cmax) + diliClass, data = chop)
anova(lm0, lm1)
# Analysis of Variance Table

# Model 1: log(BMC) ~ log(cmax)
# Model 2: log(BMC) ~ log(cmax) + diliClass
#   Res.Df    RSS Df Sum of Sq      F   Pr(>F)   
# 1     28 29.097                                
# 2     27 20.648  1    8.4491 11.049 0.002561 **
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1


srxn1 <- BMC_data[ fingerprint == "GFP_pos.2m_Srxn1",]

lm0 <- lm(log(BMC) ~ log(cmax), data = srxn1)
lm1 <- lm(log(BMC) ~ log(cmax) + diliClass, data = srxn1)
anova(lm0, lm1)
# Analysis of Variance Table
# 
# Model 1: log(BMC) ~ log(cmax)
# Model 2: log(BMC) ~ log(cmax) + diliClass
#   Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1     55 32.804                              
# 2     54 29.323  1    3.4806 6.4097 0.01429 *
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
icam1 <- BMC_data[ fingerprint == "GFP_dif.m2_Icam1",]

lm0 <- lm(log(BMC) ~ log(cmax), data = icam1)
lm1 <- lm(log(BMC) ~ log(cmax) + diliClass, data = icam1)
anova(lm0, lm1)
# Analysis of Variance Table
# 
# Model 1: log(BMC) ~ log(cmax)
# Model 2: log(BMC) ~ log(cmax) + diliClass
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1     41 54.467                           
# 2     40 51.757  1    2.7098 2.0943 0.1556

p21 <- BMC_data[ fingerprint == "GFP_pos.2m_p21",]

lm0 <- lm(log(BMC) ~ log(cmax), data = p21)
lm1 <- lm(log(BMC) ~ log(cmax) + diliClass, data = p21)
anova(lm0, lm1)
# Analysis of Variance Table
# 
# Model 1: log(BMC) ~ log(cmax)
# Model 2: log(BMC) ~ log(cmax) + diliClass
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1     18 6.5647                           
# 2     17 6.5586  1 0.0061102 0.0158 0.9013



# statistics of cmax normalized BMC's per diliClass - reporter  group


t.test( srxn1$cmaxnorn_BMC[ srxn1$diliClass == "nonSevere"],
        srxn1$cmaxnorn_BMC[ srxn1$diliClass == "severe"])

t.test( icam1$cmaxnorn_BMC[ icam1$diliClass == "nonSevere"],
        icam1$cmaxnorn_BMC[ icam1$diliClass == "severe"])

t.test( p21$cmaxnorn_BMC[ p21$diliClass == "nonSevere"],
        p21$cmaxnorn_BMC[ p21$diliClass == "severe"])


t.test( chop$cmaxnorn_BMC[ chop$diliClass == "nonSevere"],
        chop$cmaxnorn_BMC[ chop$diliClass == "severe"])



```


model time courses data in hm
use same data-format as from time courses figures
```{r }

load('../tmp/model.results.GFP_data.df.Rdata')


# cmax for dmso should be empty
model.results.GFP_data.df[ treatment == "dmso", cmax := ""]
model.results.GFP_data.df.m <- model.results.GFP_data.df[ , mean(mod), by = list(treatment, cmax, timeAfterExposure, fingerprints)]
setnames( model.results.GFP_data.df.m, old = "V1", new = "meanR" )

model.results.GFP_data.df.m[,  treat.dose  := paste(treatment, cmax, sep = "_") ]

all.fingerprints <- unique(model.results.GFP_data.df.m[, fingerprints])
dist.treat.dose = list()

norm.data = list()

for(i in  seq_along(all.fingerprints)) {

  buffer.cells <- model.results.GFP_data.df.m[ fingerprints %in% all.fingerprints[i]]
  time.vectors.perCell <-  dcast(data = buffer.cells, treat.dose~timeAfterExposure, value.var = "meanR" )
  
  rownames(time.vectors.perCell)<- time.vectors.perCell$treat.dose
  time.vectors.perCell$treat.dose <- NULL
 
  time.vectors.perCell<- as.matrix(time.vectors.perCell)
  
  dist.treat.dose[[i]] <- dist(time.vectors.perCell, method = "manhattan", diag=TRUE)
  
  
  norm.data[[i]] <- melt(time.vectors.perCell)
  norm.data[[i]]$fingerprints <- all.fingerprints[i]
  colnames(norm.data[[i]]) <- c("treat.dose", "timeAfterExposure", "meanR", "fingerprint")
}


all.norm.data <- do.call("rbind", norm.data)
class(all.norm.data)
head(all.norm.data)

dist.treat.dose <- lapply(dist.treat.dose, function(x) x<- as.matrix(x))
length(dist.treat.dose)
dim(dist.treat.dose[[1]])

my.array<- array(unlist(dist.treat.dose), c(591,591,4))

lapply(dist.treat.dose,  dim)
4*591*591-length(unlist(dist.treat.dose))  

dist.treat.dose.df <- apply(my.array, 1:2, mean)
rownames(dist.treat.dose.df) <- rownames(dist.treat.dose[[1]])
colnames(dist.treat.dose.df) <- colnames(dist.treat.dose[[1]])
dist.treat.dose.df.d <- as.dist(dist.treat.dose.df)
treat.dose.clust<-hclust(dist.treat.dose.df.d, method = "ward.D")
names(treat.dose.clust)
treat.dose.clust$labels
treat.dose.clust$order
results.treat.dose.order <- treat.dose.clust$labels[treat.dose.clust$order]
dir.create("../generated/results/time_hm")
pdf("../generated/results/time_hm/cluster comp.dose.pdf", height= 10, width = 130)
plot(treat.dose.clust)
dev.off()



# same thing for the compounds
comp.doses<- unique(model.results.GFP_data.df.m$treat.dose)


head(all.norm.data)
dist.cells = list()
for(i in  seq_along(comp.doses)) {
  
  buffer.comp.dose <- all.norm.data[ all.norm.data$treat.dose %in% comp.doses[i],]
  time.vectors.perCompound <-  dcast(data = buffer.comp.dose, fingerprint~timeAfterExposure, value.var = "meanR" )
  rownames(time.vectors.perCompound)<- time.vectors.perCompound$fingerprint
  time.vectors.perCompound$fingerprint <- NULL
  
  dist.cells[[i]] <- dist(time.vectors.perCompound, method = "manhattan",  diag=TRUE)
  
}

dist.cells <- lapply(dist.cells, function(x) x<- as.matrix(x))

length(dist.cells)
dim(dist.cells[[1]])
my.array<- array(unlist(dist.cells), c(4,4,591))
dist.cells[[1]]

dist.cells.df <- apply(my.array, 1:2, mean)
rownames(dist.cells.df) <- rownames(dist.cells[[1]])
colnames(dist.cells.df) <- colnames(dist.cells[[1]])
dist.cells.df.d <- as.dist(dist.cells.df)

cells.clust<-hclust(dist.cells.df.d, method = "ward.D")
names(cells.clust)
cells.clust$labels
cells.clust$order
results.cell.order <- cells.clust$labels[cells.clust$order]
results.cell.order
plot(cells.clust)

# 
# 
# aheatmap(as.matrix((my.data.w.all)), Rowv = NULL, Colv=NULL, 
#           annRow = treatmentAnot, annCol = reporterAnot,  color = my.colors,
#          annColors = myColors,  fontsize = 10, width = 10, height=10, legend = FALSE
#          
#   )


results.treat.dose.order
results.cell.order

min(all.norm.data$meanR)
max(all.norm.data$meanR)
mean(all.norm.data$meanR)
my.colors

display.brewer.all()
colorRampPalette(brewer.pal(9, "Set1"))
my.colors <- c(rev(brewer.pal(9, "YlGnBu")) , brewer.pal(9, "YlOrRd"))


my.colors <- colorRampPalette(my.colors)(50)

colBreaks <-c(seq(-1.2, 0.15,length.out=28), seq(0.155,1, length.out = 22))


# treatment annotation needed with treat.dose
#annotationData <- read.delim(file = '../metadata/DILI_annotation_dissolved_07_02_2017.txt', sep = "\t", header = T )


annotationData <- annotationData[, list(treatment, DILIConcern, SeverityLabel)]
annotationData[ , diliClass := ifelse(DILIConcern == "Most-DILI-Concern", "severe", "nonSevere")]

treatmentAnot <- annotationData
treat.treat.dose <- model.results.GFP_data.df.m[, list(treatment, treat.dose)]


treat.treat.dose<- unique(treat.treat.dose)
setkey(treat.treat.dose, "treatment")
treatmentAnot<- as.data.table(treatmentAnot)
setkey(treatmentAnot, "treatment")
treatmentAnot.treat.dose <- treatmentAnot[treat.treat.dose]

treatmentAnot.treat.dose[ grepl("_1cmax", treat.dose), cmax := "1cmax"]
treatmentAnot.treat.dose[ grepl("_5cmax", treat.dose), cmax := "5cmax"]
treatmentAnot.treat.dose[ grepl("_10cmax", treat.dose), cmax := "10cmax"]
treatmentAnot.treat.dose[ grepl("_50cmax", treat.dose), cmax := "50cmax"]
treatmentAnot.treat.dose[ grepl("_100cmax", treat.dose), cmax := "100cmax"]

Anot.treat.dose <- treatmentAnot.treat.dose[, list(diliClass, SeverityLabel, cmax)]
names(myColors$cmax) <- factor(c("1cmax", "5cmax","10cmax", "50cmax", "100cmax"), levels =
                                   c("1cmax", "5cmax","10cmax", "50cmax", "100cmax"))

for( i in seq_along(all.fingerprints)){
  
  data.cell <- all.norm.data[ all.norm.data$fingerprint %in% all.fingerprints[i], ]
  my.data.w <-  dcast(data = data.cell, treat.dose~timeAfterExposure, value.var = "meanR" )
  
  rownames(my.data.w) <- my.data.w$treat.dose
  my.data.w$treat.dose<- NULL
  ind <- match(results.treat.dose.order, rownames(my.data.w))
  my.data.w<- my.data.w[ind, ]
  if(
    !all(rownames(my.data.w)==results.treat.dose.order)
  ){
    stop()
  }
  
  ind2 <- match( rownames(my.data.w),treatmentAnot.treat.dose$treat.dose)
  
  treatmentAnot.treat.dose <- treatmentAnot.treat.dose[ind2,]
  Anot.treat.dose <- treatmentAnot.treat.dose[, list( diliClass, SeverityLabel, cmax)]
  pdf(file = paste('../generated/results/time_hm/', all.fingerprints[i], ".pdf", sep =""), width = 6, height = 16)
  
  
  aheatmap(as.matrix((my.data.w)), Rowv = NA, Colv=NA, 
           annRow = Anot.treat.dose,  breaks = colBreaks, color = my.colors,
           annColors = myColors,  fontsize = 10, legend = TRUE
  )
  
  dev.off()
}



```


sensitivity panel
```{r sensitivity_panel}

unique(all.data.norm$treatment)
unique(all.data.norm$fingerprints)


ggplot( data = all.data.norm[ treatment == 'clozapine' & cell_line == "p21"], aes( x = timeAfterExposure, y = value, color = cmax)) + geom_point(aes(shape = plateID, color = cmax)) + facet_wrap(~fingerprints, scales = 'free') 


sel.sens.srxn1 <- all.data.norm[ 
  treatment %in% c("dmso" ,"dem", "chlorpromazine") & cmax %in% c("0cmax","100cmax") & fingerprints %in% 
    c( "GFP_pos.2m_Srxn1",   "GFP_pos.3m_Srxn1", "GFP_pos.m3sd_Srxn1", 
       "mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1"
       )
     ]
table(sel.sens.srxn1$treatment)

sel.sens.ddits  <- all.data.norm[
  treatment %in% c( "dmso", "thapsigargin","nitrofurantoin" ) & cmax %in% c("0cmax","100cmax")  & fingerprints %in%
    c("GFP_pos.2m_DDIT3", "GFP_pos.3m_DDIT3","GFP_pos.m3sd_DDIT3",  
      "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3") ]

sel.sens.p21 <- all.data.norm[
  treatment %in% c("dmso", "etoposide " ,"clozapine") & cmax %in% c("0cmax","10cmax") & fingerprints %in%
    c("GFP_pos.2m_p21","GFP_pos.3m_p21","GFP_pos.m3sd_p21",
      "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_p21")]

sel.sens.icam1 <- all.data.norm[
  treatment %in% c("dmso", "azathioprine","diclofenac") & cmax %in% c("0cmax","100cmax") & fingerprints %in%
    c("GFP_dif.m1_ICAM1","GFP_dif.m2_ICAM1","GFP_dif.m3_ICAM1",
      "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1"
      )]

sel.sens<- rbind(sel.sens.srxn1, sel.sens.ddits, sel.sens.p21, sel.sens.icam1)

sel.sens[ fingerprints == "mmnDMSO.sub_Cytoplasm_Intensity_IntegratedIntensity_Image_GFP_Srxn1", fingerprints := "Int_Srxn1" ]
sel.sens[ fingerprints == "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_DDIT3", fingerprints := "Int_Chop" ]
sel.sens[ fingerprints == "mmnDMSO.sub_Nuclei_Intensity_MeanIntensity_Image_GFP_p21", fingerprints := "Int_p21" ]
sel.sens[ fingerprints == "mmnDMSO.sub_obj_cyto_only_Intensity_IntegratedIntensity_image_GFP_ICAM1", fingerprints := "Int_Icam1" ]
sel.sens[ ,fingerprints := gsub("DDIT3", "Chop", fingerprints)]
sel.sens[ ,fingerprints := gsub("ICAM1", "Icam1", fingerprints)]

sel.sens[ ,cell_line := gsub("ICAM1", "Icam1", cell_line)]
sel.sens[ ,cell_line := gsub("DDIT3", "Chop", cell_line)]


sel.sens[ , treatment := paste(treatment, cell_line, sep = " - ")]
sel.sens[ , fingerprints := gsub("_Icam1", "", fingerprints)]
sel.sens[ , fingerprints := gsub("_Chop", "", fingerprints)]
sel.sens[ , fingerprints := gsub("_p21", "", fingerprints)]
sel.sens[ , fingerprints := gsub("_Srxn1", "", fingerprints)]
sel.sens[ , fingerprints := gsub("Int", "Intensity", fingerprints)]

sel.sens[ , fingerprints := gsub("_dif", "", fingerprints)]
sel.sens[ , fingerprints := gsub("pos", "", fingerprints)]
sel.sens[ , fingerprints := gsub("2m", "m1", fingerprints)]
sel.sens[ , fingerprints := gsub("3m", "m2", fingerprints)]
sel.sens[ , fingerprints := gsub("m3sd", "m3", fingerprints)]
sel.sens[ , fingerprints := gsub("_", "", fingerprints)]


unique(sel.sens[, treatment])

sel.sens[ , treatment := factor(treatment, levels = 
                                  c("dmso - Srxn1", "chlorpromazine - Srxn1", 
                                    "dem - Srxn1", "dmso - Chop",
                                   "nitrofurantoin - Chop", "thapsigargin - Chop",
                                   "dmso - p21", "clozapine - p21",
                                   "etoposide  - p21",
                                   "dmso - Icam1", "diclofenac - Icam1",
                                   "azathioprine - Icam1"))  ]

pdf( file = '../generated/results/sensitivity_panel_graph.pdf', height = 24, width = 5)
p<- ggplot(data=sel.sens, aes(x = timeAfterExposure, y = value)) + facet_wrap(  ~treatment, ncol=1 ) +
  #geom_point( aes(color=fingerprints), shape = 'x', size = 0.5)  + 
  geom_smooth(aes(group = fingerprints, color = fingerprints), lwd = 1.2) +
  
  theme_minimal() +
  theme( axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.4, size = 12 , 
                                    colour = "grey50") ) + theme( strip.text.x = element_text( )) +
  theme(plot.title = element_text(lineheight=.8, size = 8 )) + theme(legend.text=element_text(size=8))

p <- p + coord_cartesian( ylim =c(-1,1), xlim = c(0, 20))
print(p)
dev.off()




``` 



TG GATES/ TGP:  spearman (monotonic) and pearson (linear) correlation between mRNA in PHH and protein level in HepG2  
```{r tggates}
# TGP PHH figure

TGP_d <- read.table(file = '../data/DILI paper 3 genes.txt', sep ='\t', header =T)
#select 24 hours high
TGP_d<-as.data.table(TGP_d)
TGP_d <- TGP_d[dose%in%"High" & time=="24hr"]
TGP_d[, symbols:=factor(symbols, levels= c("SRXN1","DDIT3","CDKN1A"), ordered=TRUE) ]
TGP_d <- TGP_d[, list(treatment, symbols, logFC)]

# mean time course data from fit. select 24 hour or if lower end-time point for mmn dmso sub int data; 
model.results.GFP_data.df.m


PoDmax <- PoD[, max(value), by = list(treatment, fingerprints, DILI_Type)]
setnames(PoDmax, "V1","GFP.2m")
PoDmax[, symbols:=fingerprints]
PoDmax[, fingerprints:=NULL]
PoDmax[, symbols:=gsub("GFP_pos.2m_DDIT3", "DDIT3", symbols)]
PoDmax[, symbols:=gsub("GFP_pos.2m_Srxn1", "SRXN1", symbols)]
PoDmax[, symbols:=gsub("GFP_pos.2m_p21", "CDKN1A", symbols)]

# manually change names to imaging convention
indConv <- unique(PoDmax$treatment) %in% unique(TGP_d$treatment)
unique(PoDmax$treatment)[!indConv]

unique(TGP_d$treatment) # veranderen

TGP_d$treatment <- gsub("WY-14643", "WY14643",TGP_d$treatment)
TGP_d$treatment <- gsub("buthionine sulfoximine", "buthionine sulfoxamine",TGP_d$treatment)
TGP_d$treatment <- gsub("cyclosporine A", "cyclosporin A",TGP_d$treatment)
TGP_d$treatment <- gsub("erythromycin ethylsuccinate", "erythromycin",TGP_d$treatment)
TGP_d$treatment <- gsub("diethyl maleate", "DEM",TGP_d$treatment)

setkeyv(PoDmax, c("treatment" , "symbols" ))
setkeyv(TGP_d, c("treatment", "symbols"))
TGPImage<- PoDmax[ TGP_d ]
TGPImage<- TGPImage[!is.na(treatment)]
TGPImage<- TGPImage[ !is.na(DILI_Type)]


``` 



extra figuur voor poster/ presentatie
gebaseerd op hm_data_data
```{r extra_fig}

head(hm_data_data)
treatmentAnot
tempFigure <- as.data.frame(hm_data_data)
tempFigure$treatment <- rownames(hm_data_data)
tempFigure$DILIConcern <- treatmentAnot$DILIConcern
head(treatmentAnot)
head(tempFigure)
?melt

tempFigure_l <- melt(tempFigure, id.vars = c("treatment", "DILIConcern"))

head(tempFigure_l)

ind <- grepl("_100cmax", tempFigure_l$variable)
ind2 <- grepl("_50cmax", tempFigure_l$variable)
tempFigure_l <- tempFigure_l[ind | ind2, ]

tempFigure_l$DILIConcern <- factor(tempFigure_l$DILIConcern, levels = c("Most-DILI-Concern", "Less-DILI-Concern", "No-DILI-Concern"))

ggplot(tempFigure_l, aes( x = treatment, y = value, color = DILIConcern )) + geom_point(size = 4) + 
    theme_minimal() +
   theme( axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.4, size = 5 , 
                                    colour = "grey50") ) + facet_wrap(~variable, ncol=2)  +
  scale_colour_manual(values = c("red", "orange", "green")) 

head(tempFigure_l)
```



